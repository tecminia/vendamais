<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuração Segura - Admin Venda+</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .step { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button { background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #6c757d; }
        #log { font-family: monospace; background: #1e1e1e; color: #fff; padding: 15px; border-radius: 5px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Configuração Segura do Sistema</h1>
    
    <div class="step" id="step1">
        <h3>1. Criar Admin no Authentication</h3>
        <p>Criando usuário <strong>admin@vendaplus.com</strong> com role administrativa...</p>
    </div>
    
    <div class="step" id="step2">
        <h3>2. Configurar Token de Admin Customizado</h3>
        <p>Atribuindo claim administrativa ao usuário...</p>
    </div>
    
    <div class="step" id="step3">
        <h3>3. Criar Documento de Controle Admin</h3>
        <p>Criando registro no Firestore para controle de administradores...</p>
    </div>
    
    <button onclick="startSetup()" id="btnSetup">Iniciar Configuração</button>
    
    <h3>Log de Execução:</h3>
    <div id="log"></div>

    <script>
        // SUA CONFIG DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyB7U-JfKAlkPxSyL4AEf5u0BgcDzSXf41M",
            authDomain: "appvendas-1eebf.firebaseapp.com",
            projectId: "appvendas-1eebf",
            storageBucket: "appvendas-1eebf.firebasestorage.app",
            messagingSenderId: "229472373918",
            appId: "1:229472373918:web:39cd4940b052b2375f3f8f"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            entry.style.color = type === 'error' ? '#ff6b6b' : 
                                type === 'success' ? '#51cf66' : '#339af0';
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function startSetup() {
            const btn = document.getElementById('btnSetup');
            btn.disabled = true;
            btn.textContent = 'Configurando...';

            try {
                // 1. CRIAR USUÁRIO ADMIN NO AUTH
                log('Criando usuário admin no Firebase Authentication...');
                document.getElementById('step1').classList.add('success');
                
                let user;
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        'admin@vendaplus.com', 
                        'admin123'
                    );
                    user = userCredential.user;
                    log('✓ Usuário admin criado no Authentication', 'success');
                } catch (authError) {
                    if (authError.code === 'auth/email-already-in-use') {
                        // Fazer login se já existir
                        await auth.signInWithEmailAndPassword('admin@vendaplus.com', 'admin123');
                        user = auth.currentUser;
                        log('✓ Usuário admin já existe. Login realizado.', 'success');
                    } else {
                        throw authError;
                    }
                }

                // 2. IMPORTANTE: Em produção, você configuraria aqui um Cloud Function
                // para adicionar a custom claim 'admin' = true ao usuário
                // Como estamos no frontend, vamos criar um documento de controle:
                log('NOTA: Em produção, configure uma Cloud Function para adicionar custom claims', 'info');
                log('Para este exemplo, criaremos um documento de controle no Firestore', 'info');
                document.getElementById('step2').classList.add('success');

                // 3. CRIAR DOCUMENTO DE CONTROLE ADMIN
                const adminControl = {
                    uid: user.uid,
                    email: 'admin@vendaplus.com',
                    role: 'super_admin',
                    permissions: ['all'],
                    createdAt: new Date().toISOString(),
                    // Este campo é usado nas regras de segurança
                    isFirebaseAdmin: true
                };

                await db.collection('_adminControl').doc(user.uid).set(adminControl);
                document.getElementById('step3').classList.add('success');
                log('✓ Documento de controle administrativo criado', 'success');

                // 4. CRIAR CONFIGURAÇÕES DO SISTEMA
                await db.collection('systemConfig').doc('paymentSettings').set({
                    pixKey: 'seu-pix@email.com',
                    adminWhatsApp: '(11) 99999-9999',
                    monthlyPlanPrice: 99.00,
                    createdAt: new Date().toISOString()
                });
                log('✓ Configurações do sistema criadas', 'success');

                log('✅ CONFIGURAÇÃO COMPLETA! Agora aplique as regras de segurança abaixo:', 'success');
                log('Vá para Firebase Console → Firestore → Regras', 'info');
                log('Cole as regras do próximo passo e clique em Publicar', 'info');

            } catch (error) {
                log(`Erro: ${error.message}`, 'error');
                document.querySelectorAll('.step').forEach(s => s.classList.add('error'));
            } finally {
                btn.disabled = false;
                btn.textContent = 'Configuração Concluída';
            }
        }
    </script>
</body>
</html>