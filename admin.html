<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Venda+ | Painel Adm.</title>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.3/imask.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        /* Desabilitar seleção de texto em áreas não editáveis */
        .app-header, .user-card, .stat-card, .order-card, .product-card, 
        .link-container, .bottom-nav, .modal-header, .section-title,
        .welcome-content, .block-content, .upload-area, .status-filter-btn,
        .finance-tab, .theme-option, .empty-state, .notification,
        .monthly-summary, .month-header, .daily-order {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* Permitir seleção apenas em campos de entrada */
        .form-input, textarea, input[type="text"], input[type="number"], 
        input[type="email"], input[type="tel"], select {
            user-select: auto;
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            overflow-x: hidden;
            background-color: #ffffff;
            transition: background-color 0.3s ease;
        }
        
        body {
            color: #212121;
            font-size: 14px;
            padding-bottom: 70px;
            transition: all 0.3s ease;
        }
        
        /* App Container */
        .app-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
        }
        
        /* App Header */
        .app-header {
            background-color: #212121;
            color: #ffffff;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }
        
        .app-header .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .app-header .logo-icon {
            font-size: 1.8rem;
            color: #212121;
            background-color: #ffffff;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .app-header .logo-text h1 {
            font-size: 1.2rem;
            font-weight: 700;
            line-height: 1.2;
            transition: color 0.3s ease;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #212121;
            border: 2px solid #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .logout-btn {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 1.2rem;
            padding: 5px;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        /* Welcome Modal - Nova versão mais didática */
        .welcome-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #212121 0%, #424242 100%);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .welcome-content {
            background-color: #ffffff;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            border: 1px solid #e0e0e0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: modalFadeIn 0.5s ease;
        }
        
        .welcome-icon {
            font-size: 3.5rem;
            color: #212121;
            margin-bottom: 20px;
        }
        
        .welcome-title {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: #212121;
            font-weight: 700;
        }
        
        .welcome-message {
            color: #757575;
            margin-bottom: 30px;
            line-height: 1.6;
            text-align: left;
        }
        
        .welcome-steps {
            background-color: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #212121;
        }
        
        .welcome-step {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .welcome-step:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #212121;
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .step-text {
            text-align: left;
            flex: 1;
        }
        
        .step-text h4 {
            color: #212121;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .step-text p {
            color: #757575;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        /* Expiry Warning Modal */
        .expiry-warning {
            background-color: #fff3cd;
            border: 1px solid #ff9800;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
            position: relative;
        }
        
        .expiry-warning-icon {
            font-size: 2rem;
            color: #ff9800;
            margin-bottom: 10px;
            text-align: center;
        }
        
        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #212121;
            color: #ffffff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        /* Main Content */
        .main-content {
            padding: 15px;
            min-height: calc(100vh - 140px);
        }
        
        /* Section Title */
        .section-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #212121;
            border-bottom: 2px solid #212121;
            padding-bottom: 5px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        /* User Info Card */
        .user-card {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        
        .user-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .user-card-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #212121;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-size: 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }
        
        .user-card-info h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: #212121;
            transition: color 0.3s ease;
        }
        
        .user-card-info p {
            color: #757575;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }
        
        /* Link Section */
        .link-section {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        
        .link-title {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #212121;
            transition: color 0.3s ease;
        }
        
        .link-description {
            color: #757575;
            font-size: 0.9rem;
            margin-bottom: 15px;
            line-height: 1.5;
            transition: color 0.3s ease;
        }
        
        .link-container {
            background-color: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            word-break: break-all;
            border: 1px dashed #212121;
            transition: all 0.3s ease;
        }
        
        .link-container strong {
            color: #212121;
            font-size: 0.95rem;
            transition: color 0.3s ease;
        }
        
        .link-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .stat-icon.pending {
            background-color: rgba(255, 152, 0, 0.1);
            color: #ff9800;
        }
        
        .stat-icon.confirmed {
            background-color: rgba(76, 175, 80, 0.1);
            color: #4caf50;
        }
        
        .stat-icon.delivering {
            background-color: rgba(33, 150, 243, 0.1);
            color: #2196f3;
        }
        
        .stat-icon.delivered {
            background-color: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }
        
        .stat-icon.total {
            background-color: rgba(33, 150, 243, 0.1);
            color: #2196f3;
        }
        
        .stat-icon.revenue {
            background-color: rgba(33, 33, 33, 0.1);
            color: #212121;
        }
        
        .stat-icon.delivery {
            background-color: rgba(156, 39, 176, 0.1);
            color: #9c27b0;
        }
        
        .stat-icon.visits {
            background-color: rgba(103, 58, 183, 0.1);
            color: #673ab7;
        }
        
        .stat-info h3 {
            font-size: 0.8rem;
            color: #757575;
            margin-bottom: 3px;
            transition: color 0.3s ease;
        }
        
        .stat-number {
            font-size: 1.3rem;
            font-weight: 700;
            color: #212121;
            transition: color 0.3s ease;
        }
        
        /* Orders List */
        .orders-list {
            margin-top: 15px;
        }
        
        .order-card {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .order-id {
            font-size: 0.85rem;
            color: #757575;
            transition: color 0.3s ease;
        }
        
        .order-date {
            font-size: 0.8rem;
            color: #757575;
            transition: color 0.3s ease;
        }
        
        .order-customer {
            font-weight: 600;
            margin-bottom: 5px;
            color: #212121;
            transition: color 0.3s ease;
        }
        
        .order-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        
        .order-total {
            font-size: 1.1rem;
            font-weight: 700;
            color: #212121;
            transition: color 0.3s ease;
        }
        
        .order-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-preparing {
            background-color: rgba(255, 152, 0, 0.1);
            color: #ff9800;
        }
        
        .status-confirmed {
            background-color: rgba(33, 150, 243, 0.1);
            color: #2196f3;
        }
        
        .status-delivering {
            background-color: rgba(33, 150, 243, 0.2);
            color: #2196f3;
        }
        
        .status-delivered {
            background-color: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }
        
        .status-rejected {
            background-color: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }
        
        .order-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        /* Products List */
        .products-list {
            margin-top: 15px;
        }
        
        .product-card {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        
        .product-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }
        
        .product-info {
            flex: 1;
        }
        
        .product-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #212121;
            transition: color 0.3s ease;
        }
        
        .product-price {
            color: #212121;
            font-weight: 700;
            font-size: 1.1rem;
            transition: color 0.3s ease;
        }
        
        .product-actions {
            display: flex;
            gap: 8px;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 16px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 0.8rem;
        }
        
        .btn-primary {
            background-color: #212121;
            color: #ffffff;
        }
        
        .btn-primary:active {
            background-color: #000000;
        }
        
        .btn-secondary {
            background-color: #e0e0e0;
            color: #212121;
        }
        
        .btn-secondary:active {
            background-color: #e0e0e0;
            opacity: 0.9;
        }
        
        .btn-success {
            background-color: #4caf50;
            color: white;
        }
        
        .btn-success:active {
            background-color: #3d8b40;
        }
        
        .btn-whatsapp {
            background-color: #25D366;
            color: white;
        }
        
        .btn-whatsapp:active {
            background-color: #128C7E;
        }
        
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        
        .btn-danger:active {
            background-color: #d32f2f;
        }
        
        .btn-block {
            width: 100%;
            margin-top: 15px;
        }
        
        /* Action Buttons */
        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .view-btn {
            background-color: rgba(33, 150, 243, 0.1);
            color: #2196f3;
        }
        
        .confirm-btn {
            background-color: rgba(76, 175, 80, 0.1);
            color: #4caf50;
        }
        
        .reject-btn {
            background-color: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffffff;
            border-top: 1px solid #e0e0e0;
            padding: 10px 0;
            display: flex;
            justify-content: space-around;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            color: #757575;
            font-size: 0.8rem;
            padding: 8px;
            flex: 1;
            cursor: pointer;
            transition: color 0.3s ease;
            position: relative;
        }
        
        .nav-btn i {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }
        
        .nav-btn.active {
            color: #212121;
        }
        
        /* Modal - MODIFICAÇÃO AQUI: Removido slideUp e adicionado centralizado */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background-color: #ffffff;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease;
            border: 1px solid #e0e0e0;
            transition: background-color 0.3s ease;
            position: relative;
        }
        
        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background-color: #ffffff;
            z-index: 10;
            transition: all 0.3s ease;
        }
        
        .modal-title {
            font-size: 1.3rem;
            color: #212121;
            font-weight: 600;
            transition: color 0.3s ease;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #757575;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s ease;
        }
        
        .modal-body {
            padding: 15px;
        }
        
        /* Image Zoom Modal */
        .image-zoom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .image-zoom-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }
        
        .image-zoom-content img {
            width: 100%;
            height: auto;
            max-height: 80vh;
            object-fit: contain;
            touch-action: pan-x pan-y;
        }
        
        .close-zoom {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }
        
        /* Chart Container */
        .chart-container {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
            position: relative;
        }
        
        .chart-title {
            font-size: 1rem;
            margin-bottom: 10px;
            color: #212121;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Finance History */
        .finance-tabs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 10px 0;
            margin-bottom: 15px;
        }
        
        .finance-tab {
            padding: 8px 12px;
            border-radius: 20px;
            border: 2px solid #e0e0e0;
            background-color: transparent;
            color: #757575;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.8rem;
            white-space: nowrap;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }
        
        .finance-tab.active {
            border-color: #212121;
            background-color: #212121;
            color: #ffffff;
        }
        
        .monthly-summary {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
        }
        
        .month-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .month-name {
            font-weight: 600;
            color: #212121;
            transition: color 0.3s ease;
        }
        
        .month-revenue {
            font-size: 1.1rem;
            font-weight: 700;
            color: #4caf50;
        }
        
        .daily-orders {
            margin-top: 10px;
        }
        
        .daily-order {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .daily-order:last-child {
            border-bottom: none;
        }
        
        .order-count {
            font-weight: 600;
            color: #212121;
        }
        
        .order-amount {
            color: #757575;
        }
        
        /* Loading Indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 15px;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #212121;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            color: white;
            font-weight: 600;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #212121;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
            background-color: #ffffff;
            color: #212121;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #212121;
        }
        
        /* Upload Area */
        .upload-area {
            border: 2px dashed #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 15px 0;
            cursor: pointer;
            transition: border-color 0.3s ease;
            position: relative;
        }
        
        .upload-area.uploading {
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .upload-area:active {
            border-color: #212121;
        }
        
        .upload-icon {
            font-size: 2rem;
            color: #757575;
            margin-bottom: 10px;
            transition: color 0.3s ease;
        }
        
        .upload-text {
            color: #757575;
            font-size: 0.9rem;
            margin-bottom: 5px;
            transition: color 0.3s ease;
        }
        
        .upload-info {
            font-size: 0.8rem;
            color: #757575;
            transition: color 0.3s ease;
            margin-top: 5px;
        }
        
        .file-types {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 5px;
            flex-wrap: wrap;
        }
        
        .file-type-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            background-color: #f5f5f5;
            color: #757575;
            border: 1px solid #e0e0e0;
        }
        
        .image-preview {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            object-fit: contain;
            margin-top: 10px;
            display: none;
            cursor: pointer;
            background-color: #f5f5f5;
            touch-action: pan-x pan-y;
        }
        
        /* PDF Preview Placeholder */
        .pdf-preview {
            display: none;
            width: 100%;
            height: 200px;
            border-radius: 10px;
            margin-top: 10px;
            background-color: #f5f5f5;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 20px;
            border: 2px dashed #e0e0e0;
            cursor: pointer;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #4caf50;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* Status Filter */
        .status-filter {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 10px 0;
            margin-bottom: 15px;
        }
        
        .status-filter-btn {
            padding: 8px 12px;
            border-radius: 20px;
            border: 2px solid #e0e0e0;
            background-color: transparent;
            color: #757575;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.8rem;
            white-space: nowrap;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }
        
        .status-filter-btn.active {
            border-color: #212121;
            background-color: #212121;
            color: #ffffff;
        }
        
        /* Theme Selector */
        .theme-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .theme-option {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .theme-option.active {
            border-color: #212121;
            background-color: rgba(33, 33, 33, 0.05);
        }
        
        .theme-preview {
            width: 100%;
            height: 60px;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #212121;
            font-weight: 600;
            background-size: cover;
            background-position: center;
        }
        
        .theme-name {
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            color: #212121;
            transition: color 0.3s ease;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #757575;
            transition: color 0.3s ease;
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #e0e0e0;
            transition: color 0.3s ease;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            animation: fadeIn 0.3s ease;
            font-weight: 600;
            color: white;
            text-align: center;
            backdrop-filter: blur(10px);
            background-color: rgba(0, 0, 0, 0.85);
            max-width: 300px;
            width: 90%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .notification.success {
            background-color: rgba(76, 175, 80, 0.95);
        }
        
        .notification.error {
            background-color: rgba(244, 67, 54, 0.95);
        }
        
        .notification.info {
            background-color: rgba(33, 150, 243, 0.95);
        }
        
        /* WhatsApp Notification Modal - Novo Design Minimalista */
        .whatsapp-notification-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .whatsapp-notification-content {
            background-color: #ffffff;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            border: 1px solid #e0e0e0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: modalFadeIn 0.3s ease;
        }
        
        .whatsapp-icon {
            font-size: 4rem;
            color: #25D366;
            margin-bottom: 20px;
        }
        
        .whatsapp-title {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #212121;
            font-weight: 600;
        }
        
        .whatsapp-message {
            color: #757575;
            margin-bottom: 25px;
            line-height: 1.5;
            text-align: left;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #25D366;
        }
        
        .whatsapp-instructions {
            background-color: #e8f5e9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
            text-align: left;
            border: 1px solid #c8e6c9;
        }
        
        .whatsapp-instructions ol {
            margin-left: 20px;
            margin-bottom: 0;
        }
        
        .whatsapp-instructions li {
            margin-bottom: 8px;
            color: #2e7d32;
        }
        
        .whatsapp-instructions li:last-child {
            margin-bottom: 0;
        }
        
        /* Block Modal */
        .block-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 5000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .block-content {
            background-color: #ffffff;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            border: 1px solid #e0e0e0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: modalFadeIn 0.3s ease;
        }
        
        .block-icon {
            font-size: 3.5rem;
            color: #f44336;
            margin-bottom: 20px;
        }
        
        .block-title {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #212121;
        }
        
        .block-message {
            color: #757575;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        /* Animations - MODIFICAÇÃO AQUI */
        @keyframes modalFadeIn {
            from { 
                opacity: 0; 
                transform: scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: scale(1); 
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            to { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Utilities */
        .d-none { display: none !important; }
        .d-flex { display: flex !important; }
        .d-block { display: block !important; }
        .flex-1 { flex: 1; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .gap-1 { gap: 8px; }
        .gap-2 { gap: 12px; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 12px; }
        .mb-3 { margin-bottom: 16px; }
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 12px; }
        .mt-3 { margin-top: 16px; }
        .text-center { text-align: center; }
        .text-gray { color: #757575; }
    </style>
</head>
<body>
    <!-- Welcome Modal - Nova versão mais didática -->
    <div class="welcome-modal" id="welcomeModal">
        <div class="welcome-content">
            <div class="welcome-icon">
                <i class="fas fa-store"></i>
            </div>
            <h2 class="welcome-title">Bem-vindo ao Venda+!</h2>
            <p class="welcome-message">
                Para começar a usar todas as funcionalidades do sistema, é importante configurar sua loja corretamente. 
                Vamos guiá-lo passo a passo:
            </p>
            
            <div class="welcome-steps">
                <div class="welcome-step">
                    <div class="step-icon">1</div>
                    <div class="step-text">
                        <h4>Nome do Negócio</h4>
                        <p>Defina o nome da sua empresa ou loja que aparecerá para seus clientes.</p>
                    </div>
                </div>
                
                <div class="welcome-step">
                    <div class="step-icon">2</div>
                    <div class="step-text">
                        <h4>Contato WhatsApp</h4>
                        <p>Informe seu número do WhatsApp para que os clientes possam entrar em contato.</p>
                    </div>
                </div>
                
                <div class="welcome-step">
                    <div class="step-icon">3</div>
                    <div class="step-text">
                        <h4>Chave PIX</h4>
                        <p>Configure sua chave PIX para receber pagamentos dos pedidos.</p>
                    </div>
                </div>
                
                <div class="welcome-step">
                    <div class="step-icon">4</div>
                    <div class="step-text">
                        <h4>Logo e Tema</h4>
                        <p>Personalize sua loja com sua logo e escolha um tema que combine com sua marca.</p>
                    </div>
                </div>
            </div>
            
            <p class="text-gray mb-3" style="text-align: center;">
                <i class="fas fa-info-circle"></i> Você pode alterar essas configurações a qualquer momento.
            </p>
            
            <button class="btn btn-primary btn-block" id="goToConfigBtn">
                <i class="fas fa-cog"></i> Começar Configuração
            </button>
        </div>
    </div>

    <!-- Block Modal -->
    <div class="block-modal" id="blockModal">
        <div class="block-content">
            <div class="block-icon">
                <i class="fas fa-ban"></i>
            </div>
            <h2 class="block-title">Conta Bloqueada</h2>
            <p class="block-message" id="blockMessage">
                Sua conta foi bloqueada pelo administrador. Entre em contato para mais informações.
            </p>
            <button class="btn btn-primary" id="logoutBlockedBtn">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </div>

    <!-- WhatsApp Notification Modal - Novo Design -->
    <div class="whatsapp-notification-modal" id="whatsappNotificationModal">
        <div class="whatsapp-notification-content">
            <div class="whatsapp-icon">
                <i class="fab fa-whatsapp"></i>
            </div>
            <h2 class="whatsapp-title">Enviar Notificação</h2>
            
            <div class="whatsapp-message">
                <strong>Mensagem que será enviada:</strong><br><br>
                <span id="whatsappMessageContent">Carregando mensagem...</span>
            </div>
            
            <div class="whatsapp-instructions">
                <strong>Instruções:</strong>
                <ol>
                    <li>Clique no botão "Abrir WhatsApp" abaixo</li>
                    <li>O WhatsApp será aberto com a mensagem pronta</li>
                    <li>Verifique a mensagem e envie para o cliente</li>
                    <li>Após enviar, volte para esta tela e clique em "Notificação Enviada"</li>
                </ol>
            </div>
            
            <div class="d-flex gap-2">
                <button class="btn btn-secondary flex-1" id="cancelWhatsappBtn">
                    Cancelar
                </button>
                <button class="btn btn-success flex-1" id="openWhatsappBtn">
                    <i class="fab fa-whatsapp"></i> Abrir WhatsApp
                </button>
                <button class="btn btn-primary flex-1" id="confirmWhatsappBtn">
                    <i class="fas fa-check"></i> Notificação Enviada
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Enviando comprovante...</div>
    </div>

    <!-- App Container -->
    <div class="app-container">
        <!-- App Header -->
        <header class="app-header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-store"></i>
                </div>
                <div class="logo-text">
                    <h1 id="adminStoreName">Venda+</h1>
                </div>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar"></div>
                <button class="logout-btn" id="logoutBtn" title="Sair">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Screen -->
            <div id="dashboardScreen" class="screen active">
                <h2 class="section-title">Dashboard</h2>
                
                <!-- Expiry Warning -->
                <div class="expiry-warning d-none" id="expiryWarningBanner">
                    <div class="expiry-warning-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 class="mb-2" id="expiryWarningText"></h3>
                    <p class="text-gray mb-2">Renove seu plano para continuar usando todos os recursos do sistema.</p>
                    <button class="btn btn-primary btn-sm" id="renewPlanBannerBtn">
                        <i class="fas fa-sync-alt"></i> Renovar Plano
                    </button>
                </div>
                
                <!-- User Info Card -->
                <div class="user-card">
                    <div class="user-card-header">
                        <div class="user-card-avatar" id="storeAvatar"></div>
                        <div class="user-card-info">
                            <h3 id="storeNameDisplay">Carregando...</h3>
                            <p id="storeEmail">carregando...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon preparing">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Preparando</h3>
                            <div class="stat-number" id="preparingOrders">0</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon confirmed">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Confirmados</h3>
                            <div class="stat-number" id="confirmedOrders">0</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon delivering">
                            <i class="fas fa-motorcycle"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Entregando</h3>
                            <div class="stat-number" id="deliveringOrders">0</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon delivered">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Entregues</h3>
                            <div class="stat-number" id="deliveredOrders">0</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon total">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Total Pedidos</h3>
                            <div class="stat-number" id="totalOrders">0</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon revenue">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Receita</h3>
                            <div class="stat-number" id="totalRevenue">R$ 0</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon delivery">
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Taxa de Entrega</h3>
                            <div class="stat-number" id="deliveryFeeStat">R$ 0</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon visits">
                            <i class="fas fa-eye"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Acessos</h3>
                            <div class="stat-number" id="totalVisits">0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Visits Chart -->
                <div class="chart-container">
                    <div class="chart-title">
                        <i class="fas fa-chart-bar"></i>
                        Acessos da Loja (Últimos 7 dias)
                    </div>
                    <canvas id="visitsChart" height="150"></canvas>
                </div>
                
                <!-- Recent Orders -->
                <h3 class="mb-2">Pedidos Recentes</h3>
                <div class="orders-list" id="recentOrdersList">
                    <!-- Orders will be loaded here -->
                </div>
                
                <div class="empty-state" id="recentOrdersEmpty" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <h3>Nenhum pedido</h3>
                    <p>Novos pedidos aparecerão aqui.</p>
                </div>
            </div>

            <!-- Orders Screen -->
            <div id="ordersScreen" class="screen" style="display: none;">
                <h2 class="section-title">Pedidos</h2>
                
                <div class="status-filter">
                    <button class="status-filter-btn active" data-status="all">Todos</button>
                    <button class="status-filter-btn" data-status="preparing">Preparando</button>
                    <button class="status-filter-btn" data-status="confirmed">Confirmados</button>
                    <button class="status-filter-btn" data-status="delivering">Entregando</button>
                    <button class="status-filter-btn" data-status="delivered">Entregues</button>
                </div>
                
                <div class="orders-list" id="allOrdersList">
                    <!-- Orders will be loaded here -->
                </div>
                
                <div class="empty-state" id="allOrdersEmpty" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <h3>Nenhum pedido</h3>
                    <p>Os pedidos aparecerão aqui.</p>
                </div>
            </div>

            <!-- Products Screen -->
            <div id="productsScreen" class="screen" style="display: none;">
                <div class="d-flex justify-between align-center mb-3">
                    <h2 class="section-title">Produtos</h2>
                    <button class="btn btn-primary btn-sm" id="addProductBtn">
                        <i class="fas fa-plus"></i> Novo
                    </button>
                </div>
                
                <div class="products-list" id="productsList">
                    <!-- Products will be loaded here -->
                </div>
                
                <div class="empty-state" id="productsEmpty" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-box"></i>
                    </div>
                    <h3>Nenhum produto</h3>
                    <p>Adicione produtos para vender.</p>
                </div>
            </div>

            <!-- Finance Screen -->
            <div id="financeScreen" class="screen" style="display: none;">
                <h2 class="section-title">
                    <i class="fas fa-chart-pie"></i> Financeiro
                </h2>
                
                <!-- Finance Overview -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon revenue">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Receita Total</h3>
                            <div class="stat-number" id="financeTotalRevenue">R$ 0</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon total">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Total Pedidos</h3>
                            <div class="stat-number" id="financeTotalOrders">0</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon confirmed">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Média por Pedido</h3>
                            <div class="stat-number" id="averageOrderValue">R$ 0</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon delivery">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Mês Atual</h3>
                            <div class="stat-number" id="currentMonthRevenue">R$ 0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Revenue Chart -->
                <div class="chart-container">
                    <div class="chart-title">
                        <i class="fas fa-chart-line"></i>
                        Receita Mensal
                    </div>
                    <canvas id="revenueChart" height="150"></canvas>
                </div>
                
                <!-- Finance Tabs -->
                <div class="finance-tabs">
                    <button class="finance-tab active" data-tab="all">Todos os Pagamentos</button>
                    <button class="finance-tab" data-tab="monthly">Mensal</button>
                    <button class="finance-tab" data-tab="summary">Resumo</button>
                </div>
                
                <!-- All Payments -->
                <div id="financeAllTab" class="finance-tab-content">
                    <div class="orders-list" id="allPaymentsList">
                        <!-- Payments will be loaded here -->
                    </div>
                    
                    <div class="empty-state" id="allPaymentsEmpty" style="display: none;">
                        <div class="empty-icon">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <h3>Nenhum pagamento</h3>
                        <p>Os pagamentos aparecerão aqui.</p>
                    </div>
                </div>
                
                <!-- Monthly Summary -->
                <div id="financeMonthlyTab" class="finance-tab-content" style="display: none;">
                    <div id="monthlySummaryList">
                        <!-- Monthly summaries will be loaded here -->
                    </div>
                </div>
                
                <!-- Finance Summary -->
                <div id="financeSummaryTab" class="finance-tab-content" style="display: none;">
                    <div class="chart-container">
                        <div class="chart-title">
                            <i class="fas fa-chart-pie"></i>
                            Métodos de Pagamento
                        </div>
                        <canvas id="paymentMethodsChart" height="150"></canvas>
                    </div>
                    
                    <div class="monthly-summary">
                        <h3 class="mb-2">Resumo Financeiro</h3>
                        <div class="daily-orders">
                            <div class="daily-order">
                                <span>Total em PIX:</span>
                                <span class="order-amount" id="totalPixAmount">R$ 0,00</span>
                            </div>
                            <div class="daily-order">
                                <span>Total em Dinheiro:</span>
                                <span class="order-amount" id="totalMoneyAmount">R$ 0,00</span>
                            </div>
                            <div class="daily-order">
                                <span>Total em Taxas de Entrega:</span>
                                <span class="order-amount" id="totalDeliveryFees">R$ 0,00</span>
                            </div>
                            <div class="daily-order">
                                <span>Pedidos com Comprovante:</span>
                                <span class="order-amount" id="ordersWithReceipt">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Config Screen -->
            <div id="configScreen" class="screen" style="display: none;">
                <h2 class="section-title">Configurações</h2>
                
                <form id="configForm">
                    <div class="form-group">
                        <label class="form-label">Nome do Negócio *</label>
                        <input type="text" id="configBusinessName" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Logo da Loja</label>
                        <div class="upload-area" id="logoUploadArea">
                            <div class="upload-icon">
                                <i class="fas fa-image"></i>
                            </div>
                            <div class="upload-text">Clique para fazer upload</div>
                            <div class="upload-info">Tamanho máximo: 8MB</div>
                            <input type="file" id="configLogoUpload" accept="image/*" style="display: none;">
                        </div>
                        <img id="configLogoPreview" class="image-preview" alt="Logo">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">WhatsApp *</label>
                        <input type="text" id="configWhatsApp" class="form-input" required placeholder="(11) 99999-9999">
                        <small class="text-gray">Formato: (DDD) 99999-9999</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Chave PIX *</label>
                        <input type="text" id="configPixKey" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Telefone para Contato *</label>
                        <input type="text" id="configContactPhone" class="form-input" required placeholder="(11) 99999-9999">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Título dos Produtos *</label>
                        <input type="text" id="configProductsTitle" class="form-input" required placeholder="Nossos Produtos">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Taxa de Entrega (R$)</label>
                        <input type="number" id="configDeliveryFee" class="form-input" step="0.01" min="0" value="0" placeholder="0.00">
                        <small class="text-gray">Valor da taxa de entrega que será adicionada ao total dos pedidos</small>
                    </div>
                    
                    <!-- Gerenciar Categorias -->
                    <div class="link-section">
                        <h3 class="link-title">Gerenciar Categorias</h3>
                        <p class="link-description">
                            Adicione, edite ou remova categorias para seus produtos:
                        </p>
                        
                        <div id="categoriesList" class="mb-3">
                            <!-- Categorias serão carregadas aqui -->
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Nova Categoria</label>
                            <div class="d-flex gap-2">
                                <input type="text" id="newCategoryName" class="form-input" placeholder="Nome da categoria">
                                <button type="button" class="btn btn-primary" id="addCategoryBtn">
                                    <i class="fas fa-plus"></i> Adicionar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Link para Clientes -->
                    <div class="link-section">
                        <h3 class="link-title">Link para Clientes</h3>
                        <p class="link-description">
                            Compartilhe este link com seus clientes para que eles possam acessar sua loja virtual:
                        </p>
                        
                        <div class="link-container" id="customerLinkContainer">
                            <strong>Carregando link...</strong>
                        </div>
                        
                        <div class="link-actions">
                            <button class="btn btn-primary flex-1" id="copyLinkBtn">
                                <i class="fas fa-copy"></i> Copiar Link
                            </button>
                            <button class="btn btn-success flex-1" id="openLinkBtn">
                                <i class="fas fa-external-link-alt"></i> Abrir Link
                            </button>
                            <button class="btn btn-secondary flex-1" id="shareLinkBtn">
                                <i class="fas fa-share-alt"></i> Compartilhar
                            </button>
                        </div>
                        
                        <div class="mt-2">
                            <small><strong>Acessos totais:</strong> <span id="totalVisitsConfig">0</span></small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tema da Loja</label>
                        <div class="theme-selector">
                            <div class="theme-option theme-red" data-theme="red">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #8B0000 0%, #FF0000 100%); color: white;">Vermelho</div>
                                <div class="theme-name">Vermelho</div>
                            </div>
                            <div class="theme-option theme-blue" data-theme="blue">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #00008B 0%, #4169E1 100%); color: white;">Azul</div>
                                <div class="theme-name">Azul</div>
                            </div>
                            <div class="theme-option theme-pink" data-theme="pink">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #F4C2C2 0%, #FFB6C1 100%); color: #212121;">Rosa</div>
                                <div class="theme-name">Rosa</div>
                            </div>
                            <div class="theme-option theme-yellow" data-theme="yellow">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #FFD700 0%, #FFEC8B 100%); color: #212121;">Amarelo</div>
                                <div class="theme-name">Amarelo</div>
                            </div>
                            <div class="theme-option theme-black active" data-theme="black">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #212121 0%, #424242 100%); color: white;">Preto</div>
                                <div class="theme-name">Preto</div>
                            </div>
                            <div class="theme-option theme-purple" data-theme="purple">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #8A2BE2 0%, #9370DB 100%); color: white;">Roxo</div>
                                <div class="theme-name">Roxo</div>
                            </div>
                            <div class="theme-option theme-green" data-theme="green">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #006400 0%, #32CD32 100%); color: white;">Verde</div>
                                <div class="theme-name">Verde</div>
                            </div>
                            <div class="theme-option theme-orange" data-theme="orange">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #FF8C00 0%, #FFA500 100%); color: white;">Laranja</div>
                                <div class="theme-name">Laranja</div>
                            </div>
                        </div>
                        <input type="hidden" id="configTheme" value="black">
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-save"></i> Salvar Configurações
                    </button>
                </form>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-btn active" data-screen="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </button>
            <button class="nav-btn" data-screen="orders">
                <i class="fas fa-shopping-cart"></i>
                <span>Pedidos</span>
                <div class="notification-badge d-none" id="ordersBadge">0</div>
            </button>
            <button class="nav-btn" data-screen="products">
                <i class="fas fa-box"></i>
                <span>Produtos</span>
            </button>
            <button class="nav-btn" data-screen="finance">
                <i class="fas fa-chart-pie"></i>
                <span>Financeiro</span>
            </button>
            <button class="nav-btn" data-screen="config">
                <i class="fas fa-cog"></i>
                <span>Configurações</span>
            </button>
        </nav>
    </div>

    <!-- Order Details Modal -->
    <div class="modal" id="orderDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Detalhes do Pedido</h2>
                <button class="close-modal" id="closeOrderModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="orderDetailsContent">
                    <!-- Order details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Product Form Modal -->
    <div class="modal" id="productFormModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="productModalTitle">Novo Produto</h2>
                <button class="close-modal" id="closeProductModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    
                    <div class="form-group">
                        <label class="form-label">Nome do Produto *</label>
                        <input type="text" id="productName" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Descrição *</label>
                        <textarea id="productDescription" class="form-input" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Preço (R$) *</label>
                        <input type="number" id="productPrice" class="form-input" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Categoria *</label>
                        <select id="productCategory" class="form-input" required>
                            <option value="">Selecione...</option>
                            <!-- Categorias serão carregadas dinamicamente -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Imagem do Produto</label>
                        <div class="upload-area" id="productImageUploadArea">
                            <div class="upload-icon">
                                <i class="fas fa-image"></i>
                            </div>
                            <div class="upload-text">Clique para fazer upload</div>
                            <div class="upload-info">Tamanho máximo: 8MB</div>
                            <input type="file" id="productImageUpload" accept="image/*" style="display: none;">
                        </div>
                        <img id="productImagePreview" class="image-preview" alt="Produto">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <div class="d-flex align-center gap-2">
                            <label class="toggle-switch">
                                <input type="checkbox" id="productActive" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Ativo</span>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary flex-1" id="cancelProductBtn">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary flex-1">
                            Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Image Zoom Modal -->
    <div class="image-zoom-modal" id="imageZoomModal">
        <div class="image-zoom-content">
            <button class="close-zoom" id="closeZoom">&times;</button>
            <img id="zoomedImage" src="" alt="Imagem ampliada">
        </div>
    </div>

    <!-- Expiry Warning Modal -->
    <div class="modal" id="expiryWarningModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">⚠️ Aviso de Vencimento</h2>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="mb-3" style="font-size: 3rem; color: #ff9800;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 class="mb-2">Seu plano está prestes a vencer!</h3>
                    <p class="mb-3" id="expiryWarningMessage">
                        <!-- Message will be filled by JavaScript -->
                    </p>
                    <p class="text-gray">Renove seu plano para continuar usando todos os recursos do sistema.</p>
                    
                    <div class="d-flex gap-2 mt-3">
                        <button class="btn btn-primary flex-1" id="renewPlanBtn">
                            <i class="fas fa-sync-alt"></i> Renovar Plano
                        </button>
                        <button class="btn btn-secondary flex-1" id="closeExpiryWarningBtn">
                            Fechar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Renew Payment Modal -->
    <div class="modal" id="renewPaymentModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🔄 Renovar Plano</h2>
                <button class="close-modal" id="closeRenewModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="payment-icon" style="font-size: 3rem; color: #212121;">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <h3 class="mb-2">Renovação do Plano Mensal</h3>
                    <p class="text-gray">Realize o pagamento para renovar seu plano por mais 30 dias.</p>
                </div>
                
                <div class="pix-info" style="background-color: #f0f9ff; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 2px dashed #2196f3;">
                    <div class="pix-title" style="font-size: 1.1rem; font-weight: 600; color: #2196f3; margin-bottom: 10px;">
                        Pagamento via PIX
                    </div>
                    <div class="pix-key" style="background-color: #ffffff; padding: 15px; border-radius: 8px; font-family: monospace; word-break: break-all; margin-bottom: 15px; border: 1px solid #e0e0e0;" id="renewPixKeyDisplay">
                        Carregando chave PIX...
                    </div>
                    <p>Copie a chave PIX acima e faça o pagamento no seu aplicativo bancário.</p>
                    <div class="plan-price" style="font-size: 1.8rem; font-weight: 700; color: #212121; text-align: center; margin-top: 15px;" id="renewPlanPrice">
                        R$ 99,00
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Envie o comprovante da renovação</label>
                    <div class="upload-area" id="renewReceiptUploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-file-upload"></i>
                        </div>
                        <div class="upload-text">Clique para fazer upload</div>
                        <div class="upload-info">Aceitamos imagens (JPG, PNG) ou PDF - Tamanho máximo: 8MB</div>
                        <div class="file-types">
                            <span class="file-type-badge">JPG</span>
                            <span class="file-type-badge">PNG</span>
                            <span class="file-type-badge">PDF</span>
                        </div>
                        <input type="file" id="renewReceiptUpload" accept="image/*,.pdf" style="display: none;">
                    </div>
                    
                    <img id="renewReceiptImagePreview" class="image-preview" alt="Comprovante">
                    
                    <div class="pdf-preview" id="renewReceiptPdfPreview">
                        <i class="fas fa-file-pdf"></i>
                        <div class="upload-text" id="renewPdfFileName">comprovante.pdf</div>
                        <div class="upload-info">Clique para visualizar</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Observações (opcional)</label>
                    <textarea id="renewPaymentNotes" class="form-input" rows="3" placeholder="Alguma observação sobre o pagamento..."></textarea>
                </div>
                
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-secondary flex-1" id="cancelRenewBtn">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-primary flex-1" id="submitRenewBtn">
                        <i class="fas fa-paper-plane"></i> Concluir Renovação
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB7U-JfKAlkPxSyL4AEf5u0BgcDzSXf41M",
            authDomain: "appvendas-1eebf.firebaseapp.com",
            projectId: "appvendas-1eebf",
            storageBucket: "appvendas-1eebf.firebasestorage.app",
            messagingSenderId: "229472373918",
            appId: "1:229472373918:web:39cd4940b052b2375f3f8f"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Application state
        let currentUser = null;
        let currentStoreId = null;
        let currentScreen = 'dashboard';
        let orders = [];
        let products = [];
        let categories = [];
        let storeConfig = {};
        let selectedOrder = null;
        let selectedProduct = null;
        let statusFilter = 'all';
        let logoBase64 = '';
        let productImageBase64 = '';
        let ordersListener = null;
        let customerLink = '';
        let preparingOrdersCount = 0;
        let phoneMask = null;
        let userConfigCompleted = false;
        let storeVisits = 0;
        let dailyVisitsData = [];
        let visitsChart = null;
        let revenueChart = null;
        let paymentMethodsChart = null;
        let financeTab = 'all';
        let pinchZoom = null;
        let lastTouchDistance = null;
        let renewReceiptBase64 = '';
        let renewReceiptType = '';
        let renewReceiptFileName = '';
        let userActivityListener = null;
        let whatsappNotificationType = null;
        let whatsappNotificationData = null;

        // DOM Elements
        const welcomeModal = document.getElementById('welcomeModal');
        const goToConfigBtn = document.getElementById('goToConfigBtn');
        const screens = document.querySelectorAll('.screen');
        const navBtns = document.querySelectorAll('.nav-btn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userAvatar = document.getElementById('userAvatar');
        const storeAvatar = document.getElementById('storeAvatar');
        const storeNameDisplay = document.getElementById('storeNameDisplay');
        const storeEmail = document.getElementById('storeEmail');
        const adminStoreName = document.getElementById('adminStoreName');
        const customerLinkContainer = document.getElementById('customerLinkContainer');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const openLinkBtn = document.getElementById('openLinkBtn');
        const shareLinkBtn = document.getElementById('shareLinkBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // WhatsApp Notification Modal elements
        const whatsappNotificationModal = document.getElementById('whatsappNotificationModal');
        const whatsappMessageContent = document.getElementById('whatsappMessageContent');
        const cancelWhatsappBtn = document.getElementById('cancelWhatsappBtn');
        const openWhatsappBtn = document.getElementById('openWhatsappBtn');
        const confirmWhatsappBtn = document.getElementById('confirmWhatsappBtn');
        
        // Expiry warning elements
        const expiryWarningModal = document.getElementById('expiryWarningModal');
        const expiryWarningMessage = document.getElementById('expiryWarningMessage');
        const renewPlanBtn = document.getElementById('renewPlanBtn');
        const closeExpiryWarningBtn = document.getElementById('closeExpiryWarningBtn');
        const expiryWarningBanner = document.getElementById('expiryWarningBanner');
        const expiryWarningText = document.getElementById('expiryWarningText');
        const renewPlanBannerBtn = document.getElementById('renewPlanBannerBtn');
        
        // Dashboard elements
        const preparingOrdersCountElement = document.getElementById('preparingOrders');
        const confirmedOrdersCountElement = document.getElementById('confirmedOrders');
        const deliveringOrdersCountElement = document.getElementById('deliveringOrders');
        const deliveredOrdersCountElement = document.getElementById('deliveredOrders');
        const totalOrdersCountElement = document.getElementById('totalOrders');
        const totalRevenueElement = document.getElementById('totalRevenue');
        const deliveryFeeStat = document.getElementById('deliveryFeeStat');
        const totalVisitsElement = document.getElementById('totalVisits');
        const totalVisitsConfig = document.getElementById('totalVisitsConfig');
        const recentOrdersList = document.getElementById('recentOrdersList');
        const recentOrdersEmpty = document.getElementById('recentOrdersEmpty');
        
        // Finance elements
        const financeTotalRevenue = document.getElementById('financeTotalRevenue');
        const financeTotalOrders = document.getElementById('financeTotalOrders');
        const averageOrderValue = document.getElementById('averageOrderValue');
        const currentMonthRevenue = document.getElementById('currentMonthRevenue');
        const financeTabs = document.querySelectorAll('.finance-tab');
        const allPaymentsList = document.getElementById('allPaymentsList');
        const allPaymentsEmpty = document.getElementById('allPaymentsEmpty');
        const monthlySummaryList = document.getElementById('monthlySummaryList');
        const totalPixAmount = document.getElementById('totalPixAmount');
        const totalMoneyAmount = document.getElementById('totalMoneyAmount');
        const totalDeliveryFees = document.getElementById('totalDeliveryFees');
        const ordersWithReceipt = document.getElementById('ordersWithReceipt');
        
        // Orders elements
        const statusFilterBtns = document.querySelectorAll('.status-filter-btn');
        const allOrdersList = document.getElementById('allOrdersList');
        const allOrdersEmpty = document.getElementById('allOrdersEmpty');
        const ordersBadge = document.getElementById('ordersBadge');
        
        // Products elements
        const productsList = document.getElementById('productsList');
        const productsEmpty = document.getElementById('productsEmpty');
        const addProductBtn = document.getElementById('addProductBtn');
        
        // Configuration elements
        const configForm = document.getElementById('configForm');
        const configBusinessName = document.getElementById('configBusinessName');
        const logoUploadArea = document.getElementById('logoUploadArea');
        const configLogoUpload = document.getElementById('configLogoUpload');
        const configLogoPreview = document.getElementById('configLogoPreview');
        const configWhatsApp = document.getElementById('configWhatsApp');
        const configPixKey = document.getElementById('configPixKey');
        const configContactPhone = document.getElementById('configContactPhone');
        const configProductsTitle = document.getElementById('configProductsTitle');
        const configDeliveryFee = document.getElementById('configDeliveryFee');
        const configTheme = document.getElementById('configTheme');
        const themeOptions = document.querySelectorAll('.theme-option');
        
        // Categories elements
        const categoriesList = document.getElementById('categoriesList');
        const newCategoryName = document.getElementById('newCategoryName');
        const addCategoryBtn = document.getElementById('addCategoryBtn');
        
        // Product form elements
        const productForm = document.getElementById('productForm');
        const productIdInput = document.getElementById('productId');
        const productModalTitle = document.getElementById('productModalTitle');
        const productName = document.getElementById('productName');
        const productDescription = document.getElementById('productDescription');
        const productPrice = document.getElementById('productPrice');
        const productCategory = document.getElementById('productCategory');
        const productImageUploadArea = document.getElementById('productImageUploadArea');
        const productImageUpload = document.getElementById('productImageUpload');
        const productImagePreview = document.getElementById('productImagePreview');
        const productActive = document.getElementById('productActive');
        const cancelProductBtn = document.getElementById('cancelProductBtn');
        
        // Renew payment elements
        const renewPaymentModal = document.getElementById('renewPaymentModal');
        const closeRenewModal = document.getElementById('closeRenewModal');
        const renewPixKeyDisplay = document.getElementById('renewPixKeyDisplay');
        const renewPlanPrice = document.getElementById('renewPlanPrice');
        const renewReceiptUploadArea = document.getElementById('renewReceiptUploadArea');
        const renewReceiptUpload = document.getElementById('renewReceiptUpload');
        const renewReceiptImagePreview = document.getElementById('renewReceiptImagePreview');
        const renewReceiptPdfPreview = document.getElementById('renewReceiptPdfPreview');
        const renewPdfFileName = document.getElementById('renewPdfFileName');
        const renewPaymentNotes = document.getElementById('renewPaymentNotes');
        const cancelRenewBtn = document.getElementById('cancelRenewBtn');
        const submitRenewBtn = document.getElementById('submitRenewBtn');
        
        // Block modal elements
        const blockModal = document.getElementById('blockModal');
        const blockMessage = document.getElementById('blockMessage');
        const logoutBlockedBtn = document.getElementById('logoutBlockedBtn');
        
        // Modals
        const orderDetailsModal = document.getElementById('orderDetailsModal');
        const closeOrderModal = document.getElementById('closeOrderModal');
        const productFormModal = document.getElementById('productFormModal');
        const closeProductModal = document.getElementById('closeProductModal');
        const imageZoomModal = document.getElementById('imageZoomModal');
        const closeZoom = document.getElementById('closeZoom');
        const zoomedImage = document.getElementById('zoomedImage');

        // Initialize the app
        async function init() {
            await checkAuth();
            await checkUserStatus();
            await loadUserData();
            await loadStoreConfig();
            await loadCategories();
            setupPhoneMasks();
            setupEventListeners();
            setupOrdersListener();
            setupUserActivityListener();
            loadProducts();
            updateCustomerLink();
            showScreen('dashboard');
            
            // Load store visits data
            await loadStoreVisits();
            
            // Verificar se precisa mostrar o modal de boas-vindas
            checkWelcomeModal();
            
            // Check expiry warning
            await checkExpiryWarning();
        }

        // Setup phone masks
        function setupPhoneMasks() {
            // Mask for Brazilian phone numbers
            const phoneMaskOptions = {
                mask: '(00) 00000-0000',
                lazy: false
            };
            
            if (configWhatsApp) {
                phoneMask = new IMask(configWhatsApp, phoneMaskOptions);
            }
            
            if (configContactPhone) {
                new IMask(configContactPhone, phoneMaskOptions);
            }
        }

        // Check user status for blocking
        async function checkUserStatus() {
            try {
                if (!currentStoreId) return;
                
                const userDoc = await db.collection('users').doc(currentStoreId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    if (userData.status === 'blocked' || userData.isActive === false) {
                        // Show block modal and prevent any action
                        showBlockModal('Sua conta foi bloqueada pelo administrador. Entre em contato para mais informações.');
                        return false;
                    }
                    
                    return true;
                }
            } catch (error) {
                console.error('Error checking user status:', error);
            }
            return true;
        }

        // Show block modal
        function showBlockModal(message) {
            blockMessage.textContent = message;
            blockModal.style.display = 'flex';
            
            // Disable all navigation and functionality
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.pointerEvents = 'none';
            });
            
            // Disable logout button in header
            logoutBtn.disabled = true;
            
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.style.display = 'none';
            });
        }

        // Check welcome modal
        function checkWelcomeModal() {
            if (!userConfigCompleted) {
                welcomeModal.style.display = 'flex';
                
                // Não permitir fechar clicando fora - só com o botão
                welcomeModal.addEventListener('click', (e) => {
                    if (e.target === welcomeModal) {
                        // Não faz nada - impede fechar
                        e.stopPropagation();
                    }
                });
            }
        }

        // Check expiry date and show warning if needed
        async function checkExpiryWarning() {
            try {
                const storedUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (!storedUser.expiryDate) return;
                
                const expiryDate = new Date(storedUser.expiryDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // Calculate days until expiry
                const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                
                if (daysUntilExpiry <= 7 && daysUntilExpiry > 0) {
                    // Show warning banner
                    const bannerMessage = daysUntilExpiry === 1 
                        ? 'Seu plano vence AMANHÃ!' 
                        : `Seu plano vence em ${daysUntilExpiry} dias.`;
                    
                    expiryWarningText.textContent = bannerMessage;
                    expiryWarningBanner.classList.remove('d-none');
                    
                    // Show modal on first load if less than 3 days
                    if (daysUntilExpiry <= 3) {
                        const modalMessage = daysUntilExpiry === 1 
                            ? 'Seu plano vence AMANHÃ!' 
                            : `Seu plano vence em ${daysUntilExpiry} dias.`;
                        
                        expiryWarningMessage.textContent = modalMessage;
                        expiryWarningModal.style.display = 'flex';
                    }
                } else if (daysUntilExpiry <= 0) {
                    // Plan has expired
                    expiryWarningText.textContent = 'Seu plano está VENCIDO!';
                    expiryWarningBanner.classList.remove('d-none');
                    
                    const modalMessage = 'Seu plano está VENCIDO! Renove agora para continuar usando o sistema.';
                    expiryWarningMessage.textContent = modalMessage;
                    expiryWarningModal.style.display = 'flex';
                }
            } catch (error) {
                console.error('Error checking expiry warning:', error);
            }
        }

        // Check authentication
        async function checkAuth() {
            try {
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                    currentStoreId = currentUser.uid;
                    return true;
                }
                
                await new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged((user) => {
                        unsubscribe();
                        if (user) {
                            currentUser = {
                                uid: user.uid,
                                email: user.email,
                                isAdmin: true
                            };
                            currentStoreId = user.uid;
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            resolve(true);
                        } else {
                            window.location.href = 'login.html';
                            reject(new Error('Not authenticated'));
                        }
                    });
                });
                return true;
            } catch (error) {
                console.error('Auth error:', error);
                window.location.href = 'login.html';
                return false;
            }
        }

        // Load user data and update avatar with logo
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentStoreId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    currentUser.storeName = userData.storeName;
                    currentUser.expiryDate = userData.expiryDate || null;
                    currentUser.phone = userData.phone || '';
                    userConfigCompleted = userData.configCompleted || false;
                    
                    // Atualizar o avatar do usuário (canto superior direito)
                    updateUserAvatar();
                    
                    // Atualizar o avatar da loja (dashboard)
                    updateStoreAvatar();
                    
                    storeNameDisplay.textContent = userData.storeName || 'Minha Loja';
                    storeEmail.textContent = currentUser.email;
                    adminStoreName.textContent = `Venda+`;
                    
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Update user avatar with logo from store config
        function updateUserAvatar() {
            if (storeConfig.logoBase64) {
                userAvatar.style.backgroundImage = `url(${storeConfig.logoBase64})`;
                userAvatar.textContent = '';
            } else {
                userAvatar.style.backgroundImage = '';
                userAvatar.textContent = '';
            }
        }

        // Update store avatar with logo from store config
        function updateStoreAvatar() {
            if (storeConfig.logoBase64) {
                storeAvatar.style.backgroundImage = `url(${storeConfig.logoBase64})`;
                storeAvatar.textContent = '';
            } else {
                storeAvatar.style.backgroundImage = '';
                storeAvatar.textContent = '';
            }
        }

        // Setup user activity listener
        function setupUserActivityListener() {
            if (userActivityListener) {
                userActivityListener();
            }
            
            // Record initial activity
            recordUserActivity('login');
            
            // Listen for screen changes
            document.addEventListener('click', () => {
                recordUserActivity('interaction');
            });
            
            // Listen for navigation
            navBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const screen = btn.getAttribute('data-screen');
                    recordUserActivity(`navigate_${screen}`);
                });
            });
        }

        // Record user activity
        async function recordUserActivity(action) {
            try {
                if (!currentStoreId) return;
                
                const activityData = {
                    userId: currentStoreId,
                    action: action,
                    timestamp: new Date().toISOString(),
                    userEmail: currentUser.email,
                    storeName: currentUser.storeName || 'Minha Loja'
                };
                
                await db.collection('userActivities').add(activityData);
                
                // Update last activity timestamp
                await db.collection('users').doc(currentStoreId).update({
                    lastActivity: new Date().toISOString()
                });
                
            } catch (error) {
                console.error('Error recording user activity:', error);
            }
        }

        // Load store configuration for current user
        async function loadStoreConfig() {
            try {
                const configDoc = await db.collection('stores').doc(currentStoreId).get();
                if (configDoc.exists) {
                    storeConfig = configDoc.data();
                    updateConfigForm();
                    
                    // Atualizar os avatares após carregar a configuração
                    updateUserAvatar();
                    updateStoreAvatar();
                } else {
                    storeConfig = {
                        businessName: currentUser.storeName || 'Minha Loja',
                        logoBase64: '',
                        whatsappNumber: '',
                        pixKey: '',
                        contactPhone: '',
                        productsTitle: 'Nossos Produtos',
                        deliveryFee: 0,
                        theme: 'black',
                        ownerId: currentStoreId,
                        createdAt: new Date().toISOString()
                    };
                    await db.collection('stores').doc(currentStoreId).set(storeConfig);
                    updateConfigForm();
                }
            } catch (error) {
                console.error('Error loading store config:', error);
                showNotification('Erro ao carregar configurações.', 'error');
            }
        }

        // Load categories for current store
        async function loadCategories() {
            try {
                const categoriesDoc = await db.collection('stores').doc(currentStoreId).collection('categories').get();
                categories = [];
                categoriesDoc.forEach(doc => {
                    categories.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                updateCategoriesList();
                updateProductCategorySelect();
            } catch (error) {
                console.error('Error loading categories:', error);
                // Se não houver categorias, criar algumas padrão
                await createDefaultCategories();
            }
        }

        // Create default categories if none exist
        async function createDefaultCategories() {
            const defaultCategories = [
                { name: 'Alimentos', createdAt: new Date().toISOString() },
                { name: 'Bebidas', createdAt: new Date().toISOString() },
                { name: 'Artesanato', createdAt: new Date().toISOString() },
                { name: 'Outros', createdAt: new Date().toISOString() }
            ];
            
            try {
                for (const category of defaultCategories) {
                    await db.collection('stores').doc(currentStoreId).collection('categories').add({
                        ...category,
                        storeId: currentStoreId
                    });
                }
                
                await loadCategories();
            } catch (error) {
                console.error('Error creating default categories:', error);
            }
        }

        // Update categories list in config screen
        function updateCategoriesList() {
            categoriesList.innerHTML = '';
            
            if (categories.length === 0) {
                categoriesList.innerHTML = `
                    <div class="empty-state" style="padding: 20px;">
                        <div class="empty-icon">
                            <i class="fas fa-tags"></i>
                        </div>
                        <p>Nenhuma categoria cadastrada</p>
                    </div>
                `;
                return;
            }
            
            categories.forEach(category => {
                const categoryElement = document.createElement('div');
                categoryElement.className = 'd-flex justify-between align-center mb-2 p-2 border rounded';
                categoryElement.innerHTML = `
                    <span>${category.name}</span>
                    <button class="btn btn-danger btn-sm delete-category-btn" data-id="${category.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                categoriesList.appendChild(categoryElement);
            });
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-category-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const categoryId = e.currentTarget.getAttribute('data-id');
                    await deleteCategory(categoryId);
                });
            });
        }

        // Update product category select
        function updateProductCategorySelect() {
            const select = document.getElementById('productCategory');
            if (!select) return;
            
            // Clear existing options except the first one
            select.innerHTML = '<option value="">Selecione...</option>';
            
            // Add categories
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
        }

        // Add new category
        async function addCategory() {
            const name = newCategoryName.value.trim();
            if (!name) {
                showNotification('Digite um nome para a categoria.', 'error');
                return;
            }
            
            try {
                await db.collection('stores').doc(currentStoreId).collection('categories').add({
                    name: name,
                    storeId: currentStoreId,
                    createdAt: new Date().toISOString()
                });
                
                newCategoryName.value = '';
                await loadCategories();
                showNotification('Categoria adicionada com sucesso!', 'success');
            } catch (error) {
                console.error('Error adding category:', error);
                showNotification('Erro ao adicionar categoria.', 'error');
            }
        }

        // Delete category
        async function deleteCategory(categoryId) {
            if (!confirm('Tem certeza que deseja excluir esta categoria?')) return;
            
            try {
                // Verificar se há produtos usando esta categoria
                const productsSnapshot = await db.collection('stores').doc(currentStoreId)
                    .collection('products')
                    .where('category', '==', categoryId)
                    .get();
                
                if (!productsSnapshot.empty) {
                    showNotification('Não é possível excluir esta categoria porque existem produtos vinculados a ela.', 'error');
                    return;
                }
                
                await db.collection('stores').doc(currentStoreId).collection('categories').doc(categoryId).delete();
                await loadCategories();
                showNotification('Categoria excluída com sucesso!', 'success');
            } catch (error) {
                console.error('Error deleting category:', error);
                showNotification('Erro ao excluir categoria.', 'error');
            }
        }

        // Load store visits data
        async function loadStoreVisits() {
            try {
                const visitsDoc = await db.collection('storeVisits').doc(currentStoreId).get();
                if (visitsDoc.exists) {
                    const visitsData = visitsDoc.data();
                    storeVisits = visitsData.totalVisits || 0;
                    dailyVisitsData = visitsData.dailyVisits || [];
                    
                    totalVisitsElement.textContent = storeVisits;
                    totalVisitsConfig.textContent = storeVisits;
                    
                    // Update visits chart
                    updateVisitsChart();
                } else {
                    // Create initial visits document
                    await db.collection('storeVisits').doc(currentStoreId).set({
                        totalVisits: 0,
                        dailyVisits: [],
                        storeId: currentStoreId,
                        lastUpdated: new Date().toISOString()
                    });
                }
            } catch (error) {
                console.error('Error loading store visits:', error);
            }
        }

        // Update visits chart
        function updateVisitsChart() {
            const ctx = document.getElementById('visitsChart').getContext('2d');
            
            // Prepare data for last 7 days
            const last7Days = [];
            const visitsData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('pt-BR', { weekday: 'short' });
                last7Days.push(dateStr);
                
                // Find visits for this date
                const dateString = date.toISOString().split('T')[0];
                const visitsForDay = dailyVisitsData.find(v => v.date === dateString)?.count || 0;
                visitsData.push(visitsForDay);
            }
            
            if (visitsChart) {
                visitsChart.destroy();
            }
            
            visitsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'Acessos',
                        data: visitsData,
                        borderColor: '#212121',
                        backgroundColor: 'rgba(33, 33, 33, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Update finance charts
        function updateFinanceCharts() {
            // Prepare monthly revenue data
            const monthlyRevenue = {};
            orders.forEach(order => {
                if (order.total) {
                    const date = new Date(order.timestamp || order.createdAt);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const monthName = date.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
                    
                    if (!monthlyRevenue[monthKey]) {
                        monthlyRevenue[monthKey] = {
                            name: monthName,
                            revenue: 0
                        };
                    }
                    monthlyRevenue[monthKey].revenue += order.total;
                }
            });
            
            // Sort by date
            const sortedMonths = Object.keys(monthlyRevenue).sort().reverse().slice(0, 6);
            const monthLabels = sortedMonths.map(key => monthlyRevenue[key].name);
            const monthData = sortedMonths.map(key => monthlyRevenue[key].revenue);
            
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            if (revenueChart) {
                revenueChart.destroy();
            }
            
            revenueChart = new Chart(revenueCtx, {
                type: 'bar',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'Receita (R$)',
                        data: monthData,
                        backgroundColor: 'rgba(76, 175, 80, 0.6)',
                        borderColor: '#4caf50',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
            
            // Payment Methods Chart
            const paymentMethods = {
                pix: 0,
                money: 0
            };
            
            orders.forEach(order => {
                if (order.paymentMethod && order.total) {
                    paymentMethods[order.paymentMethod] += order.total;
                }
            });
            
            const paymentCtx = document.getElementById('paymentMethodsChart').getContext('2d');
            if (paymentMethodsChart) {
                paymentMethodsChart.destroy();
            }
            
            paymentMethodsChart = new Chart(paymentCtx, {
                type: 'doughnut',
                data: {
                    labels: ['PIX', 'Dinheiro'],
                    datasets: [{
                        data: [paymentMethods.pix, paymentMethods.money],
                        backgroundColor: ['#4caf50', '#2196f3'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Update summary data
            let totalPix = 0;
            let totalMoney = 0;
            let totalDelivery = 0;
            let ordersWithReceiptCount = 0;
            
            orders.forEach(order => {
                if (order.paymentMethod === 'pix') {
                    totalPix += order.total || 0;
                } else if (order.paymentMethod === 'money') {
                    totalMoney += order.total || 0;
                }
                totalDelivery += order.deliveryFee || 0;
                if (order.receiptBase64) {
                    ordersWithReceiptCount++;
                }
            });
            
            totalPixAmount.textContent = `R$ ${totalPix.toFixed(2).replace('.', ',')}`;
            totalMoneyAmount.textContent = `R$ ${totalMoney.toFixed(2).replace('.', ',')}`;
            totalDeliveryFees.textContent = `R$ ${totalDelivery.toFixed(2).replace('.', ',')}`;
            ordersWithReceipt.textContent = ordersWithReceiptCount;
        }

        // Update configuration form
        function updateConfigForm() {
            configBusinessName.value = storeConfig.businessName || '';
            configWhatsApp.value = storeConfig.whatsappNumber || '';
            configPixKey.value = storeConfig.pixKey || '';
            configContactPhone.value = storeConfig.contactPhone || '';
            configProductsTitle.value = storeConfig.productsTitle || 'Nossos Produtos';
            configDeliveryFee.value = storeConfig.deliveryFee || 0;
            configTheme.value = storeConfig.theme || 'black';
            
            // Update theme selection
            themeOptions.forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('data-theme') === configTheme.value) {
                    option.classList.add('active');
                }
            });
            
            if (storeConfig.logoBase64) {
                configLogoPreview.src = storeConfig.logoBase64;
                configLogoPreview.style.display = 'block';
                logoBase64 = storeConfig.logoBase64;
            }
            
            // Update delivery fee stat
            deliveryFeeStat.textContent = `R$ ${(storeConfig.deliveryFee || 0).toFixed(2)}`;
        }

        // Update customer link
        function updateCustomerLink() {
            if (!currentStoreId) return;
            
            const currentUrl = window.location.origin + window.location.pathname;
            const baseUrl = currentUrl.replace('admin.html', '');
            customerLink = `${baseUrl}vitrine.html?store=${currentStoreId}`;
            customerLinkContainer.innerHTML = `<strong>${customerLink}</strong>`;
        }

        // Setup real-time orders listener
        function setupOrdersListener() {
            if (ordersListener) {
                ordersListener();
            }
            
            ordersListener = db.collection('orders')
                .where('storeId', '==', currentStoreId)
                .onSnapshot((snapshot) => {
                    orders = [];
                    
                    snapshot.forEach(doc => {
                        const orderData = doc.data();
                        orders.push({
                            id: doc.id,
                            ...orderData
                        });
                    });
                    
                    orders.sort((a, b) => {
                        return new Date(b.timestamp || b.createdAt) - new Date(a.timestamp || b.createdAt);
                    });
                    
                    updateDashboardStats();
                    updateRecentOrders();
                    updateAllOrders();
                    updateNotificationBadge();
                    updateFinanceData();
                    
                    if (currentScreen === 'finance') {
                        updateFinanceUI();
                    }
                }, (error) => {
                    console.error("Error in orders listener:", error);
                    loadOrdersWithoutListener();
                });
        }

        // Update finance data
        function updateFinanceData() {
            // Calculate finance metrics
            const totalRevenue = orders.reduce((sum, order) => sum + (order.total || 0), 0);
            const averageOrder = orders.length > 0 ? totalRevenue / orders.length : 0;
            
            // Current month revenue
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const currentMonthRevenueTotal = orders.reduce((sum, order) => {
                const orderDate = new Date(order.timestamp || order.createdAt);
                if (orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear) {
                    return sum + (order.total || 0);
                }
                return sum;
            }, 0);
            
            financeTotalRevenue.textContent = `R$ ${totalRevenue.toFixed(0)}`;
            financeTotalOrders.textContent = orders.length;
            averageOrderValue.textContent = `R$ ${averageOrder.toFixed(2)}`;
            currentMonthRevenue.textContent = `R$ ${currentMonthRevenueTotal.toFixed(0)}`;
        }

        // Update finance UI based on selected tab
        function updateFinanceUI() {
            if (financeTab === 'all') {
                showAllPayments();
            } else if (financeTab === 'monthly') {
                showMonthlySummary();
            } else if (financeTab === 'summary') {
                showFinanceSummary();
            }
        }

        // Show all payments
        function showAllPayments() {
            allPaymentsList.innerHTML = '';
            
            if (orders.length === 0) {
                allPaymentsEmpty.style.display = 'block';
                return;
            }
            
            allPaymentsEmpty.style.display = 'none';
            
            orders.forEach(order => {
                const status = order.deliveryStatus || 'preparing';
                const total = order.total || 0;
                
                const paymentCard = document.createElement('div');
                paymentCard.className = 'order-card';
                paymentCard.innerHTML = `
                    <div class="order-header">
                        <div class="order-id">#${order.id.substring(0, 8)}</div>
                        <div class="order-date">${formatDate(order.timestamp || order.createdAt)}</div>
                    </div>
                    
                    <div class="order-customer">${order.customerName}</div>
                    
                    <div class="order-info">
                        <div>
                            <span class="order-status ${getDeliveryStatusClass(status)}">
                                ${getDeliveryStatusText(status)}
                            </span>
                        </div>
                        <div class="order-total">R$ ${total.toFixed(2).replace('.', ',')}</div>
                    </div>
                    
                    <div class="mb-1">
                        <small><strong>Pagamento:</strong> ${order.paymentMethod === 'money' ? 'Dinheiro' : 'PIX'}</small>
                    </div>
                    
                    <div class="mb-1">
                        <small><strong>Taxa de entrega:</strong> R$ ${(order.deliveryFee || 0).toFixed(2).replace('.', ',')}</small>
                    </div>
                    
                    ${order.receiptBase64 ? `
                        <div class="mb-1">
                            <small><strong>Comprovante:</strong> Enviado</small>
                        </div>
                    ` : ''}
                `;
                
                allPaymentsList.appendChild(paymentCard);
            });
        }

        // Show monthly summary
        function showMonthlySummary() {
            monthlySummaryList.innerHTML = '';
            
            // Group orders by month
            const monthlyOrders = {};
            orders.forEach(order => {
                const date = new Date(order.timestamp || order.createdAt);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthName = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                
                if (!monthlyOrders[monthKey]) {
                    monthlyOrders[monthKey] = {
                        name: monthName,
                        revenue: 0,
                        orders: 0,
                        deliveryFees: 0
                    };
                }
                monthlyOrders[monthKey].revenue += order.total || 0;
                monthlyOrders[monthKey].orders += 1;
                monthlyOrders[monthKey].deliveryFees += order.deliveryFee || 0;
            });
            
            // Sort months descending
            const sortedMonths = Object.keys(monthlyOrders).sort().reverse();
            
            if (sortedMonths.length === 0) {
                monthlySummaryList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <h3>Nenhum pedido</h3>
                        <p>Os resumos mensais aparecerão aqui.</p>
                    </div>
                `;
                return;
            }
            
            sortedMonths.forEach(monthKey => {
                const month = monthlyOrders[monthKey];
                const averageOrder = month.orders > 0 ? month.revenue / month.orders : 0;
                
                const monthCard = document.createElement('div');
                monthCard.className = 'monthly-summary';
                monthCard.innerHTML = `
                    <div class="month-header">
                        <div class="month-name">${month.name}</div>
                        <div class="month-revenue">R$ ${month.revenue.toFixed(2).replace('.', ',')}</div>
                    </div>
                    
                    <div class="daily-orders">
                        <div class="daily-order">
                            <span>Total Pedidos:</span>
                            <span class="order-count">${month.orders}</span>
                        </div>
                        <div class="daily-order">
                            <span>Média por Pedido:</span>
                            <span class="order-amount">R$ ${averageOrder.toFixed(2).replace('.', ',')}</span>
                        </div>
                        <div class="daily-order">
                            <span>Taxas de Entrega:</span>
                            <span class="order-amount">R$ ${month.deliveryFees.toFixed(2).replace('.', ',')}</span>
                        </div>
                    </div>
                `;
                
                monthlySummaryList.appendChild(monthCard);
            });
        }

        // Show finance summary
        function showFinanceSummary() {
            // Update finance charts
            updateFinanceCharts();
        }

        // Update notification badge
        function updateNotificationBadge() {
            const newPreparingOrders = orders.filter(order => 
                order.deliveryStatus === 'preparing'
            ).length;
            
            if (newPreparingOrders > 0 && newPreparingOrders !== preparingOrdersCount) {
                ordersBadge.textContent = newPreparingOrders;
                ordersBadge.classList.remove('d-none');
            } else if (newPreparingOrders === 0) {
                ordersBadge.classList.add('d-none');
            }
            
            preparingOrdersCount = newPreparingOrders;
        }

        // Load orders without real-time listener
        async function loadOrdersWithoutListener() {
            try {
                const snapshot = await db.collection('orders').get();
                
                orders = [];
                snapshot.forEach(doc => {
                    const orderData = doc.data();
                    if (orderData.storeId === currentStoreId) {
                        orders.push({
                            id: doc.id,
                            ...orderData
                        });
                    }
                });
                
                orders.sort((a, b) => {
                    return new Date(b.timestamp || b.createdAt) - new Date(a.timestamp || a.createdAt);
                });
                
                updateDashboardStats();
                updateRecentOrders();
                updateAllOrders();
                updateNotificationBadge();
                updateFinanceData();
                
                if (currentScreen === 'finance') {
                    updateFinanceUI();
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                showNotification('Erro ao carregar pedidos.', 'error');
            }
        }

        // Load products for current store
        async function loadProducts() {
            try {
                const snapshot = await db.collection('stores').doc(currentStoreId).collection('products').get();
                
                products = [];
                snapshot.forEach(doc => {
                    products.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                updateProductsList();
            } catch (error) {
                console.error('Error loading products:', error);
                showNotification('Erro ao carregar produtos.', 'error');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Welcome modal
            goToConfigBtn.addEventListener('click', () => {
                welcomeModal.style.display = 'none';
                showScreen('config');
                navBtns.forEach(b => b.classList.remove('active'));
                document.querySelector('[data-screen="config"]').classList.add('active');
            });
            
            // WhatsApp notification modal
            cancelWhatsappBtn.addEventListener('click', () => {
                whatsappNotificationModal.style.display = 'none';
                whatsappNotificationType = null;
                whatsappNotificationData = null;
            });
            
            openWhatsappBtn.addEventListener('click', () => {
                openWhatsAppNotification();
            });
            
            confirmWhatsappBtn.addEventListener('click', () => {
                confirmWhatsAppNotification();
            });
            
            // Categories
            addCategoryBtn.addEventListener('click', addCategory);
            newCategoryName.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addCategory();
                }
            });
            
            // Logout - MODIFICAÇÃO AQUI: Adicionada limpeza de cache
            logoutBtn.addEventListener('click', async () => {
                try {
                    // Limpar todos os dados do localStorage
                    localStorage.clear();
                    
                    // Limpar todos os dados do sessionStorage
                    sessionStorage.clear();
                    
                    // Desconectar do Firebase
                    await auth.signOut();
                    
                    // Limpar variáveis locais
                    currentUser = null;
                    currentStoreId = null;
                    orders = [];
                    products = [];
                    
                    // Redirecionar para login
                    window.location.href = 'login.html';
                    
                } catch (error) {
                    console.error('Logout error:', error);
                    // Mesmo em caso de erro, limpar cache e redirecionar
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = 'login.html';
                }
            });
            
            // Logout blocked user - MODIFICAÇÃO AQUI: Adicionada limpeza de cache
            logoutBlockedBtn.addEventListener('click', async () => {
                try {
                    // Limpar todos os dados do localStorage
                    localStorage.clear();
                    
                    // Limpar todos os dados do sessionStorage
                    sessionStorage.clear();
                    
                    // Desconectar do Firebase
                    await auth.signOut();
                    
                    // Limpar variáveis locais
                    currentUser = null;
                    currentStoreId = null;
                    
                    // Redirecionar para login
                    window.location.href = 'login.html';
                    
                } catch (error) {
                    console.error('Logout error:', error);
                    // Mesmo em caso de erro, limpar cache e redirecionar
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = 'login.html';
                }
            });
            
            // Navigation
            navBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const screen = btn.getAttribute('data-screen');
                    showScreen(screen);
                    
                    navBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Reset badge when viewing orders
                    if (screen === 'orders') {
                        ordersBadge.classList.add('d-none');
                    }
                    
                    // Update finance UI if needed
                    if (screen === 'finance') {
                        updateFinanceUI();
                        updateFinanceCharts();
                    }
                    
                    // Load categories when viewing config screen
                    if (screen === 'config') {
                        loadCategories();
                    }
                });
            });
            
            // Copy link button
            copyLinkBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(customerLink)
                    .then(() => {
                        showNotification('Link copiado para a área de transferência!', 'success');
                    })
                    .catch(() => {
                        const textArea = document.createElement('textarea');
                        textArea.value = customerLink;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showNotification('Link copiado!', 'success');
                    });
            });
            
            // Open link button
            openLinkBtn.addEventListener('click', () => {
                if (customerLink) {
                    window.open(customerLink, '_blank');
                    showNotification('Link aberto em nova aba!', 'info');
                }
            });
            
            // Share link button
            shareLinkBtn.addEventListener('click', () => {
                if (navigator.share) {
                    navigator.share({
                        title: storeConfig.businessName || 'Minha Loja',
                        text: 'Acesse minha loja virtual:',
                        url: customerLink
                    });
                } else {
                    copyLinkBtn.click();
                }
            });
            
            // Expiry warning buttons
            renewPlanBtn.addEventListener('click', () => {
                expiryWarningModal.style.display = 'none';
                showRenewPaymentModal();
            });
            
            closeExpiryWarningBtn.addEventListener('click', () => {
                expiryWarningModal.style.display = 'none';
            });
            
            renewPlanBannerBtn.addEventListener('click', () => {
                showRenewPaymentModal();
            });
            
            // Finance tabs
            financeTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    financeTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    financeTab = tab.getAttribute('data-tab');
                    
                    // Hide all tab contents
                    document.querySelectorAll('.finance-tab-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    
                    // Show selected tab content
                    if (financeTab === 'all') {
                        document.getElementById('financeAllTab').style.display = 'block';
                        showAllPayments();
                    } else if (financeTab === 'monthly') {
                        document.getElementById('financeMonthlyTab').style.display = 'block';
                        showMonthlySummary();
                    } else if (financeTab === 'summary') {
                        document.getElementById('financeSummaryTab').style.display = 'block';
                        showFinanceSummary();
                    }
                });
            });
            
            // Status filter
            statusFilterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    statusFilterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    statusFilter = btn.getAttribute('data-status');
                    updateAllOrders();
                });
            });
            
            // Config form
            configForm.addEventListener('submit', saveStoreConfig);
            
            // Logo upload
            logoUploadArea.addEventListener('click', () => {
                configLogoUpload.click();
            });
            
            configLogoUpload.addEventListener('change', async (e) => {
                await handleImageUpload(e, (base64) => {
                    logoBase64 = base64;
                    configLogoPreview.src = base64;
                    configLogoPreview.style.display = 'block';
                    
                    // Atualizar os avatares após upload da logo
                    updateUserAvatar();
                    updateStoreAvatar();
                });
            });
            
            // Logo preview click for zoom
            configLogoPreview.addEventListener('click', () => {
                if (configLogoPreview.src) {
                    openImageZoom(configLogoPreview.src, 'Logo da Loja');
                }
            });
            
            // Theme selection
            themeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    themeOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    configTheme.value = option.getAttribute('data-theme');
                });
            });
            
            // Product image upload
            productImageUploadArea.addEventListener('click', () => {
                productImageUpload.click();
            });
            
            productImageUpload.addEventListener('change', async (e) => {
                await handleImageUpload(e, (base64) => {
                    productImageBase64 = base64;
                    productImagePreview.src = base64;
                    productImagePreview.style.display = 'block';
                });
            });
            
            // Product image preview click for zoom
            productImagePreview.addEventListener('click', () => {
                if (productImagePreview.src) {
                    openImageZoom(productImagePreview.src, 'Imagem do Produto');
                }
            });
            
            // Add product button
            addProductBtn.addEventListener('click', () => {
                openProductForm();
            });
            
            // Product form
            productForm.addEventListener('submit', saveProduct);
            cancelProductBtn.addEventListener('click', () => {
                closeProductForm();
            });
            
            // Renew payment
            submitRenewBtn.addEventListener('click', submitRenewalPayment);
            cancelRenewBtn.addEventListener('click', () => {
                renewPaymentModal.style.display = 'none';
                resetRenewReceipt();
            });
            
            closeRenewModal.addEventListener('click', () => {
                renewPaymentModal.style.display = 'none';
                resetRenewReceipt();
            });
            
            // Renew receipt upload
            renewReceiptUploadArea.addEventListener('click', () => {
                renewReceiptUpload.click();
            });
            
            renewReceiptUpload.addEventListener('change', async (e) => {
                await handleRenewReceiptUpload(e);
            });
            
            // Close modals
            closeOrderModal.addEventListener('click', () => {
                orderDetailsModal.style.display = 'none';
            });
            
            closeProductModal.addEventListener('click', () => {
                closeProductForm();
            });
            
            // Image zoom modal
            closeZoom.addEventListener('click', () => {
                imageZoomModal.style.display = 'none';
                resetZoom();
            });
            
            // Setup pinch-to-zoom for images
            setupPinchZoom();
            
            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === orderDetailsModal) {
                    orderDetailsModal.style.display = 'none';
                }
                if (e.target === productFormModal) {
                    closeProductForm();
                }
                if (e.target === imageZoomModal) {
                    imageZoomModal.style.display = 'none';
                    resetZoom();
                }
                if (e.target === expiryWarningModal) {
                    expiryWarningModal.style.display = 'none';
                }
                if (e.target === renewPaymentModal) {
                    renewPaymentModal.style.display = 'none';
                    resetRenewReceipt();
                }
                if (e.target === whatsappNotificationModal) {
                    whatsappNotificationModal.style.display = 'none';
                    whatsappNotificationType = null;
                    whatsappNotificationData = null;
                }
                if (e.target === blockModal) {
                    // Não permitir fechar o modal de bloqueio clicando fora
                    e.stopPropagation();
                }
            });
        }

        // Função para otimizar imagem
        async function optimizeImage(base64String, maxSizeKB = 600) {
            return new Promise((resolve) => {
                // Calcular tamanho atual
                const base64Data = base64String.split(',')[1] || base64String;
                const currentSizeKB = (base64Data.length * 0.75) / 1024;
                
                // Se já estiver abaixo do limite, retorna original
                if (currentSizeKB <= maxSizeKB) {
                    resolve(base64String);
                    return;
                }
                
                // Carregar imagem para redimensionar
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    let quality = 0.8;
                    
                    // Reduzir dimensões se necessário
                    const maxDimension = 1200;
                    if (width > maxDimension || height > maxDimension) {
                        if (width > height) {
                            height = (maxDimension / width) * height;
                            width = maxDimension;
                        } else {
                            width = (maxDimension / height) * width;
                            height = maxDimension;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Tentar diferentes qualidades até ficar abaixo do limite
                    const tryCompression = (currentQuality) => {
                        const compressedBase64 = canvas.toDataURL('image/jpeg', currentQuality);
                        const compressedData = compressedBase64.split(',')[1];
                        const compressedSizeKB = (compressedData.length * 0.75) / 1024;
                        
                        if (compressedSizeKB <= maxSizeKB || currentQuality <= 0.3) {
                            resolve(compressedBase64);
                        } else {
                            setTimeout(() => {
                                tryCompression(currentQuality * 0.8);
                            }, 0);
                        }
                    };
                    
                    tryCompression(quality);
                };
                
                img.onerror = function() {
                    // Em caso de erro, retorna a imagem original
                    resolve(base64String);
                };
                
                img.src = base64String;
            });
        }

        // Handle image upload with optimization
        async function handleImageUpload(e, callback) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Check file size (max 8MB)
            if (file.size > 8 * 1024 * 1024) {
                showNotification('A imagem deve ter no máximo 8MB.', 'error');
                e.target.value = '';
                return;
            }
            
            // Check file type
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
            if (!validTypes.includes(file.type)) {
                showNotification('Tipo de arquivo inválido. Use JPG ou PNG.', 'error');
                e.target.value = '';
                return;
            }
            
            // Get the upload area element
            const uploadArea = e.target.closest('.upload-area');
            if (uploadArea) {
                uploadArea.classList.add('uploading');
                uploadArea.innerHTML = `
                    <div class="upload-icon">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <div class="upload-text">Otimizando imagem...</div>
                `;
            }
            
            try {
                // Read file as base64
                const reader = new FileReader();
                reader.onload = async function(event) {
                    try {
                        const originalBase64 = event.target.result;
                        
                        // Otimizar imagem (reduz para menos de 600KB se necessário)
                        const optimizedBase64 = await optimizeImage(originalBase64, 600);
                        
                        // Call callback with optimized image
                        callback(optimizedBase64);
                        
                        showNotification('Imagem otimizada com sucesso!', 'success');
                    } catch (error) {
                        console.error('Error optimizing image:', error);
                        callback(event.target.result);
                        showNotification('Imagem carregada (sem otimização)', 'info');
                    }
                    
                    // Reset upload area
                    if (uploadArea) {
                        uploadArea.classList.remove('uploading');
                        uploadArea.innerHTML = `
                            <div class="upload-icon">
                                <i class="fas fa-image"></i>
                            </div>
                            <div class="upload-text">Clique para fazer upload</div>
                            <div class="upload-info">Tamanho máximo: 8MB</div>
                        `;
                    }
                };
                
                reader.onerror = function() {
                    showNotification('Erro ao carregar imagem.', 'error');
                    if (uploadArea) {
                        uploadArea.classList.remove('uploading');
                        uploadArea.innerHTML = `
                            <div class="upload-icon">
                                <i class="fas fa-image"></i>
                            </div>
                            <div class="upload-text">Clique para fazer upload</div>
                            <div class="upload-info">Tamanho máximo: 8MB</div>
                        `;
                    }
                };
                
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Error in handleImageUpload:', error);
                showNotification('Erro ao processar imagem.', 'error');
                if (uploadArea) {
                    uploadArea.classList.remove('uploading');
                    uploadArea.innerHTML = `
                        <div class="upload-icon">
                            <i class="fas fa-image"></i>
                        </div>
                        <div class="upload-text">Clique para fazer upload</div>
                        <div class="upload-info">Tamanho máximo: 8MB</div>
                    `;
                }
            }
        }

        // Show renew payment modal
        async function showRenewPaymentModal() {
            try {
                // Load system config for PIX key
                const configDoc = await db.collection('systemConfig').doc('paymentSettings').get();
                if (configDoc.exists) {
                    const configData = configDoc.data();
                    renewPixKeyDisplay.textContent = configData.pixKey || 'chave-pix@empresa.com';
                    renewPlanPrice.textContent = `R$ ${(configData.monthlyPlanPrice || 99.00).toFixed(2).replace('.', ',')}`;
                }
                
                renewPaymentModal.style.display = 'flex';
                resetRenewReceipt();
                
            } catch (error) {
                console.error('Error loading renewal data:', error);
                showNotification('Erro ao carregar informações de pagamento.', 'error');
            }
        }

        // Reset renew receipt
        function resetRenewReceipt() {
            renewReceiptBase64 = '';
            renewReceiptType = '';
            renewReceiptFileName = '';
            renewReceiptImagePreview.style.display = 'none';
            renewReceiptPdfPreview.style.display = 'none';
            renewReceiptUpload.value = '';
            renewPaymentNotes.value = '';
        }

        // Handle renew receipt upload with image optimization
        async function handleRenewReceiptUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Check file size (max 8MB)
            if (file.size > 8 * 1024 * 1024) {
                showNotification('O arquivo deve ter no máximo 8MB.', 'error');
                renewReceiptUpload.value = '';
                return;
            }
            
            // Check file type
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                showNotification('Tipo de arquivo inválido. Use JPG, PNG ou PDF.', 'error');
                renewReceiptUpload.value = '';
                return;
            }
            
            // Show loading
            renewReceiptUploadArea.classList.add('uploading');
            renewReceiptUploadArea.innerHTML = `
                <div class="upload-icon">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="upload-text">Processando arquivo...</div>
            `;
            
            try {
                const reader = new FileReader();
                reader.onload = async function(event) {
                    let base64 = event.target.result;
                    renewReceiptType = file.type.includes('pdf') ? 'pdf' : 'image';
                    renewReceiptFileName = file.name;
                    
                    // Se for imagem, otimizar
                    if (renewReceiptType === 'image') {
                        try {
                            base64 = await optimizeImage(base64, 600);
                        } catch (error) {
                            console.error('Error optimizing receipt image:', error);
                            // Continua com a imagem original se houver erro
                        }
                    }
                    
                    renewReceiptBase64 = base64;
                    
                    // Show preview
                    if (renewReceiptType === 'pdf') {
                        renewReceiptPdfPreview.style.display = 'flex';
                        renewPdfFileName.textContent = file.name;
                        renewReceiptImagePreview.style.display = 'none';
                    } else {
                        renewReceiptImagePreview.src = renewReceiptBase64;
                        renewReceiptImagePreview.style.display = 'block';
                        renewReceiptPdfPreview.style.display = 'none';
                    }
                    
                    // Reset upload area
                    renewReceiptUploadArea.classList.remove('uploading');
                    renewReceiptUploadArea.innerHTML = `
                        <div class="upload-icon">
                            <i class="fas fa-file-upload"></i>
                        </div>
                        <div class="upload-text">Clique para fazer upload</div>
                        <div class="upload-info">Aceitamos imagens (JPG, PNG) ou PDF - Tamanho máximo: 8MB</div>
                        <div class="file-types">
                            <span class="file-type-badge">JPG</span>
                            <span class="file-type-badge">PNG</span>
                            <span class="file-type-badge">PDF</span>
                        </div>
                    `;
                };
                
                reader.onerror = function() {
                    showNotification('Erro ao carregar arquivo.', 'error');
                    renewReceiptUploadArea.classList.remove('uploading');
                    renewReceiptUploadArea.innerHTML = `
                        <div class="upload-icon">
                            <i class="fas fa-file-upload"></i>
                        </div>
                        <div class="upload-text">Clique para fazer upload</div>
                        <div class="upload-info">Aceitamos imagens (JPG, PNG) ou PDF - Tamanho máximo: 8MB</div>
                        <div class="file-types">
                            <span class="file-type-badge">JPG</span>
                            <span class="file-type-badge">PNG</span>
                            <span class="file-type-badge">PDF</span>
                        </div>
                    `;
                };
                
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Error in handleRenewReceiptUpload:', error);
                showNotification('Erro ao processar arquivo.', 'error');
                renewReceiptUploadArea.classList.remove('uploading');
                renewReceiptUploadArea.innerHTML = `
                    <div class="upload-icon">
                        <i class="fas fa-file-upload"></i>
                    </div>
                    <div class="upload-text">Clique para fazer upload</div>
                    <div class="upload-info">Aceitamos imagens (JPG, PNG) ou PDF - Tamanho máximo: 8MB</div>
                    <div class="file-types">
                        <span class="file-type-badge">JPG</span>
                        <span class="file-type-badge">PNG</span>
                        <span class="file-type-badge">PDF</span>
                    </div>
                `;
            }
        }

        // Show WhatsApp notification modal
        function showWhatsAppNotification(type, data) {
            whatsappNotificationType = type;
            whatsappNotificationData = data;
            
            let message = '';
            let title = '';
            
            if (type === 'renewal') {
                title = 'Renovação Concluída';
                message = `✅ *RENOVAÇÃO CONFIRMADA!* ✅\n\n`;
                message += `Olá, *${data.userName || 'Cliente'}*!\n\n`;
                message += `Sua renovação do plano Venda+ foi *confirmada com sucesso*! 🎉\n\n`;
                message += `📅 *Nova data de vencimento:* ${formatDate(data.newExpiryDate)}\n`;
                message += `💰 *Valor pago:* R$ ${data.amount.toFixed(2)}\n\n`;
                message += `Seu acesso ao sistema está *garantido por mais 30 dias*.\n\n`;
                message += `Agradecemos pela confiança! ✨\n\n`;
                message += `*Equipe Venda+*`;
            }
            
            whatsappMessageContent.textContent = message;
            whatsappNotificationModal.style.display = 'flex';
        }

        // Open WhatsApp with notification message
        function openWhatsAppNotification() {
            if (!whatsappNotificationData || !whatsappNotificationType) return;
            
            let phoneNumber = '';
            let message = '';
            
            if (whatsappNotificationType === 'renewal') {
                // Para renovação, o WhatsApp é enviado para o próprio cliente
                phoneNumber = storeConfig.whatsappNumber || currentUser.phone;
                
                message = `✅ *RENOVAÇÃO CONFIRMADA!* ✅\n\n`;
                message += `Olá, *${whatsappNotificationData.userName || 'Cliente'}*!\n\n`;
                message += `Sua renovação do plano Venda+ foi *confirmada com sucesso*! 🎉\n\n`;
                message += `📅 *Nova data de vencimento:* ${formatDate(whatsappNotificationData.newExpiryDate)}\n`;
                message += `💰 *Valor pago:* R$ ${whatsappNotificationData.amount.toFixed(2)}\n\n`;
                message += `Seu acesso ao sistema está *garantido por mais 30 dias*.\n\n`;
                message += `Agradecemos pela confiança! ✨\n\n`;
                message += `*Equipe Venda+*`;
            }
            
            if (phoneNumber) {
                const whatsappUrl = `https://wa.me/${phoneNumber.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            } else {
                showNotification('Número do WhatsApp não configurado.', 'error');
            }
        }

        // Confirm WhatsApp notification was sent
        async function confirmWhatsAppNotification() {
            try {
                if (whatsappNotificationType === 'renewal') {
                    // Atualizar o status do usuário para renovado
                    const newExpiryDate = new Date();
                    newExpiryDate.setDate(newExpiryDate.getDate() + 30);
                    
                    await db.collection('users').doc(currentStoreId).update({
                        renewalStatus: 'completed',
                        expiryDate: newExpiryDate.toISOString(),
                        lastRenewalDate: new Date().toISOString()
                    });
                    
                    // Atualizar dados locais do usuário
                    currentUser.expiryDate = newExpiryDate.toISOString();
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    showNotification('Renovação confirmada com sucesso!', 'success');
                    
                    // Atualizar banner de vencimento
                    expiryWarningBanner.classList.add('d-none');
                }
                
                whatsappNotificationModal.style.display = 'none';
                whatsappNotificationType = null;
                whatsappNotificationData = null;
                
            } catch (error) {
                console.error('Error confirming WhatsApp notification:', error);
                showNotification('Erro ao confirmar notificação.', 'error');
            }
        }

        // Submit renewal payment - CORRIGIDO: Agora salva na coleção 'payments' em vez de 'renewalPayments'
        async function submitRenewalPayment() {
            if (!renewReceiptBase64) {
                showNotification('Por favor, envie o comprovante do pagamento.', 'error');
                return;
            }
            
            try {
                submitRenewBtn.innerHTML = '<div class="loading"></div>';
                submitRenewBtn.disabled = true;
                
                // Load system config for amount
                const configDoc = await db.collection('systemConfig').doc('paymentSettings').get();
                const configData = configDoc.exists ? configDoc.data() : {};
                const amount = configData.monthlyPlanPrice || 99.00;
                
                // Calculate new expiry date
                const newExpiryDate = new Date();
                newExpiryDate.setDate(newExpiryDate.getDate() + 30);
                
                // CORREÇÃO: Criar registro na coleção 'payments' em vez de 'renewalPayments'
                const paymentData = {
                    userId: currentStoreId,
                    userName: currentUser.storeName,
                    storeName: currentUser.storeName,
                    userEmail: currentUser.email,
                    userPhone: storeConfig.contactPhone || currentUser.phone || '',
                    status: 'pending', // Status inicial conforme estrutura
                    plan: 'monthly',
                    planDays: 30,
                    amount: amount,
                    receiptBase64: renewReceiptBase64,
                    receiptType: renewReceiptType,
                    receiptFileName: renewReceiptFileName,
                    createdAt: new Date().toISOString(),
                    type: 'renewal',
                    notes: renewPaymentNotes.value || '',
                    // Campos adicionais para controle interno
                    paymentFor: 'plan_renewal',
                    originalExpiryDate: currentUser.expiryDate || new Date().toISOString(),
                    newExpiryDate: newExpiryDate.toISOString()
                };
                
                await db.collection('payments').add(paymentData);
                
                // Atualizar status do usuário para aguardando renovação
                await db.collection('users').doc(currentStoreId).update({
                    renewalStatus: 'pending',
                    lastRenewalRequest: new Date().toISOString()
                });
                
                // Fechar modal de renovação
                renewPaymentModal.style.display = 'none';
                resetRenewReceipt();
                
                // Mostrar modal de WhatsApp para notificar o cliente
                showWhatsAppNotification('renewal', {
                    userName: currentUser.storeName,
                    amount: amount,
                    newExpiryDate: newExpiryDate.toISOString()
                });
                
            } catch (error) {
                console.error('Error submitting renewal payment:', error);
                showNotification('Erro ao enviar comprovante.', 'error');
            } finally {
                submitRenewBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Concluir Renovação';
                submitRenewBtn.disabled = false;
            }
        }

        // Setup pinch-to-zoom for images
        function setupPinchZoom() {
            zoomedImage.addEventListener('touchstart', handleTouchStart);
            zoomedImage.addEventListener('touchmove', handleTouchMove);
            zoomedImage.addEventListener('touchend', handleTouchEnd);
        }

        // Handle touch start for pinch zoom
        function handleTouchStart(e) {
            if (e.touches.length === 2) {
                lastTouchDistance = getTouchDistance(e.touches[0], e.touches[1]);
            }
        }

        // Handle touch move for pinch zoom
        function handleTouchMove(e) {
            if (e.touches.length === 2) {
                e.preventDefault();
                const currentDistance = getTouchDistance(e.touches[0], e.touches[1]);
                
                if (lastTouchDistance) {
                    const scaleChange = currentDistance / lastTouchDistance;
                    const currentTransform = zoomedImage.style.transform || 'scale(1)';
                    const currentScale = parseFloat(currentTransform.match(/scale\(([^)]+)\)/)?.[1] || 1);
                    const newScale = Math.max(0.5, Math.min(5, currentScale * scaleChange));
                    
                    zoomedImage.style.transform = `scale(${newScale})`;
                }
                
                lastTouchDistance = currentDistance;
            }
        }

        // Handle touch end for pinch zoom
        function handleTouchEnd(e) {
            lastTouchDistance = null;
        }

        // Get distance between two touch points
        function getTouchDistance(touch1, touch2) {
            const dx = touch1.clientX - touch2.clientX;
            const dy = touch1.clientY - touch2.clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // Reset zoom
        function resetZoom() {
            zoomedImage.style.transform = 'scale(1)';
            lastTouchDistance = null;
        }

        // Open image zoom modal
        function openImageZoom(imageSrc, altText) {
            zoomedImage.src = imageSrc;
            zoomedImage.alt = altText;
            resetZoom();
            imageZoomModal.style.display = 'flex';
        }

        // Show screen
        function showScreen(screen) {
            currentScreen = screen;
            
            screens.forEach(s => {
                s.style.display = 'none';
            });
            
            document.getElementById(`${screen}Screen`).style.display = 'block';
            
            // Record activity
            recordUserActivity(`view_${screen}`);
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            const preparingOrders = orders.filter(order => 
                order.deliveryStatus === 'preparing'
            ).length;
            
            const confirmedOrders = orders.filter(order => 
                order.deliveryStatus === 'confirmed'
            ).length;
            
            const deliveringOrders = orders.filter(order => 
                order.deliveryStatus === 'delivering'
            ).length;
            
            const deliveredOrders = orders.filter(order => 
                order.deliveryStatus === 'delivered'
            ).length;
            
            const totalOrders = orders.length;
            
            const totalRevenue = orders.reduce((sum, order) => {
                return sum + (order.total || 0);
            }, 0);
            
            preparingOrdersCountElement.textContent = preparingOrders;
            confirmedOrdersCountElement.textContent = confirmedOrders;
            deliveringOrdersCountElement.textContent = deliveringOrders;
            deliveredOrdersCountElement.textContent = deliveredOrders;
            totalOrdersCountElement.textContent = totalOrders;
            totalRevenueElement.textContent = `R$ ${totalRevenue.toFixed(0)}`;
            deliveryFeeStat.textContent = `R$ ${(storeConfig.deliveryFee || 0).toFixed(2)}`;
            
            // Update visits
            totalVisitsElement.textContent = storeVisits;
            totalVisitsConfig.textContent = storeVisits;
        }

        // Update recent orders
        function updateRecentOrders() {
            recentOrdersList.innerHTML = '';
            
            const recentOrders = orders.slice(0, 5);
            
            if (recentOrders.length === 0) {
                recentOrdersEmpty.style.display = 'block';
                return;
            }
            
            recentOrdersEmpty.style.display = 'none';
            
            recentOrders.forEach(order => {
                const orderCard = createOrderCard(order);
                recentOrdersList.appendChild(orderCard);
            });
        }

        // Update all orders with filter
        function updateAllOrders() {
            allOrdersList.innerHTML = '';
            
            let filteredOrders = orders;
            
            if (statusFilter !== 'all') {
                filteredOrders = orders.filter(order => {
                    return order.deliveryStatus === statusFilter;
                });
            }
            
            if (filteredOrders.length === 0) {
                allOrdersEmpty.style.display = 'block';
                return;
            }
            
            allOrdersEmpty.style.display = 'none';
            
            filteredOrders.forEach(order => {
                const orderCard = createOrderCard(order);
                allOrdersList.appendChild(orderCard);
            });
        }

        // Create order card
        function createOrderCard(order) {
            const orderCard = document.createElement('div');
            orderCard.className = 'order-card';
            
            const status = order.deliveryStatus || 'preparing';
            const statusText = getDeliveryStatusText(status);
            const statusClass = getDeliveryStatusClass(status);
            
            const subtotal = order.subtotal || 0;
            const deliveryFee = order.deliveryFee || 0;
            const total = order.total || subtotal + deliveryFee;
            
            orderCard.innerHTML = `
                <div class="order-header">
                    <div class="order-id">#${order.id.substring(0, 8)}</div>
                    <div class="order-date">${formatDate(order.timestamp || order.createdAt)}</div>
                </div>
                
                <div class="order-customer">${order.customerName}</div>
                <div class="order-phone">${formatPhone(order.customerPhone)}</div>
                
                <div class="order-info">
                    <span class="order-status ${statusClass}">${statusText}</span>
                    <div class="order-total">R$ ${total.toFixed(2).replace('.', ',')}</div>
                </div>
                
                <div class="mb-1">
                    <small><strong>Taxa de entrega:</strong> R$ ${deliveryFee.toFixed(2).replace('.', ',')}</small>
                </div>
                
                <div class="order-actions">
                    <button class="action-btn view-btn" data-id="${order.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                    
                    ${status === 'preparing' ? `
                        <button class="action-btn confirm-btn" data-id="${order.id}" data-action="confirmed">
                            <i class="fas fa-check"></i>
                        </button>
                    ` : ''}
                    
                    ${status === 'confirmed' ? `
                        <button class="action-btn confirm-btn" data-id="${order.id}" data-action="delivering">
                            <i class="fas fa-motorcycle"></i>
                        </button>
                    ` : ''}
                    
                    ${status === 'delivering' ? `
                        <button class="action-btn confirm-btn" data-id="${order.id}" data-action="delivered">
                            <i class="fas fa-check-circle"></i>
                        </button>
                    ` : ''}
                    
                    <button class="action-btn btn-whatsapp" data-id="${order.id}">
                        <i class="fab fa-whatsapp"></i>
                    </button>
                </div>
            `;
            
            // Add event listeners
            orderCard.querySelector('.view-btn').addEventListener('click', (e) => {
                const orderId = e.currentTarget.getAttribute('data-id');
                viewOrderDetails(orderId);
            });
            
            const confirmBtn = orderCard.querySelector('.confirm-btn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', (e) => {
                    const orderId = e.currentTarget.getAttribute('data-id');
                    const action = e.currentTarget.getAttribute('data-action') || 'confirmed';
                    updateOrderStatus(orderId, action);
                });
            }
            
            orderCard.querySelector('.btn-whatsapp').addEventListener('click', (e) => {
                const orderId = e.currentTarget.getAttribute('data-id');
                openOrderWhatsApp(orderId);
            });
            
            return orderCard;
        }

        // Update products list
        function updateProductsList() {
            productsList.innerHTML = '';
            
            if (products.length === 0) {
                productsEmpty.style.display = 'block';
                return;
            }
            
            productsEmpty.style.display = 'none';
            
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                
                productCard.innerHTML = `
                    <div class="product-image">
                        ${product.imageBase64 ? 
                            `<img src="${product.imageBase64}" alt="${product.name}" style="cursor: pointer;">` : 
                            `<i class="fas ${product.icon || 'fa-box'}"></i>`
                        }
                    </div>
                    
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">R$ ${product.price.toFixed(2).replace('.', ',')}</div>
                    </div>
                    
                    <div class="product-actions">
                        <button class="action-btn view-btn" data-id="${product.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn reject-btn" data-id="${product.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                productsList.appendChild(productCard);
            });
            
            // Add event listeners
            productsList.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const productId = e.currentTarget.getAttribute('data-id');
                    editProduct(productId);
                });
            });
            
            productsList.querySelectorAll('.reject-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const productId = e.currentTarget.getAttribute('data-id');
                    deleteProduct(productId);
                });
            });
            
            // Add click event for product images
            productsList.querySelectorAll('.product-image img').forEach(img => {
                img.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const productId = e.target.closest('.product-card').querySelector('.view-btn').getAttribute('data-id');
                    const product = products.find(p => p.id === productId);
                    if (product && product.imageBase64) {
                        openImageZoom(product.imageBase64, product.name);
                    }
                });
            });
        }

        // View order details
        function viewOrderDetails(orderId) {
            selectedOrder = orders.find(order => order.id === orderId);
            
            if (!selectedOrder) return;
            
            const status = selectedOrder.deliveryStatus || 'preparing';
            const statusText = getDeliveryStatusText(status);
            
            const subtotal = selectedOrder.subtotal || 0;
            const deliveryFee = selectedOrder.deliveryFee || 0;
            const total = selectedOrder.total || subtotal + deliveryFee;
            
            let itemsHTML = '';
            if (selectedOrder.items && selectedOrder.items.length > 0) {
                selectedOrder.items.forEach(item => {
                    const itemTotal = (item.price || 0) * (item.quantity || 1);
                    itemsHTML += `
                        <div class="d-flex justify-between mb-1">
                            <span>${item.quantity}x ${item.name}</span>
                            <span>R$ ${itemTotal.toFixed(2).replace('.', ',')}</span>
                        </div>
                    `;
                });
            }
            
            // PDF preview HTML
            let receiptHTML = '';
            if (selectedOrder.receiptBase64) {
                if (selectedOrder.receiptType === 'pdf') {
                    receiptHTML = `
                        <div class="pdf-preview d-flex" onclick="downloadReceipt('${orderId}')">
                            <i class="fas fa-file-pdf upload-icon" style="font-size: 3rem; color: #f44336;"></i>
                            <div class="upload-text">${selectedOrder.receiptFileName || 'comprovante.pdf'}</div>
                            <div class="upload-info">Clique para baixar o PDF</div>
                        </div>
                    `;
                } else {
                    receiptHTML = `
                        <img src="${selectedOrder.receiptBase64}" class="image-preview d-block" style="height: 150px; cursor: pointer;" onclick="openImageZoom('${selectedOrder.receiptBase64}', 'Comprovante PIX')">
                    `;
                }
            }
            
            const content = `
                <div class="mb-3">
                    <h3 class="mb-2">Informações do Cliente</h3>
                    <div class="d-flex justify-between mb-1">
                        <strong>Nome:</strong>
                        <span>${selectedOrder.customerName || 'Não informado'}</span>
                    </div>
                    <div class="d-flex justify-between mb-1">
                        <strong>Telefone:</strong>
                        <span>${formatPhone(selectedOrder.customerPhone) || 'Não informado'}</span>
                    </div>
                    <div class="mb-1">
                        <strong>Endereço:</strong>
                        <div>${selectedOrder.customerAddress || 'Não informado'}</div>
                    </div>
                    ${selectedOrder.notes ? `
                        <div class="mb-1">
                            <strong>Observações:</strong>
                            <div>${selectedOrder.notes}</div>
                        </div>
                    ` : ''}
                </div>
                
                <div class="mb-3">
                    <h3 class="mb-2">Detalhes do Pedido</h3>
                    <div class="d-flex justify-between mb-1">
                        <strong>ID:</strong>
                        <span>#${selectedOrder.id.substring(0, 8)}</span>
                    </div>
                    <div class="d-flex justify-between mb-1">
                        <strong>Data:</strong>
                        <span>${formatDateTime(selectedOrder.timestamp || selectedOrder.createdAt)}</span>
                    </div>
                    <div class="d-flex justify-between mb-1">
                        <strong>Pagamento:</strong>
                        <span>${selectedOrder.paymentMethod === 'money' ? 'Dinheiro' : 'PIX'}</span>
                    </div>
                    <div class="d-flex justify-between mb-1">
                        <strong>Subtotal:</strong>
                        <span>R$ ${subtotal.toFixed(2).replace('.', ',')}</span>
                    </div>
                    <div class="d-flex justify-between mb-1">
                        <strong>Taxa de Entrega:</strong>
                        <span>R$ ${deliveryFee.toFixed(2).replace('.', ',')}</span>
                    </div>
                    <div class="d-flex justify-between mb-1">
                        <strong>Total:</strong>
                        <span class="order-total">R$ ${total.toFixed(2).replace('.', ',')}</span>
                    </div>
                    <div class="d-flex justify-between mb-1">
                        <strong>Status:</strong>
                        <span class="order-status ${getDeliveryStatusClass(status)}">${statusText}</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h3 class="mb-2">Itens do Pedido</h3>
                    ${itemsHTML || '<p>Nenhum item</p>'}
                </div>
                
                ${selectedOrder.receiptBase64 ? `
                    <div class="mb-3">
                        <h3 class="mb-2">Comprovante PIX</h3>
                        ${receiptHTML}
                    </div>
                ` : ''}
                
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-primary flex-1" id="updateStatusBtn" data-id="${selectedOrder.id}">
                        Atualizar Status
                    </button>
                    <button class="btn btn-secondary flex-1" id="closeDetailsBtn">
                        Fechar
                    </button>
                </div>
            `;
            
            document.getElementById('orderDetailsContent').innerHTML = content;
            
            document.getElementById('updateStatusBtn').addEventListener('click', () => {
                showStatusUpdateOptions(selectedOrder.id, status);
            });
            
            document.getElementById('closeDetailsBtn').addEventListener('click', () => {
                orderDetailsModal.style.display = 'none';
            });
            
            // Atualizar a função downloadReceipt no escopo global
            window.downloadReceipt = function(orderId) {
                const order = orders.find(o => o.id === orderId);
                if (order && order.receiptBase64) {
                    const link = document.createElement('a');
                    link.href = order.receiptBase64;
                    link.download = order.receiptFileName || 'comprovante.pdf';
                    link.click();
                }
            };
            
            orderDetailsModal.style.display = 'block';
        }

        // Show status update options
        function showStatusUpdateOptions(orderId, currentStatus) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            let optionsHTML = '<h3 class="mb-2">Atualizar Status:</h3>';
            const statusOptions = ['preparing', 'confirmed', 'delivering', 'delivered'];
            
            statusOptions.forEach(status => {
                if (status !== currentStatus) {
                    const statusText = getDeliveryStatusText(status);
                    optionsHTML += `
                        <button class="btn btn-primary btn-block mb-1" data-action="${status}">
                            ${statusText}
                        </button>
                    `;
                }
            });
            
            optionsHTML += `
                <button class="btn btn-secondary btn-block mt-2" id="backToDetailsBtn">
                    Voltar
                </button>
            `;
            
            document.getElementById('orderDetailsContent').innerHTML = optionsHTML;
            
            document.querySelectorAll('[data-action]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = e.currentTarget.getAttribute('data-action');
                    updateOrderStatus(orderId, action);
                    orderDetailsModal.style.display = 'none';
                });
            });
            
            document.getElementById('backToDetailsBtn').addEventListener('click', () => {
                viewOrderDetails(orderId);
            });
        }

        // Update order status
        async function updateOrderStatus(orderId, status) {
            try {
                await db.collection('orders').doc(orderId).update({
                    deliveryStatus: status,
                    status: status === 'delivered' ? 'completed' : 
                           status === 'confirmed' ? 'confirmed' : 'pending_confirmation',
                    updatedAt: new Date().toISOString()
                });
                
                showNotification(`Status atualizado para: ${getDeliveryStatusText(status)}`, 'success');
                
                const order = orders.find(o => o.id === orderId);
                if (order) {
                    sendStatusUpdateWhatsApp(orderId, order, status);
                }
                
            } catch (error) {
                console.error('Error updating order:', error);
                showNotification('Erro ao atualizar status.', 'error');
            }
        }

        // Open WhatsApp for order
        function openOrderWhatsApp(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const phoneNumber = storeConfig.whatsappNumber || "(11) 99999-9999";
            const message = generateOrderMessage(order);
            const whatsappUrl = `https://wa.me/${order.customerPhone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappUrl, '_blank');
        }

        // Send status update via WhatsApp
        function sendStatusUpdateWhatsApp(orderId, order, newStatus) {
            const phoneNumber = storeConfig.whatsappNumber || "(11) 99999-9999";
            
            let message = `📱 *ATUALIZAÇÃO DE STATUS* 📱\n\n`;
            message += `*Pedido:* #${orderId.substring(0, 8)}\n`;
            message += `*Cliente:* ${order.customerName}\n`;
            message += `*Novo Status:* ${getDeliveryStatusText(newStatus)}\n\n`;
            
            if (newStatus === 'delivering') {
                message += `Seu pedido saiu para entrega! 🛵\n`;
                message += `Em breve estará aí.\n\n`;
            } else if (newStatus === 'delivered') {
                message += `Seu pedido foi entregue! ✅\n`;
                message += `Agradecemos pela preferência!\n\n`;
            } else if (newStatus === 'confirmed') {
                message += `Seu pedido foi confirmado! ✅\n`;
                message += `Estamos preparando sua entrega.\n\n`;
            } else if (newStatus === 'preparing') {
                message += `Seu pedido está sendo preparado! 👨‍🍳\n`;
                message += `Em breve atualizaremos o status.\n\n`;
            }
            
            message += `_Qualquer dúvida, entre em contato._`;
            
            const whatsappUrl = `https://wa.me/${order.customerPhone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Generate order message for WhatsApp
        function generateOrderMessage(order) {
            const status = order.deliveryStatus || 'preparing';
            const subtotal = order.subtotal || 0;
            const deliveryFee = order.deliveryFee || 0;
            const total = order.total || subtotal + deliveryFee;
            
            let message = `📱 *DETALHES DO PEDIDO* 📱\n\n`;
            message += `*Pedido:* #${order.id.substring(0, 8)}\n`;
            message += `*Status:* ${getDeliveryStatusText(status)}\n`;
            message += `*Cliente:* ${order.customerName}\n`;
            message += `*Endereço:* ${order.customerAddress}\n`;
            message += `*Telefone:* ${order.customerPhone}\n\n`;
            
            message += `*ITENS DO PEDIDO:*\n`;
            if (order.items && order.items.length > 0) {
                order.items.forEach(item => {
                    const itemTotal = (item.price || 0) * (item.quantity || 1);
                    message += `• ${item.quantity}x ${item.name} - R$ ${itemTotal.toFixed(2).replace('.', ',')}\n`;
                });
            }
            
            message += `\n*Subtotal:* R$ ${subtotal.toFixed(2).replace('.', ',')}\n`;
            message += `*Taxa de Entrega:* R$ ${deliveryFee.toFixed(2).replace('.', ',')}\n`;
            message += `*TOTAL: R$ ${total.toFixed(2).replace('.', ',')}*\n`;
            message += `*Pagamento:* ${order.paymentMethod === 'money' ? 'Dinheiro' : 'PIX'}\n\n`;
            
            if (order.notes) {
                message += `*Observações:* ${order.notes}\n\n`;
            }
            
            message += `Obrigado pela preferência! 🛒✨`;
            
            return message;
        }

        // Open product form
        function openProductForm() {
            productModalTitle.textContent = 'Novo Produto';
            productForm.reset();
            productIdInput.value = '';
            productImagePreview.style.display = 'none';
            productImageBase64 = '';
            productActive.checked = true;
            
            // Atualizar as opções de categoria
            updateProductCategorySelect();
            
            productFormModal.style.display = 'block';
        }

        // Edit product
        function editProduct(productId) {
            selectedProduct = products.find(p => p.id === productId);
            
            if (!selectedProduct) return;
            
            productModalTitle.textContent = 'Editar Produto';
            productIdInput.value = selectedProduct.id;
            productName.value = selectedProduct.name;
            productDescription.value = selectedProduct.description;
            productPrice.value = selectedProduct.price;
            
            // Set category
            productCategory.value = selectedProduct.category || '';
            
            productActive.checked = selectedProduct.active !== false;
            productImageBase64 = selectedProduct.imageBase64 || '';
            
            if (selectedProduct.imageBase64) {
                productImagePreview.src = selectedProduct.imageBase64;
                productImagePreview.style.display = 'block';
            } else {
                productImagePreview.style.display = 'none';
            }
            
            // Atualizar as opções de categoria
            updateProductCategorySelect();
            
            productFormModal.style.display = 'block';
        }

        // Close product form
        function closeProductForm() {
            productFormModal.style.display = 'none';
            selectedProduct = null;
            productImageBase64 = '';
        }

        // Save product
        async function saveProduct(e) {
            e.preventDefault();
            
            const productData = {
                name: productName.value,
                description: productDescription.value,
                price: parseFloat(productPrice.value),
                category: productCategory.value,
                active: productActive.checked,
                updatedAt: new Date().toISOString(),
                storeId: currentStoreId
            };
            
            if (productImageBase64) {
                productData.imageBase64 = productImageBase64;
            }
            
            try {
                if (productIdInput.value) {
                    await db.collection('stores').doc(currentStoreId).collection('products').doc(productIdInput.value).update(productData);
                    showNotification('Produto atualizado!', 'success');
                } else {
                    productData.createdAt = new Date().toISOString();
                    await db.collection('stores').doc(currentStoreId).collection('products').add(productData);
                    showNotification('Produto adicionado!', 'success');
                }
                
                closeProductForm();
                loadProducts();
            } catch (error) {
                console.error('Error saving product:', error);
                showNotification('Erro ao salvar produto.', 'error');
            }
        }

        // Delete product
        async function deleteProduct(productId) {
            if (!confirm('Excluir este produto?')) return;
            
            try {
                await db.collection('stores').doc(currentStoreId).collection('products').doc(productId).delete();
                showNotification('Produto excluído!', 'success');
                loadProducts();
            } catch (error) {
                console.error('Error deleting product:', error);
                showNotification('Erro ao excluir produto.', 'error');
            }
        }

        // Save store configuration
        async function saveStoreConfig(e) {
            e.preventDefault();
            
            // Format phone numbers
            const whatsappNumber = configWhatsApp.value;
            const contactPhone = configContactPhone.value;
            const deliveryFee = parseFloat(configDeliveryFee.value) || 0;
            
            const configData = {
                businessName: configBusinessName.value,
                whatsappNumber: whatsappNumber,
                pixKey: configPixKey.value,
                contactPhone: contactPhone,
                productsTitle: configProductsTitle.value,
                deliveryFee: deliveryFee,
                theme: configTheme.value,
                updatedAt: new Date().toISOString()
            };
            
            if (logoBase64) {
                configData.logoBase64 = logoBase64;
            }
            
            try {
                await db.collection('stores').doc(currentStoreId).set(configData, { merge: true });
                storeConfig = configData;
                
                // Atualizar usuário para marcar como configurado
                await db.collection('users').doc(currentStoreId).update({
                    storeName: configBusinessName.value,
                    configCompleted: true
                });
                
                currentUser.storeName = configBusinessName.value;
                userConfigCompleted = true;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Atualizar os avatares após salvar configurações
                updateUserAvatar();
                updateStoreAvatar();
                
                storeNameDisplay.textContent = configBusinessName.value;
                adminStoreName.textContent = `Venda+`;
                
                // Update delivery fee stat
                deliveryFeeStat.textContent = `R$ ${deliveryFee.toFixed(2)}`;
                
                showNotification('Configurações salvas!', 'success');
                
                // Fechar modal de boas-vindas se estiver aberto
                welcomeModal.style.display = 'none';
                
            } catch (error) {
                console.error('Error saving store config:', error);
                showNotification('Erro ao salvar configurações.', 'error');
            }
        }

        // Helper functions
        function formatDate(dateString) {
            if (!dateString) return 'Data não informada';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }
        
        function formatDateTime(dateString) {
            if (!dateString) return 'Data/hora não informada';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }
        
        function formatPhone(phone) {
            if (!phone) return '';
            // Remove all non-numeric characters
            const cleaned = phone.replace(/\D/g, '');
            // Format as (00) 00000-0000
            if (cleaned.length === 11) {
                return `(${cleaned.substring(0,2)}) ${cleaned.substring(2,7)}-${cleaned.substring(7)}`;
            }
            return phone;
        }

        function getDeliveryStatusText(status) {
            switch(status) {
                case 'preparing': return 'Preparando';
                case 'confirmed': return 'Confirmado';
                case 'delivering': return 'Saiu para entrega';
                case 'delivered': return 'Entregue';
                case 'rejected': return 'Rejeitado';
                default: return 'Preparando';
            }
        }

        function getDeliveryStatusClass(status) {
            switch(status) {
                case 'preparing': return 'status-preparing';
                case 'confirmed': return 'status-confirmed';
                case 'delivering': return 'status-delivering';
                case 'delivered': return 'status-delivered';
                case 'rejected': return 'status-rejected';
                default: return 'status-preparing';
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => {
                notification.remove();
            });
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Show loading overlay
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        // Hide loading overlay
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);
        
        // Make functions available globally
        window.openImageZoom = openImageZoom;
    </script>
</body>
</html>