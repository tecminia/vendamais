<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Login | Vendas</title>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.3/imask.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
        html,body{height:100%;overflow-x:hidden;background-color:#f5f5f5;color:#212121}
        body{font-size:14px;display:flex;align-items:center;justify-content:center;padding:20px;min-height:100vh}
        .container{max-width:500px;width:100%;background-color:#ffffff;border-radius:20px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,0.1);border:1px solid #e0e0e0;position:relative;overflow:visible;margin:20px auto}
        .free-month-banner{background:linear-gradient(135deg,#4caf50 0%,#2e7d32 100%);color:white;padding:20px;border-radius:15px;margin-bottom:30px;text-align:center;border:2px solid #4caf50;box-shadow:0 5px 15px rgba(76,175,80,0.2)}
        .free-month-title{font-size:1.4rem;font-weight:700;margin-bottom:8px;display:flex;align-items:center;justify-content:center;gap:10px}
        .free-month-subtitle{font-size:0.9rem;opacity:0.9;margin-bottom:5px}
        .price-info{font-size:0.85rem;opacity:0.8;margin-top:10px;color:#e0f7fa}
        .logo-section{text-align:center;margin-bottom:30px}
        .logo-icon{font-size:3rem;color:#212121;margin-bottom:15px}
        .logo-section h1{font-size:1.8rem;color:#212121;margin-bottom:5px}
        .logo-section p{color:#757575;font-size:0.9rem}
        .form-group{margin-bottom:20px}
        .form-label{display:block;margin-bottom:8px;font-weight:600;color:#212121;font-size:0.95rem}
        .form-input{width:100%;padding:14px;border:2px solid #e0e0e0;border-radius:10px;font-size:1rem;transition:all 0.3s ease;background-color:#ffffff;color:#212121;-webkit-user-select:text;-moz-user-select:text;-ms-user-select:text;user-select:text}
        .form-input:focus{outline:none;border-color:#212121;box-shadow:0 0 0 3px rgba(33,33,33,0.1)}
        .btn{padding:14px 20px;border-radius:10px;border:none;font-weight:600;cursor:pointer;transition:all 0.3s ease;font-size:1rem;display:flex;align-items:center;justify-content:center;gap:10px;position:relative;overflow:hidden;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0.1)}
        .btn:active{transform:scale(0.98)}
        .btn:disabled{opacity:0.6;cursor:not-allowed}
        .btn-primary{background-color:#212121;color:#ffffff;width:100%}
        .btn-primary:hover:not(:disabled){background-color:#000000;transform:translateY(-2px);box-shadow:0 5px 15px rgba(33,33,33,0.2)}
        .btn-secondary{background-color:#e0e0e0;color:#212121;width:100%}
        .btn-secondary:hover:not(:disabled){background-color:#d0d0d0}
        .btn-google{background-color:#ffffff;color:#212121;border:2px solid #e0e0e0;width:100%;margin-bottom:15px}
        .btn-google:hover:not(:disabled){background-color:#f5f5f5;border-color:#212121;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.1)}
        .btn-google img{width:20px;height:20px}
        .dual-button-container{display:flex;gap:10px;margin-top:20px}
        .dual-button-container .btn{flex:1}
        .divider{text-align:center;margin:20px 0;position:relative;color:#757575;font-size:0.9rem}
        .divider::before,.divider::after{content:'';position:absolute;top:50%;width:45%;height:1px;background-color:#e0e0e0}
        .divider::before{left:0}
        .divider::after{right:0}
        .small-text{font-size:0.85rem;color:#757575;margin-top:5px;display:block}
        .support-link{text-align:center;margin-top:25px;color:#757575;font-size:0.9rem}
        .support-link a{color:#212121;text-decoration:none;font-weight:600;display:inline-flex;align-items:center;gap:5px;padding:5px;border-radius:5px;-webkit-tap-highlight-color:rgba(33,33,33,0.1)}
        .support-link a:active{background-color:#f5f5f5}
        .verification-message{background-color:#fff3e0;border:2px solid #ffb74d;border-radius:10px;padding:20px;margin-bottom:25px;text-align:center;display:none}
        .verification-message.active{display:block;animation:fadeIn 0.4s ease}
        .verification-icon{font-size:2rem;color:#ff9800;margin-bottom:15px}
        .verification-title{font-size:1.2rem;color:#e65100;margin-bottom:10px;font-weight:600}
        .verification-text{color:#5d4037;font-size:0.9rem;margin-bottom:15px}
        .resend-verification{margin-top:15px;font-size:0.85rem;color:#757575}
        .resend-verification a{color:#212121;font-weight:600;text-decoration:none}
        .resend-verification a:hover{text-decoration:underline}
        .simple-register-form{display:none;animation:fadeIn 0.4s ease}
        .simple-register-form.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .fullscreen-loader{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(255,255,255,0.95);display:none;align-items:center;justify-content:center;z-index:10000;flex-direction:column;gap:20px}
        .fullscreen-loader.active{display:flex}
        .loader-spinner{width:60px;height:60px;border:4px solid #f3f3f3;border-top:4px solid #212121;border-radius:50%;animation:spin 1s linear infinite}
        .loader-text{color:#212121;font-size:1.1rem;font-weight:600;max-width:300px;text-align:center}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .notification{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);padding:20px 30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.3);z-index:10000;animation:fadeInScale 0.3s ease;font-weight:600;color:white;backdrop-filter:blur(10px);background-color:rgba(0,0,0,0.9);max-width:400px;width:90%;display:flex;align-items:center;gap:15px;text-align:center}
        .notification.success{background-color:rgba(76,175,80,0.95)}
        .notification.error{background-color:rgba(244,67,54,0.95)}
        .notification.info{background-color:rgba(33,150,243,0.95)}
        .notification.warning{background-color:rgba(255,152,0,0.95)}
        @keyframes fadeInScale{from{opacity:0;transform:translate(-50%,-50%) scale(0.8)}to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
        @keyframes fadeOutScale{from{opacity:1;transform:translate(-50%,-50%) scale(1)}to{opacity:0;transform:translate(-50%,-50%) scale(0.8)}}
        .copy-protection-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:transparent;z-index:9999;pointer-events:none}
        @media (max-width:480px){.container{padding:20px;border-radius:15px;margin:10px auto}body{padding:10px;align-items:flex-start;min-height:auto;height:auto}.logo-section h1{font-size:1.5rem}.free-month-banner{padding:15px}.free-month-title{font-size:1.2rem}.support-link{font-size:0.8rem}.notification{width:85%;padding:15px 20px;font-size:0.9rem}.verification-message{padding:15px}}
        .clickable{cursor:pointer}
        .back-button{background:none;border:none;color:#757575;font-size:1rem;cursor:pointer;display:flex;align-items:center;gap:5px;margin-bottom:20px;padding:5px;border-radius:5px}
        .back-button:hover{background-color:#f5f5f5}
    </style>
    
    <meta name="application-name" content="Venda+">
<meta name="apple-mobile-web-app-title" content="Venda+">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#212121">

<link rel="apple-touch-icon" sizes="152x152" href="/vendamais/icons/icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/vendamais/icons/icon-180x180.png">
<link rel="apple-touch-icon" sizes="167x167" href="/vendamais/icons/icon-167x167.png">

<link rel="manifest" href="/vendamais/pwa/manifest.json">
</head>
<body>
    <div class="copy-protection-overlay" id="copyProtection"></div>
    
    <div class="fullscreen-loader" id="fullscreenLoader">
        <div class="loader-spinner"></div>
        <div class="loader-text" id="loaderText">Processando...</div>
    </div>

    <div class="container" id="mainContainer">
        <div class="logo-section">
            <div class="logo-icon"><i class="fas fa-store"></i></div>
            <h1>Venda+</h1>
            <p>Faça login para acessar sua loja virtual</p>
        </div>
        
        <div class="free-month-banner">
            <div class="free-month-title"><i class="fas fa-gift"></i>PRIMEIRO MÊS GRÁTIS!</div>
            <div class="free-month-subtitle">Para novos usuários, no primeiro acesso</div>
            <div class="price-info" id="priceInfo">Após o período gratuito: R$ 99,00/mês</div>
        </div>
        
        <div class="verification-message" id="verificationMessage">
            <div class="verification-icon"><i class="fas fa-envelope-circle-check"></i></div>
            <div class="verification-title">Verifique seu e-mail</div>
            <div class="verification-text">Enviamos um link de verificação para o seu e-mail.<br>Por favor, verifique sua caixa de entrada ou spam.</div>
            <div class="resend-verification">Não recebeu? <a href="#" id="resendVerificationLink">Reenviar verificação</a></div>
        </div>
        
        <button class="btn btn-google" id="googleLoginBtn">
            <img src="https://img.icons8.com/color/48/000000/google-logo.png" alt="Google">
            Entrar com Google
        </button>
        
        <div class="divider">ou</div>
        
        <form id="loginForm">
            <div class="form-group">
                <label class="form-label">E-mail</label>
                <input type="email" id="email" class="form-input" placeholder="seu@email.com" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Senha</label>
                <input type="password" id="password" class="form-input" placeholder="Sua senha" required>
            </div>
            
            <div class="dual-button-container">
                <button type="submit" class="btn btn-primary" id="loginBtn"><i class="fas fa-sign-in-alt"></i> Entrar</button>
                <button type="button" class="btn btn-secondary" id="registerBtn"><i class="fas fa-user-plus"></i> Cadastrar</button>
            </div>
        </form>
        
        <div class="simple-register-form" id="simpleRegisterForm">
            <div class="divider">Complete seu cadastro</div>
            
            <form id="completeRegistrationForm">
                <div class="form-group">
                    <label class="form-label">Nome da Empresa *</label>
                    <input type="text" id="companyName" class="form-input" placeholder="Nome da sua empresa" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Telefone (WhatsApp) *</label>
                    <input type="text" id="userPhone" class="form-input" placeholder="(11) 99999-9999" required>
                    <span class="small-text">Este número será usado para confirmações</span>
                </div>
                
                <button type="submit" class="btn btn-primary" id="completeRegisterBtn"><i class="fas fa-check"></i> Finalizar Cadastro</button>
            </form>
        </div>
        
        <div class="support-link">
            <a href="#" id="supportLink"><i class="fas fa-question-circle"></i> Dúvidas? Entre em contato com suporte</a>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB7U-JfKAlkPxSyL4AEf5u0BgcDzSXf41M",
            authDomain: "appvendas-1eebf.firebaseapp.com",
            projectId: "appvendas-1eebf",
            storageBucket: "appvendas-1eebf.firebasestorage.app",
            messagingSenderId: "229472373918",
            appId: "1:229472373918:web:39cd4940b052b2375f3f8f"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // DOM Elements
        const mainContainer = document.getElementById('mainContainer');
        const simpleRegisterForm = document.getElementById('simpleRegisterForm');
        const verificationMessage = document.getElementById('verificationMessage');
        const supportLinks = document.querySelectorAll('[id^="supportLink"]');
        const copyProtection = document.getElementById('copyProtection');
        const priceInfo = document.getElementById('priceInfo');
        
        // Forms
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('completeRegistrationForm');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const completeRegisterBtn = document.getElementById('completeRegisterBtn');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const resendVerificationLink = document.getElementById('resendVerificationLink');
        
        // Inputs
        const userPhone = document.getElementById('userPhone');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        
        // Loader
        const fullscreenLoader = document.getElementById('fullscreenLoader');
        const loaderText = document.getElementById('loaderText');
        
        // Application State
        let systemConfig = null;
        let currentUser = null;
        let phoneMask = null;
        let isProcessing = false;
        let supportPhone = '5511999999999';
        let monthlyPrice = 99.00;
        let pendingUserCredential = null;
        let pendingUserId = null;
        let configLoaded = false;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', async () => {
            loadSystemConfig();
            setupPhoneMask();
            setupEventListeners();
            setupCopyProtection();
            
            // Verificar se há um email salvo localmente para continuar o cadastro
            const savedEmail = localStorage.getItem('pendingEmail');
            if (savedEmail) {
                emailInput.value = savedEmail;
                // Tentar verificar automaticamente se o email foi confirmado
                await checkForPendingVerification(savedEmail);
            }
            
            // Monitor authentication state
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        
                        // IMPORTANTE: Não salvar login se email não foi verificado
                        if (!user.emailVerified) {
                            // Mostrar mensagem de verificação
                            showVerificationMessage(user.email);
                            return;
                        }
                        
                        if (userData.status === 'active' && userData.isActive !== false && user.emailVerified) {
                            // Verificar data de expiração
                            if (userData.expiryDate) {
                                const expiryDate = new Date(userData.expiryDate);
                                const today = new Date();
                                today.setHours(0, 0, 0, 0);
                                
                                if (expiryDate < today) {
                                    await db.collection('users').doc(user.uid).update({
                                        status: 'expired',
                                        isActive: false
                                    });
                                    await auth.signOut();
                                    localStorage.removeItem('currentUser');
                                    return;
                                }
                            }
                            
                            // Só salva login se email foi verificado
                            localStorage.setItem('currentUser', JSON.stringify({
                                uid: user.uid,
                                email: user.email,
                                storeName: userData.storeName,
                                phone: userData.phone,
                                isAdmin: true,
                                expiryDate: userData.expiryDate,
                                emailVerified: user.emailVerified
                            }));
                            window.location.href = 'index.html';
                        } else if (userData.status === 'pending' && !userData.configCompleted && user.emailVerified) {
                            // Email verificado, mostrar formulário de cadastro
                            showRegistrationForm(user);
                        } else if (!user.emailVerified) {
                            // Email não verificado, mostrar mensagem
                            showVerificationMessage(user.email);
                        }
                    } else {
                        // User authenticated but doesn't exist in Firestore
                        if (user.emailVerified) {
                            // Email verificado mas não tem registro, mostrar cadastro
                            showRegistrationForm(user);
                        } else {
                            // Email não verificado, mostrar mensagem
                            showVerificationMessage(user.email);
                        }
                    }
                } else {
                    // User logged out, clear localStorage (exceto pendingEmail)
                    localStorage.removeItem('currentUser');
                }
            });
        });

        // Verificar se há verificação pendente
        async function checkForPendingVerification(email) {
            try {
                showLoader('Verificando status do email...');
                
                // Tentar fazer login com o email
                const signInMethods = await auth.fetchSignInMethodsForEmail(email);
                
                if (signInMethods.length > 0) {
                    // Usuário existe, verificar se está logado
                    const user = auth.currentUser;
                    if (user && user.email === email) {
                        if (user.emailVerified) {
                            // Email verificado, mostrar formulário de cadastro
                            showRegistrationForm(user);
                        } else {
                            // Email não verificado, mostrar mensagem
                            showVerificationMessage(email);
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking pending verification:', error);
            } finally {
                hideLoader();
            }
        }

        // Load system configuration
        async function loadSystemConfig() {
            try {
                const configDoc = await db.collection('systemConfig').doc('paymentSettings').get();
                if (configDoc.exists) {
                    systemConfig = configDoc.data();
                    supportPhone = systemConfig.adminWhatsApp || '5511999999999';
                    monthlyPrice = systemConfig.monthlyPlanPrice || 99.00;
                    if (priceInfo) {
                        priceInfo.textContent = `Após o período gratuito: R$ ${monthlyPrice.toFixed(2).replace('.', ',')}/mês`;
                    }
                } else {
                    systemConfig = { monthlyPlanPrice: 99.00, adminWhatsApp: '5511999999999' };
                    supportPhone = systemConfig.adminWhatsApp;
                    monthlyPrice = systemConfig.monthlyPlanPrice;
                    if (priceInfo) {
                        priceInfo.textContent = `Após o período gratuito: R$ ${monthlyPrice.toFixed(2).replace('.', ',')}/mês`;
                    }
                }
                configLoaded = true;
            } catch (error) {
                console.error('Error loading system config:', error);
                systemConfig = { monthlyPlanPrice: 99.00, adminWhatsApp: '5511999999999' };
                supportPhone = systemConfig.adminWhatsApp;
                monthlyPrice = systemConfig.monthlyPlanPrice;
                if (priceInfo) {
                    priceInfo.textContent = `Após o período gratuito: R$ ${monthlyPrice.toFixed(2).replace('.', ',')}/mês`;
                }
                configLoaded = true;
            }
        }

        // Copy protection setup
        function setupCopyProtection() {
            document.addEventListener('contextmenu', function(e) {
                if (e.target.closest('.form-input')) return;
                e.preventDefault();
                return false;
            });
            
            document.addEventListener('selectstart', function(e) {
                const target = e.target;
                const isInput = target.classList.contains('form-input') || 
                              target.tagName === 'INPUT' || 
                              target.tagName === 'TEXTAREA';
                if (!isInput) {
                    e.preventDefault();
                    return false;
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            supportLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSupport(e);
                });
            });
            
            loginForm.addEventListener('submit', handleLogin);
            registerBtn.addEventListener('click', handleRegister);
            registerForm.addEventListener('submit', handleCompleteRegistration);
            googleLoginBtn.addEventListener('click', handleGoogleLogin);
            
            resendVerificationLink?.addEventListener('click', function(e) {
                e.preventDefault();
                resendVerificationEmail();
            });
        }

        // Setup phone mask
        function setupPhoneMask() {
            if (userPhone) {
                phoneMask = new IMask(userPhone, {
                    mask: '(00) 00000-0000',
                    lazy: false
                });
            }
        }

        // Show support contact
        function showSupport(e) {
            e.preventDefault();
            const message = encodeURIComponent('Olá! Gostaria de tirar uma dúvida sobre o sistema Venda+.');
            const whatsappUrl = `https://wa.me/${supportPhone}?text=${message}`;
            const link = document.createElement('a');
            link.href = whatsappUrl;
            link.target = '_blank';
            link.rel = 'noopener noreferrer nofollow';
            link.style.cssText = 'position: fixed; left: -9999px; top: -9999px; width: 1px; height: 1px; opacity: 0;';
            document.body.appendChild(link);
            requestAnimationFrame(() => {
                try {
                    link.click();
                    setTimeout(() => { if (link.parentNode) document.body.removeChild(link); }, 5000);
                } catch (error) {
                    console.error('Erro ao abrir WhatsApp:', error);
                    window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
                    if (link.parentNode) document.body.removeChild(link);
                }
            });
        }

        // Show verification message
        function showVerificationMessage(email) {
            // Salvar email para continuar depois da verificação
            localStorage.setItem('pendingEmail', email);
            
            // Mostrar mensagem
            verificationMessage.classList.add('active');
            loginForm.style.display = 'none';
            simpleRegisterForm.style.display = 'none';
            googleLoginBtn.style.display = 'none';
            document.querySelector('.divider').style.display = 'none';
            
            showNotification('Por favor, verifique seu email antes de continuar.', 'info');
        }

        // Handle login
        async function handleLogin(e) {
            e.preventDefault();
            if (isProcessing) return;
            
            const email = emailInput.value;
            const password = passwordInput.value;
            
            try {
                showLoader('Realizando login...');
                isProcessing = true;
                disableButton(loginBtn);
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // VERIFICAÇÃO CRÍTICA: Não permitir login sem email verificado
                if (!user.emailVerified) {
                    showVerificationMessage(email);
                    return;
                }
                
                // Verificar se o usuário existe no Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // Verificar status do usuário
                    if (userData.status === 'blocked') {
                        throw new Error('Sua conta está bloqueada. Entre em contato com o suporte.');
                    }
                    
                    if (userData.status === 'expired') {
                        throw new Error('Seu plano expirou. Renove seu plano para continuar.');
                    }
                    
                    if (userData.status === 'pending') {
                        if (!userData.configCompleted) {
                            showRegistrationForm(user);
                            return;
                        } else {
                            throw new Error('Seu cadastro está em análise. Aguarde a confirmação.');
                        }
                    }
                    
                    if (userData.status === 'active' && userData.isActive !== false) {
                        // Verificar data de expiração
                        if (userData.expiryDate) {
                            const expiryDate = new Date(userData.expiryDate);
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            
                            if (expiryDate < today) {
                                await db.collection('users').doc(user.uid).update({
                                    status: 'expired',
                                    isActive: false
                                });
                                await auth.signOut();
                                localStorage.removeItem('currentUser');
                                throw new Error('Seu plano expirou. Renove seu plano para continuar.');
                            }
                        }
                        
                        // SÓ SALVA SE EMAIL VERIFICADO
                        localStorage.setItem('currentUser', JSON.stringify({
                            uid: user.uid,
                            email: user.email,
                            storeName: userData.storeName,
                            phone: userData.phone,
                            isAdmin: true,
                            expiryDate: userData.expiryDate,
                            emailVerified: user.emailVerified
                        }));
                        
                        // Limpar email pendente
                        localStorage.removeItem('pendingEmail');
                        
                        // Atualizar último login
                        await db.collection('users').doc(user.uid).update({
                            lastLogin: new Date().toISOString()
                        });
                        
                        showNotification('Login realizado com sucesso!', 'success');
                        setTimeout(() => { window.location.href = 'index.html'; }, 1000);
                    }
                } else {
                    // Usuário não existe no Firestore, mas email foi verificado
                    if (user.emailVerified) {
                        showRegistrationForm(user);
                    } else {
                        showVerificationMessage(email);
                    }
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showNotification(getErrorMessage(error), 'error');
            } finally {
                hideLoader();
                isProcessing = false;
                enableButton(loginBtn);
            }
        }

        // Handle registration (email/password)
        async function handleRegister(e) {
            e.preventDefault();
            if (isProcessing) return;
            
            const email = emailInput.value;
            const password = passwordInput.value;
            
            if (!email || !password) {
                showNotification('Por favor, preencha e-mail e senha.', 'error');
                return;
            }
            
            try {
                showLoader('Criando conta...');
                isProcessing = true;
                disableButton(registerBtn);
                
                // Criar usuário com email e senha
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Salvar email localmente para continuar depois da verificação
                localStorage.setItem('pendingEmail', email);
                
                // Enviar email de verificação
                await user.sendEmailVerification({
                    url: window.location.href,
                    handleCodeInApp: true
                });
                
                // Guardar credenciais para usar depois da verificação
                pendingUserCredential = userCredential;
                pendingUserId = user.uid;
                
                // Mostrar mensagem de verificação
                showVerificationMessage(email);
                
                showNotification('Email de verificação enviado! Por favor, verifique sua caixa de entrada.', 'success');
                
                // Iniciar verificação periódica
                startEmailVerificationCheck();
                
            } catch (error) {
                console.error('Registration error:', error);
                showNotification(getErrorMessage(error), 'error');
            } finally {
                hideLoader();
                isProcessing = false;
                enableButton(registerBtn);
            }
        }

        // Resend verification email
        async function resendVerificationEmail() {
            const pendingEmail = localStorage.getItem('pendingEmail');
            if (!pendingEmail) {
                showNotification('Nenhum email pendente encontrado.', 'error');
                return;
            }
            
            try {
                showLoader('Reenviando verificação...');
                
                // Tentar encontrar o usuário
                const signInMethods = await auth.fetchSignInMethodsForEmail(pendingEmail);
                if (signInMethods.length === 0) {
                    throw new Error('Usuário não encontrado.');
                }
                
                // Tentar fazer login (se senha disponível)
                try {
                    const password = passwordInput.value;
                    if (password) {
                        const userCredential = await auth.signInWithEmailAndPassword(pendingEmail, password);
                        await userCredential.user.sendEmailVerification({
                            url: window.location.href,
                            handleCodeInApp: true
                        });
                        pendingUserCredential = userCredential;
                        pendingUserId = userCredential.user.uid;
                    }
                } catch (loginError) {
                    // Não conseguiu fazer login, apenas informar
                    console.log('Não foi possível reenviar automaticamente. O usuário precisa verificar o email.');
                }
                
                showNotification('Se você criou uma conta, o email de verificação já foi enviado. Verifique sua caixa de entrada ou spam.', 'success');
            } catch (error) {
                console.error('Resend verification error:', error);
                showNotification('Erro ao reenviar verificação. Tente fazer login novamente.', 'error');
            } finally {
                hideLoader();
            }
        }

        // Verificar periodicamente se o email foi verificado
        function startEmailVerificationCheck() {
            const checkInterval = setInterval(async () => {
                const pendingEmail = localStorage.getItem('pendingEmail');
                if (!pendingEmail) {
                    clearInterval(checkInterval);
                    return;
                }
                
                try {
                    // Verificar se há usuário logado
                    const user = auth.currentUser;
                    if (user && user.email === pendingEmail) {
                        await user.reload();
                        
                        if (user.emailVerified) {
                            clearInterval(checkInterval);
                            showNotification('Email verificado com sucesso!', 'success');
                            // Limpar email pendente
                            localStorage.removeItem('pendingEmail');
                            showRegistrationForm(user);
                        }
                    }
                } catch (error) {
                    console.error('Verification check error:', error);
                }
            }, 3000); // Verificar a cada 3 segundos
        }

        // Show registration form after email verification
        function showRegistrationForm(user) {
            verificationMessage.classList.remove('active');
            loginForm.style.display = 'none';
            simpleRegisterForm.style.display = 'block';
            simpleRegisterForm.classList.add('active');
            googleLoginBtn.style.display = 'none';
            document.querySelector('.divider').style.display = 'none';
            
            // Guardar dados do usuário
            pendingUserCredential = { user };
            pendingUserId = user.uid;
            
            // Preencher dados automaticamente
            const companyNameInput = document.getElementById('companyName');
            if (companyNameInput) {
                if (user.displayName) {
                    companyNameInput.value = user.displayName;
                } else if (user.email) {
                    const nameFromEmail = user.email.split('@')[0];
                    companyNameInput.value = nameFromEmail.charAt(0).toUpperCase() + nameFromEmail.slice(1);
                }
            }
            
            // Mostrar instrução
            showNotification('Complete seu cadastro para continuar.', 'info');
        }

        // Handle Google login
        async function handleGoogleLogin() {
            if (isProcessing) return;
            
            try {
                showLoader('Conectando com Google...');
                isProcessing = true;
                disableButton(googleLoginBtn);
                
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                
                // Limpar email pendente
                localStorage.removeItem('pendingEmail');
                
                // Verificar se o usuário já existe
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // Usuário existe, verificar status
                    if (userData.status === 'active' && userData.isActive !== false) {
                        // SÓ SALVA SE EMAIL VERIFICADO (Google já verifica)
                        localStorage.setItem('currentUser', JSON.stringify({
                            uid: user.uid,
                            email: user.email,
                            storeName: userData.storeName,
                            phone: userData.phone,
                            isAdmin: true,
                            expiryDate: userData.expiryDate,
                            emailVerified: user.emailVerified
                        }));
                        
                        // Atualizar último login
                        await db.collection('users').doc(user.uid).update({
                            lastLogin: new Date().toISOString(),
                            authProvider: 'google'
                        });
                        
                        showNotification('Login realizado com sucesso!', 'success');
                        setTimeout(() => { window.location.href = 'index.html'; }, 1000);
                    } else if (userData.status === 'pending' && !userData.configCompleted) {
                        showRegistrationFormForGoogle(user);
                    } else {
                        showNotification('Sua conta não está ativa. Entre em contato com o suporte.', 'error');
                        await auth.signOut();
                        localStorage.removeItem('currentUser');
                    }
                } else {
                    // Novo usuário Google - mostrar formulário de cadastro
                    showRegistrationFormForGoogle(user);
                }
                
            } catch (error) {
                console.error('Google login error:', error);
                showNotification(getErrorMessage(error), 'error');
            } finally {
                hideLoader();
                isProcessing = false;
                enableButton(googleLoginBtn);
            }
        }

        // Show registration form for Google user
        function showRegistrationFormForGoogle(user) {
            loginForm.style.display = 'none';
            simpleRegisterForm.style.display = 'block';
            simpleRegisterForm.classList.add('active');
            googleLoginBtn.style.display = 'none';
            verificationMessage.classList.remove('active');
            document.querySelector('.divider').style.display = 'none';
            
            // Preencher dados do Google
            if (user.displayName) {
                const companyNameInput = document.getElementById('companyName');
                if (companyNameInput) {
                    companyNameInput.value = user.displayName;
                }
            }
            
            // Armazenar dados do usuário Google
            pendingUserCredential = { user };
            pendingUserId = user.uid;
            
            showNotification('Complete seu cadastro para continuar.', 'info');
        }

        // Handle complete registration (for both email/password and Google)
        async function handleCompleteRegistration(e) {
            e.preventDefault();
            if (isProcessing) return;
            
            const companyName = document.getElementById('companyName').value;
            const phone = userPhone.value;
            
            if (!companyName || companyName.trim() === '') {
                showNotification('Por favor, informe o nome da empresa.', 'error');
                return;
            }
            
            if (!phone || phone.replace(/\D/g, '').length < 11) {
                showNotification('Por favor, informe um número de WhatsApp válido.', 'error');
                return;
            }
            
            try {
                showLoader('Finalizando cadastro...');
                isProcessing = true;
                disableButton(completeRegisterBtn);
                
                const userId = pendingUserId;
                const user = pendingUserCredential?.user;
                
                if (!userId || !user) {
                    // Tentar obter o usuário atual
                    const currentUser = auth.currentUser;
                    if (!currentUser) {
                        throw new Error('Usuário não encontrado. Faça login novamente.');
                    }
                    pendingUserId = currentUser.uid;
                    pendingUserCredential = { user: currentUser };
                }
                
                const finalUserId = pendingUserId;
                const finalUser = pendingUserCredential.user;
                
                // VERIFICAÇÃO FINAL: Confirmar que o email foi verificado
                if (!finalUser.emailVerified) {
                    throw new Error('Por favor, verifique seu e-mail antes de completar o cadastro.');
                }
                
                // Calcular data de expiração (1 mês a partir de agora)
                const expiryDate = new Date();
                expiryDate.setMonth(expiryDate.getMonth() + 1);
                
                // Criar documento do usuário
                await db.collection('users').doc(finalUserId).set({
                    uid: finalUserId,
                    email: finalUser.email,
                    storeName: companyName,
                    phone: phone,
                    status: 'active',
                    plan: 'monthly',
                    isActive: true,
                    configCompleted: true,
                    paymentConfirmed: true, // Primeiro mês grátis
                    freeMonthUsed: true,
                    createdAt: new Date().toISOString(),
                    lastActivity: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    expiryDate: expiryDate.toISOString(),
                    authProvider: finalUser?.providerData?.[0]?.providerId || 'password',
                    emailVerified: finalUser.emailVerified
                });
                
                // SÓ SALVA SE EMAIL VERIFICADO
                localStorage.setItem('currentUser', JSON.stringify({
                    uid: finalUserId,
                    email: finalUser.email,
                    storeName: companyName,
                    phone: phone,
                    isAdmin: true,
                    expiryDate: expiryDate.toISOString(),
                    emailVerified: finalUser.emailVerified
                }));
                
                // Limpar dados pendentes
                localStorage.removeItem('pendingEmail');
                pendingUserCredential = null;
                pendingUserId = null;
                
                showNotification('Cadastro concluído com sucesso!', 'success');
                
                // Redirecionar para o app após delay
                setTimeout(() => { window.location.href = 'index.html'; }, 1500);
                
            } catch (error) {
                console.error('Complete registration error:', error);
                showNotification(getErrorMessage(error), 'error');
            } finally {
                hideLoader();
                isProcessing = false;
                enableButton(completeRegisterBtn);
            }
        }

        // Helper Functions
        function showLoader(text = 'Processando...') {
            loaderText.textContent = text;
            fullscreenLoader.classList.add('active');
            document.body.style.pointerEvents = 'none';
        }

        function hideLoader() {
            fullscreenLoader.classList.remove('active');
            document.body.style.pointerEvents = 'auto';
        }

        function disableButton(button) {
            button.disabled = true;
            button.style.opacity = '0.7';
        }

        function enableButton(button) {
            button.disabled = false;
            button.style.opacity = '1';
        }

        function showNotification(message, type = 'info') {
            document.querySelectorAll('.notification').forEach(n => {
                n.style.animation = 'fadeOutScale 0.3s ease';
                setTimeout(() => { if (n.parentNode) n.remove(); }, 300);
            });
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'fadeOutScale 0.3s ease';
                    setTimeout(() => { if (notification.parentNode) notification.remove(); }, 300);
                }
            }, 3000);
        }

        function getErrorMessage(error) {
            switch (error.code || error.message) {
                case 'auth/email-already-in-use': return 'Este e-mail já está em uso.';
                case 'auth/invalid-email': return 'E-mail inválido.';
                case 'auth/weak-password': return 'Senha muito fraca. Use pelo menos 6 caracteres.';
                case 'auth/user-not-found': return 'Usuário não encontrado.';
                case 'auth/wrong-password': return 'Senha incorreta.';
                case 'auth/too-many-requests': return 'Muitas tentativas. Tente novamente mais tarde.';
                case 'auth/popup-closed-by-user': return 'Login com Google cancelado.';
                case 'auth/cancelled-popup-request': return 'Login com Google cancelado.';
                case 'Por favor, verifique seu e-mail antes de completar o cadastro.':
                case 'Sua conta está bloqueada. Entre em contato com o suporte.':
                case 'Seu plano expirou. Renove seu plano para continuar.':
                case 'Seu cadastro está em análise. Aguarde a confirmação.':
                    return error.message;
                default: return error.message || 'Ocorreu um erro. Tente novamente.';
            }
        }
    </script>
    <script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function () {
    navigator.serviceWorker.register('/vendamais/pwa/sw.js')
      .then(function (registration) {
        console.log('Service Worker registrado:', registration.scope);

        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              if (confirm('Nova versão disponível. Recarregar?')) {
                window.location.reload();
              }
            }
          });
        });

        setInterval(() => {
          registration.update();
        }, 3600000);
      })
      .catch(function (error) {
        console.error('Falha no registro do Service Worker:', error);
      });
  });

  navigator.serviceWorker.addEventListener('message', event => {
    if (event.data?.type === 'UPDATE_AVAILABLE' && event.data.forceReload) {
      window.location.reload();
    }
  });
}

if (window.matchMedia('(display-mode: standalone)').matches) {
  document.body.classList.add('pwa-mode');
}
</script>
</body>
</html>
