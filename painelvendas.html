<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painel | Vendas</title>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.3/imask.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        /* Bloquear seleção de texto não editáveis */
        body {
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE10+/Edge */
            user-select: none; /* Standard */
        }
        
        /* Permitir seleção apenas em inputs e textareas */
        input, textarea, .form-input, [contenteditable="true"] {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        /* Estilos existentes mantidos */
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;-webkit-tap-highlight-color:transparent}
        html,body{height:100%;overflow-x:hidden;background-color:#ffffff;transition:background-color 0.3s ease}
        body{color:#212121;font-size:14px;padding-bottom:70px;transition:all 0.3s ease}
        .app-container{max-width:100%;margin:0 auto;padding:0}
        .app-header{background-color:#212121;color:#fff;padding:15px;box-shadow:0 2px 10px rgba(0,0,0,0.15);position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between;transition:all 0.3s ease}
        .app-header .logo{display:flex;align-items:center;gap:12px}
        .app-header .logo-icon{font-size:1.8rem;color:#212121;background-color:#fff;width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center}
        .app-header .logo-text h1{font-size:1.2rem;font-weight:700;line-height:1.2;transition:color 0.3s ease}
        .user-info{display:flex;align-items:center;gap:10px}
        .user-avatar{width:36px;height:36px;border-radius:50%;background-color:#212121;border:2px solid #fff;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.9rem;transition:all 0.3s ease;background-size:cover;background-position:center;background-repeat:no-repeat}
        .logout-btn{background:none;border:none;color:#fff;font-size:1.2rem;padding:5px;cursor:pointer;transition:color 0.3s ease}
        .welcome-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#212121 0%,#424242 100%);z-index:2000;align-items:center;justify-content:center;padding:20px}
        .welcome-content{background-color:#fff;border-radius:20px;padding:30px;max-width:500px;width:100%;text-align:center;border:1px solid #e0e0e0;box-shadow:0 10px 30px rgba(0,0,0,0.3);position:relative;animation:modalFadeIn 0.5s ease}
        .welcome-icon{font-size:3.5rem;color:#212121;margin-bottom:20px}
        .welcome-title{font-size:1.8rem;margin-bottom:15px;color:#212121;font-weight:700}
        .welcome-message{color:#757575;margin-bottom:30px;line-height:1.6;text-align:left}
        .welcome-steps{background-color:#f9f9f9;border-radius:15px;padding:20px;margin-bottom:30px;border-left:4px solid #212121}
        .welcome-step{display:flex;align-items:center;gap:15px;margin-bottom:15px;padding-bottom:15px;border-bottom:1px solid #e0e0e0}
        .welcome-step:last-child{margin-bottom:0;padding-bottom:0;border-bottom:none}
        .step-icon{width:40px;height:40px;border-radius:50%;background-color:#212121;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600;flex-shrink:0}
        .step-text{text-align:left;flex:1}
        .step-text h4{color:#212121;margin-bottom:5px;font-weight:600}
        .step-text p{color:#757575;font-size:0.9rem;line-height:1.4}
        .expiry-warning{background-color:#fff3cd;border:1px solid #ff9800;border-radius:12px;padding:15px;margin-bottom:20px;color:#856404;position:relative}
        .expiry-warning-icon{font-size:2rem;color:#ff9800;margin-bottom:10px;text-align:center}
        .notification-badge{position:absolute;top:-5px;right:-5px;background-color:#212121;color:#fff;border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:600}
        .main-content{padding:15px;min-height:calc(100vh - 140px)}
        .section-title{font-size:1.3rem;margin-bottom:15px;color:#212121;border-bottom:2px solid #212121;padding-bottom:5px;display:flex;align-items:center;transition:all 0.3s ease}
        .user-card{background-color:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 3px 6px rgba(0,0,0,0.08);border:1px solid #e0e0e0;transition:all 0.3s ease;cursor:pointer;position:relative}
        .user-card:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.1)}
        .user-card-header{display:flex;align-items:center;gap:15px;margin-bottom:15px}
        .user-card-avatar{width:60px;height:60px;border-radius:50%;background-color:#212121;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.5rem;font-weight:600;transition:all 0.3s ease;background-size:cover;background-position:center;background-repeat:no-repeat;position:relative}
        .user-card-info h3{font-size:1.1rem;margin-bottom:5px;color:#212121;transition:color 0.3s ease}
        .user-card-info p{color:#757575;font-size:0.9rem;transition:color 0.3s ease}
        .user-card-options{position:absolute;top:15px;right:15px;display:flex;gap:8px}
        .user-option-btn{width:36px;height:36px;border-radius:8px;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:0.9rem;transition:all 0.3s ease;background-color:rgba(33,33,33,0.1);color:#212121}
        .user-option-btn:hover{background-color:rgba(33,33,33,0.2)}
        .change-password-menu{position:absolute;top:60px;right:15px;background-color:#fff;border-radius:12px;padding:10px 0;box-shadow:0 5px 20px rgba(0,0,0,0.15);border:1px solid #e0e0e0;z-index:100;min-width:180px;display:none}
        .change-password-menu.active{display:block;animation:slideDown 0.2s ease}
        .change-password-item{padding:12px 15px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:all 0.2s ease;color:#212121}
        .change-password-item:hover{background-color:#f5f5f5}
        .change-password-item i{color:#2196f3;font-size:1rem}
        .change-password-item span{font-size:0.9rem;font-weight:500}
        .link-section{background-color:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 3px 6px rgba(0,0,0,0.08);border:1px solid #e0e0e0;transition:all 0.3s ease}
        .link-title{font-size:1.1rem;margin-bottom:10px;color:#212121;transition:color 0.3s ease}
        .link-description{color:#757575;font-size:0.9rem;margin-bottom:15px;line-height:1.5;transition:color 0.3s ease}
        .link-container{background-color:#f5f5f5;border-radius:10px;padding:15px;margin-bottom:15px;word-break:break-all;border:1px dashed #212121;transition:all 0.3s ease}
        .link-container strong{color:#212121;font-size:0.95rem;transition:color 0.3s ease}
        .link-actions{display:flex;gap:10px}
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
        .stat-card{background-color:#fff;border-radius:12px;padding:15px;box-shadow:0 3px 6px rgba(0,0,0,0.08);display:flex;align-items:center;gap:12px;border:1px solid #e0e0e0;transition:all 0.3s ease}
        .stat-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem}
        .stat-icon.pending{background-color:rgba(255,152,0,0.1);color:#ff9800}
        .stat-icon.confirmed{background-color:rgba(76,175,80,0.1);color:#4caf50}
        .stat-icon.delivering{background-color:rgba(33,150,243,0.1);color:#2196f3}
        .stat-icon.delivered{background-color:rgba(76,175,80,0.2);color:#4caf50}
        .stat-icon.total{background-color:rgba(33,150,243,0.1);color:#2196f3}
        .stat-icon.revenue{background-color:rgba(33,33,33,0.1);color:#212121}
        .stat-icon.delivery{background-color:rgba(156,39,176,0.1);color:#9c27b0}
        .stat-icon.visits{background-color:rgba(103,58,183,0.1);color:#673ab7}
        .stat-info h3{font-size:0.8rem;color:#757575;margin-bottom:3px;transition:color 0.3s ease}
        .stat-number{font-size:1.3rem;font-weight:700;color:#212121;transition:color 0.3s ease}
        .orders-list{margin-top:15px}
        .order-card{background-color:#fff;border-radius:12px;padding:15px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06);border:1px solid #e0e0e0;transition:all 0.3s ease}
        .order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .order-id{font-size:0.85rem;color:#757575;transition:color 0.3s ease}
        .order-date{font-size:0.8rem;color:#757575;transition:color 0.3s ease}
        .order-customer{font-weight:600;margin-bottom:5px;color:#212121;transition:color 0.3s ease}
        .order-info{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
        .order-total{font-size:1.1rem;font-weight:700;color:#212121;transition:color 0.3s ease}
        .order-status{padding:4px 10px;border-radius:20px;font-size:0.75rem;font-weight:600}
        .status-preparing{background-color:rgba(255,152,0,0.1);color:#ff9800}
        .status-confirmed{background-color:rgba(33,150,243,0.1);color:#2196f3}
        .status-delivering{background-color:rgba(33,150,243,0.2);color:#2196f3}
        .status-delivered{background-color:rgba(76,175,80,0.2);color:#4caf50}
        .status-rejected{background-color:rgba(244,67,54,0.1);color:#f44336}
        .order-actions{display:flex;gap:8px;margin-top:10px}
        .products-list{margin-top:15px}
        .product-card{background-color:#fff;border-radius:12px;padding:15px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06);display:flex;align-items:center;gap:12px;border:1px solid #e0e0e0;transition:all 0.3s ease}
        .product-image{width:60px;height:60px;border-radius:8px;overflow:hidden;flex-shrink:0;background-color:#f5f5f5;display:flex;align-items:center;justify-content:center}
        .product-image img{width:100%;height:100%;object-fit:cover;cursor:pointer}
        .product-info{flex:1}
        .product-name{font-weight:600;margin-bottom:5px;color:#212121;transition:color 0.3s ease}
        .product-price{color:#212121;font-weight:700;font-size:1.1rem;transition:color 0.3s ease}
        .product-actions{display:flex;gap:8px}
        .btn{padding:12px 16px;border-radius:10px;border:none;font-weight:600;cursor:pointer;transition:all 0.3s ease;font-size:0.9rem;display:flex;align-items:center;justify-content:center;gap:8px}
        .btn-sm{padding:8px 12px;font-size:0.8rem}
        .btn-primary{background-color:#212121;color:#fff}
        .btn-primary:active{background-color:#000}
        .btn-secondary{background-color:#e0e0e0;color:#212121}
        .btn-secondary:active{background-color:#e0e0e0;opacity:0.9}
        .btn-success{background-color:#4caf50;color:#fff}
        .btn-success:active{background-color:#3d8b40}
        .btn-whatsapp{background-color:#25D366;color:#fff}
        .btn-whatsapp:active{background-color:#128C7E}
        .btn-danger{background-color:#f44336;color:#fff}
        .btn-danger:active{background-color:#d32f2f}
        .btn-block{width:100%;margin-top:15px}
        .action-btn{width:36px;height:36px;border-radius:8px;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:0.9rem;transition:all 0.3s ease}
        .view-btn{background-color:rgba(33,150,243,0.1);color:#2196f3}
        .confirm-btn{background-color:rgba(76,175,80,0.1);color:#4caf50}
        .reject-btn{background-color:rgba(244,67,54,0.1);color:#f44336}
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;background-color:#fff;border-top:1px solid #e0e0e0;padding:10px 0;display:flex;justify-content:space-around;z-index:100;box-shadow:0 -2px 10px rgba(0,0,0,0.1);transition:all 0.3s ease}
        .nav-btn{display:flex;flex-direction:column;align-items:center;background:none;border:none;color:#757575;font-size:0.8rem;padding:8px;flex:1;cursor:pointer;transition:color 0.3s ease;position:relative}
        .nav-btn i{font-size:1.2rem;margin-bottom:4px}
        .nav-btn.active{color:#212121}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center;padding:20px}
        .modal-content{background-color:#fff;border-radius:20px;width:100%;max-width:500px;max-height:85vh;overflow-y:auto;animation:modalFadeIn 0.3s ease;border:1px solid #e0e0e0;transition:background-color 0.3s ease;position:relative}
        .modal-header{padding:15px;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background-color:#fff;z-index:10;transition:all 0.3s ease}
        .modal-title{font-size:1.3rem;color:#212121;font-weight:600;transition:color 0.3s ease}
        .close-modal{background:none;border:none;font-size:1.5rem;color:#757575;cursor:pointer;padding:5px;transition:color 0.3s ease}
        .modal-body{padding:15px}
        .image-zoom-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.9);z-index:2000;align-items:center;justify-content:center}
        .image-zoom-content{max-width:90%;max-height:90%;position:relative}
        .image-zoom-content img{width:100%;height:auto;max-height:80vh;object-fit:contain;touch-action:pan-x pan-y}
        .close-zoom{position:absolute;top:-40px;right:0;background:none;border:none;color:#fff;font-size:2rem;cursor:pointer}
        .chart-container{background-color:#fff;border-radius:12px;padding:15px;margin-bottom:20px;box-shadow:0 3px 6px rgba(0,0,0,0.08);border:1px solid #e0e0e0;position:relative}
        .chart-title{font-size:1rem;margin-bottom:10px;color:#212121;display:flex;align-items:center;gap:8px}
        .finance-tabs{display:flex;gap:8px;overflow-x:auto;padding:10px 0;margin-bottom:15px}
        .finance-tab{padding:8px 12px;border-radius:20px;border:2px solid #e0e0e0;background-color:transparent;color:#757575;cursor:pointer;font-weight:500;font-size:0.8rem;white-space:nowrap;flex-shrink:0;transition:all 0.3s ease}
        .finance-tab.active{border-color:#212121;background-color:#212121;color:#fff}
        .monthly-summary{background-color:#fff;border-radius:12px;padding:15px;margin-bottom:15px;box-shadow:0 3px 6px rgba(0,0,0,0.08);border:1px solid #e0e0e0}
        .month-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;transition:all 0.3s ease}
        .month-name{font-weight:600;color:#212121;transition:color 0.3s ease}
        .month-revenue{font-size:1.1rem;font-weight:700;color:#4caf50}
        .daily-orders{margin-top:10px}
        .daily-order{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f5f5f5}
        .daily-order:last-child{border-bottom:none}
        .order-count{font-weight:600;color:#212121}
        .order-amount{color:#757575}
        .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.7);z-index:3000;display:none;align-items:center;justify-content:center;flex-direction:column;gap:15px}
        .loading-spinner{width:50px;height:50px;border:3px solid #f3f3f3;border-top:3px solid #212121;border-radius:50%;animation:spin 1s linear infinite}
        .loading-text{color:#fff;font-weight:600}
        .form-group{margin-bottom:15px}
        .form-label{display:block;margin-bottom:5px;font-weight:600;color:#212121;font-size:0.9rem;transition:color 0.3s ease}
        .form-input{width:100%;padding:12px;border:1px solid #e0e0e0;border-radius:10px;font-size:0.95rem;transition:border-color 0.3s ease;background-color:#fff;color:#212121}
        .form-input:focus{outline:none;border-color:#212121}
        .upload-area{border:2px dashed #e0e0e0;border-radius:10px;padding:20px;text-align:center;margin:15px 0;cursor:pointer;transition:border-color 0.3s ease;position:relative}
        .upload-area.uploading{cursor:not-allowed;opacity:0.7}
        .upload-area:active{border-color:#212121}
        .upload-icon{font-size:2rem;color:#757575;margin-bottom:10px;transition:color 0.3s ease}
        .upload-text{color:#757575;font-size:0.9rem;margin-bottom:5px;transition:color 0.3s ease}
        .upload-info{font-size:0.8rem;color:#757575;transition:color 0.3s ease;margin-top:5px}
        .file-types{display:flex;justify-content:center;gap:8px;margin-top:5px;flex-wrap:wrap}
        .file-type-badge{padding:2px 8px;border-radius:12px;font-size:0.7rem;background-color:#f5f5f5;color:#757575;border:1px solid #e0e0e0}
        .image-preview{width:100%;height:200px;border-radius:10px;object-fit:contain;margin-top:10px;display:none;cursor:pointer;background-color:#f5f5f5;touch-action:pan-x pan-y}
        .pdf-preview{display:none;width:100%;height:200px;border-radius:10px;margin-top:10px;background-color:#f5f5f5;align-items:center;justify-content:center;flex-direction:column;padding:20px;border:2px dashed #e0e0e0;cursor:pointer}
        .toggle-switch{position:relative;display:inline-block;width:50px;height:24px}
        .toggle-switch input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:34px}
        .toggle-slider:before{position:absolute;content:"";height:16px;width:16px;left:4px;bottom:4px;background-color:#fff;transition:.4s;border-radius:50%}
        input:checked+.toggle-slider{background-color:#4caf50}
        input:checked+.toggle-slider:before{transform:translateX(26px)}
        .status-filter{display:flex;gap:8px;overflow-x:auto;padding:10px 0;margin-bottom:15px}
        .status-filter-btn{padding:8px 12px;border-radius:20px;border:2px solid #e0e0e0;background-color:transparent;color:#757575;cursor:pointer;font-weight:500;font-size:0.8rem;white-space:nowrap;flex-shrink:0;transition:all 0.3s ease}
        .status-filter-btn.active{border-color:#212121;background-color:#212121;color:#fff}
        .theme-selector{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
        .theme-option{border:2px solid #e0e0e0;border-radius:10px;padding:15px;cursor:pointer;transition:all 0.3s ease}
        .theme-option.active{border-color:#212121;background-color:rgba(33,33,33,0.05)}
        .theme-preview{width:100%;height:60px;border-radius:8px;margin-bottom:8px;border:1px solid #e0e0e0;display:flex;align-items:center;justify-content:center;color:#212121;font-weight:600;background-size:cover;background-position:center}
        .theme-name{text-align:center;font-weight:600;font-size:0.9rem;color:#212121;transition:color 0.3s ease}
        .empty-state{text-align:center;padding:40px 20px;color:#757575;transition:color 0.3s ease}
        .empty-icon{font-size:3rem;margin-bottom:15px;color:#e0e0e0;transition:color 0.3s ease}
        .notification{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);padding:15px 25px;border-radius:15px;box-shadow:0 8px 25px rgba(0,0,0,0.2);z-index:10000;animation:fadeIn 0.3s ease;font-weight:600;color:#fff;text-align:center;backdrop-filter:blur(10px);background-color:rgba(0,0,0,0.85);max-width:300px;width:90%;display:flex;align-items:center;justify-content:center;gap:12px}
        .notification.success{background-color:rgba(76,175,80,0.95)}
        .notification.error{background-color:rgba(244,67,54,0.95)}
        .notification.info{background-color:rgba(33,150,243,0.95)}
        .whatsapp-notification-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.8);z-index:2000;align-items:center;justify-content:center;padding:20px}
        .whatsapp-notification-content{background-color:#fff;border-radius:20px;padding:30px;max-width:500px;width:100%;text-align:center;border:1px solid #e0e0e0;box-shadow:0 10px 30px rgba(0,0,0,0.2);position:relative;animation:modalFadeIn 0.3s ease}
        .whatsapp-icon{font-size:4rem;color:#25D366;margin-bottom:20px}
        .whatsapp-title{font-size:1.5rem;margin-bottom:10px;color:#212121;font-weight:600}
        .whatsapp-message{color:#757575;margin-bottom:25px;line-height:1.5;text-align:left;background-color:#f9f9f9;padding:15px;border-radius:10px;border-left:4px solid #25D366}
        .whatsapp-instructions{background-color:#e8f5e9;border-radius:10px;padding:15px;margin-bottom:25px;text-align:left;border:1px solid #c8e6c9}
        .whatsapp-instructions ol{margin-left:20px;margin-bottom:0}
        .whatsapp-instructions li{margin-bottom:8px;color:#2e7d32}
        .whatsapp-instructions li:last-child{margin-bottom:0}
        .whatsapp-alert-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.95);z-index:5000;align-items:center;justify-content:center;padding:20px}
        .whatsapp-alert-content{background-color:#fff;border-radius:20px;padding:30px;max-width:500px;width:100%;border:1px solid #e0e0e0;box-shadow:0 10px 30px rgba(0,0,0,0.2);position:relative;animation:modalFadeIn 0.3s ease}
        .whatsapp-alert-icon{font-size:3.5rem;color:#ff9800;margin-bottom:20px;text-align:center}
        .whatsapp-alert-title{font-size:1.5rem;margin-bottom:15px;color:#212121;text-align:center;font-weight:600}
        .whatsapp-alert-message{color:#757575;margin-bottom:20px;line-height:1.6}
        .info-list{background-color:#f9f9f9;border-radius:12px;padding:15px;margin-bottom:20px;border-left:4px solid #ff9800}
        .info-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #e0e0e0}
        .info-item:last-child{border-bottom:none}
        .info-label{font-weight:600;color:#212121}
        .info-value{color:#757575;text-align:right}
        .alert-timeline{background-color:#e8f5e9;border-radius:10px;padding:15px;margin-bottom:20px;border:1px solid #c8e6c9}
        .timeline-title{font-weight:600;color:#2e7d32;margin-bottom:10px;display:flex;align-items:center;gap:8px}
        .waiting-approval-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.85);z-index:5000;align-items:center;justify-content:center;padding:20px}
        .waiting-approval-content{background-color:#fff;border-radius:20px;padding:30px;max-width:500px;width:100%;border:1px solid #e0e0e0;box-shadow:0 5px 20px rgba(0,0,0,0.1);position:relative;animation:modalFadeIn 0.3s ease}
        .waiting-approval-icon{font-size:2.5rem;color:#2196f3;margin-bottom:15px;text-align:center}
        .waiting-approval-title{font-size:1.3rem;margin-bottom:15px;color:#212121;text-align:center;font-weight:600}
        .waiting-approval-message{color:#757575;margin-bottom:15px;line-height:1.5;font-size:0.9rem}
        .status-list{background-color:#f9f9f9;border-radius:10px;padding:12px;margin-bottom:15px;border-left:3px solid #2196f3}
        .status-item{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid #e0e0e0;font-size:0.85rem}
        .status-item:last-child{border-bottom:none}
        .status-icon{color:#4caf50;font-size:1rem}
        .status-text{flex:1}
        .block-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.95);z-index:5000;align-items:center;justify-content:center;padding:20px}
        .block-content{background-color:#fff;border-radius:20px;padding:30px;max-width:500px;width:100%;text-align:center;border:1px solid #e0e0e0;box-shadow:0 10px 30px rgba(0,0,0,0.2);position:relative;animation:modalFadeIn 0.3s ease}
        .block-icon{font-size:3.5rem;color:#f44336;margin-bottom:20px}
        .block-title{font-size:1.5rem;margin-bottom:10px;color:#212121}
        .block-message{color:#757575;margin-bottom:25px;line-height:1.5}
        .renewal-status-banner{background:linear-gradient(135deg,#2196f3 0%,#0d47a1 100%);color:white;border-radius:12px;padding:15px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between}
        .renewal-status-info{flex:1}
        .renewal-status-title{font-weight:600;font-size:1rem;margin-bottom:5px}
        .renewal-status-message{font-size:0.85rem;opacity:0.9}
        .renewal-status-actions{display:flex;gap:8px}
        .expired-banner{background:linear-gradient(135deg,#f44336 0%,#b71c1c 100%);color:white;border-radius:12px;padding:15px;margin-bottom:20px;text-align:center}
        .expired-title{font-weight:600;font-size:1.1rem;margin-bottom:5px}
        .expired-message{font-size:0.9rem;opacity:0.9;margin-bottom:10px}
        .temporary-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:rgba(0,0,0,0.85);color:#fff;padding:20px 30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.3);z-index:4000;text-align:center;max-width:300px;width:90%;backdrop-filter:blur(10px);animation:fadeIn 0.3s ease}
        .temporary-modal-icon{font-size:2.5rem;margin-bottom:15px}
        .temporary-modal-message{font-weight:500}
        .block-system-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.95);z-index:6000;align-items:center;justify-content:center;padding:20px}
        .block-system-content{background-color:#fff;border-radius:20px;padding:30px;max-width:500px;width:100%;text-align:center;border:1px solid #e0e0e0;box-shadow:0 10px 30px rgba(0,0,0,0.2);position:relative;animation:modalFadeIn 0.3s ease}
        .block-system-icon{font-size:3.5rem;color:#f44336;margin-bottom:20px}
        .block-system-title{font-size:1.5rem;margin-bottom:10px;color:#212121}
        .block-system-message{color:#757575;margin-bottom:25px;line-height:1.5}
        .days-left-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.8);z-index:5000;align-items:center;justify-content:center;padding:20px}
        .days-left-content{background-color:#fff;border-radius:15px;padding:25px;max-width:400px;width:100%;text-align:center;border:1px solid #e0e0e0;box-shadow:0 5px 15px rgba(0,0,0,0.1);position:relative;animation:modalFadeIn 0.3s ease}
        .days-left-icon{font-size:2.5rem;color:#ff9800;margin-bottom:15px}
        .days-left-title{font-size:1.2rem;margin-bottom:10px;color:#212121;font-weight:600}
        .days-left-message{color:#757575;margin-bottom:20px;line-height:1.5;font-size:0.9rem}
        /* Estilos para múltiplas imagens */
        .multiple-images-container{margin-top:15px}
        .images-preview-container{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
        .image-preview-item{position:relative;width:100%;height:100px;border-radius:8px;overflow:hidden;background-color:#f5f5f5;border:1px solid #e0e0e0}
        .image-preview-item img{width:100%;height:100%;object-fit:cover}
        .remove-image-btn{position:absolute;top:5px;right:5px;width:24px;height:24px;border-radius:50%;background-color:rgba(244,67,54,0.9);color:#fff;border:none;font-size:0.8rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .image-counter{font-size:0.8rem;color:#757575;margin-top:5px;text-align:center}
        /* Botão flutuante para produtos */
        .floating-action-btn{position:fixed;bottom:80px;right:15px;width:56px;height:56px;border-radius:50%;background-color:#212121;color:#fff;border:none;box-shadow:0 4px 12px rgba(0,0,0,0.15);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.2rem;z-index:99;transition:all 0.3s ease}
        .floating-action-btn:hover{transform:scale(1.05);box-shadow:0 6px 16px rgba(0,0,0,0.2)}
        .floating-action-btn:active{transform:scale(0.95)}
        /* Estilo para logo centralizada e área de upload */
        .logo-preview-container{display:flex;flex-direction:column;align-items:center;justify-content:center}
        .logo-upload-area{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:150px}
        .logo-upload-area.hidden{display:none}
        .logo-center-preview{width:150px;height:150px;border-radius:50%;object-fit:cover;margin:10px auto;display:none;cursor:pointer;border:3px solid #e0e0e0}
        .remove-logo-btn{position:absolute;top:-5px;right:-5px;width:28px;height:28px;border-radius:50%;background-color:#f44336;color:#fff;border:none;font-size:0.8rem;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:10;box-shadow:0 2px 5px rgba(0,0,0,0.2)}
        .logo-preview-wrapper{position:relative;display:inline-block}
        /* Botões minimalistas de link */
        .link-actions-minimal{display:flex;gap:8px;justify-content:center}
        .link-btn-minimal{width:40px;height:40px;border-radius:10px;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;transition:all 0.3s ease}
        .link-btn-minimal.copy{background-color:#2196f3;color:#fff}
        .link-btn-minimal.open{background-color:#4caf50;color:#fff}
        .link-btn-minimal.share{background-color:#ff9800;color:#fff}
        .link-btn-minimal:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.15)}
        @keyframes modalFadeIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
        @keyframes fadeIn{from{opacity:0;transform:translate(-50%,-50%)scale(0.9)}to{opacity:1;transform:translate(-50%,-50%)scale(1)}}
        @keyframes fadeOut{from{opacity:1;transform:translate(-50%,-50%)scale(1)}to{opacity:0;transform:translate(-50%,-50%)scale(0.9)}}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        .d-none{display:none!important}.d-flex{display:flex!important}.d-block{display:block!important}.flex-1{flex:1}.justify-between{justify-content:space-between}.align-center{align-items:center}.gap-1{gap:8px}.gap-2{gap:12px}.mb-1{margin-bottom:8px}.mb-2{margin-bottom:12px}.mb-3{margin-bottom:16px}.mt-1{margin-top:8px}.mt-2{margin-top:12px}.mt-3{margin-top:16px}.text-center{text-align:center}.text-gray{color:#757575}
    </style>
</head>
<body>
    <!-- Modal de Conta Bloqueada -->
    <div class="block-modal" id="blockModal">
        <div class="block-content">
            <div class="block-icon"><i class="fas fa-ban"></i></div>
            <h2 class="block-title">Conta Bloqueada</h2>
            <p class="block-message" id="blockMessage">Sua conta foi bloqueada pelo administrador.</p>
            <button class="btn btn-primary" id="logoutBlockedBtn">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </div>

    <!-- Modal de Bloqueio do Sistema (Expirado) -->
    <div class="block-system-modal" id="blockSystemModal">
        <div class="block-system-content">
            <div class="block-system-icon"><i class="fas fa-ban"></i></div>
            <h2 class="block-system-title">⏰ Sistema Bloqueado</h2>
            <div class="block-system-message" id="blockSystemMessage">
                Seu plano expirou e o acesso ao sistema está temporariamente suspenso.<br><br>
                Para continuar usando todas as funcionalidades, realize a renovação do seu plano.
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary flex-1" id="renewFromBlockBtn">
                    <i class="fas fa-sync-alt"></i> Renovar Agora
                </button>
                <button class="btn btn-secondary flex-1" id="logoutFromBlockBtn">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Alerta WhatsApp -->
    <div class="whatsapp-alert-modal" id="whatsappAlertModal">
        <div class="whatsapp-alert-content">
            <div class="whatsapp-alert-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <h2 class="whatsapp-alert-title">⚠️ ENVIE WHATSAPP AO SUPORTE</h2>
            <div class="whatsapp-alert-message" id="whatsappAlertMessageContent">
                <p>Você enviou um comprovante de renovação. Agora é necessário enviar um WhatsApp ao suporte para que sua conta seja liberada.</p>
                <div class="info-list">
                    <div class="info-item">
                        <span class="info-label">Nome da Loja:</span>
                        <span class="info-value" id="alertStoreName"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">E-mail:</span>
                        <span class="info-value" id="alertUserEmail"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Telefone:</span>
                        <span class="info-value" id="alertUserPhone"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Valor:</span>
                        <span class="info-value" id="alertPaymentAmount"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Data:</span>
                        <span class="info-value" id="alertRegistrationDate"></span>
                    </div>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary flex-1" id="sendWhatsappAlertBtn">
                    <i class="fab fa-whatsapp"></i> Enviar WhatsApp
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Aguardando Aprovação -->
    <div class="waiting-approval-modal" id="waitingApprovalModal">
        <div class="waiting-approval-content">
            <div class="waiting-approval-icon"><i class="fas fa-hourglass-half"></i></div>
            <h2 class="waiting-approval-title">⏳ AGUARDANDO APROVAÇÃO</h2>
            <div class="waiting-approval-message">
                <p>Sua solicitação de renovação foi enviada e está aguardando aprovação do administrador.</p>
                <div class="status-list">
                    <div class="status-item">
                        <div class="status-icon"><i class="fas fa-check"></i></div>
                        <div class="status-text">Comprovante enviado</div>
                    </div>
                    <div class="status-item">
                        <div class="status-icon"><i class="fas fa-check"></i></div>
                        <div class="status-text">WhatsApp enviado ao suporte</div>
                    </div>
                    <div class="status-item">
                        <div class="status-icon"><i class="fas fa-hourglass-half"></i></div>
                        <div class="status-text">Aguardando liberação</div>
                    </div>
                </div>
                <p>Você receberá uma notificação assim que sua conta for liberada.</p>
            </div>
            <button class="btn btn-primary btn-block" id="backToHomeBtn">
                <i class="fas fa-home"></i> Voltar para Página Inicial
            </button>
        </div>
    </div>

    <!-- Modal de Aviso Dias Restantes -->
    <div class="days-left-modal" id="daysLeftModal">
        <div class="days-left-content">
            <div class="days-left-icon"><i class="fas fa-calendar-day"></i></div>
            <h2 class="days-left-title">Atenção: Dias Restantes</h2>
            <div class="days-left-message" id="daysLeftMessage"></div>
            <button class="btn btn-primary btn-block" id="closeDaysLeftBtn">
                <i class="fas fa-check"></i> Entendido
            </button>
        </div>
    </div>

    <!-- Modal de Notificação WhatsApp -->
    <div class="whatsapp-notification-modal" id="whatsappNotificationModal">
        <div class="whatsapp-notification-content">
            <div class="whatsapp-icon"><i class="fab fa-whatsapp"></i></div>
            <h2 class="whatsapp-title">Enviar Notificação</h2>
            <div class="whatsapp-message">
                <strong>Mensagem que será enviada:</strong><br><br>
                <span id="whatsappMessageContent">Carregando...</span>
            </div>
            <div class="whatsapp-instructions">
                <strong>Instruções:</strong>
                <ol>
                    <li>Clique no botão "Abrir WhatsApp"</li>
                    <li>O WhatsApp será aberto com a mensagem</li>
                    <li>Verifique a mensagem e envie</li>
                    <li>Volte e clique em "Notificação Enviada"</li>
                </ol>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-secondary flex-1" id="cancelWhatsappBtn">Cancelar</button>
                <button class="btn btn-success flex-1" id="openWhatsappBtn">
                    <i class="fab fa-whatsapp"></i> Abrir WhatsApp
                </button>
                <button class="btn btn-primary flex-1" id="confirmWhatsappBtn">
                    <i class="fas fa-check"></i> Notificação Enviada
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Mudar Senha -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-lock"></i> Segurança da Conta</h2>
                <button class="close-modal" id="closeChangePasswordModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <div class="form-group">
                        <label class="form-label">Senha Atual *</label>
                        <input type="password" id="currentPassword" class="form-input" placeholder="Digite sua senha atual">
                        <div class="password-strength" style="margin-top: 5px; font-size: 0.8rem; display: none;" id="currentPasswordError">
                            <span style="color: #f44336;">Senha atual incorreta</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nova Senha *</label>
                        <input type="password" id="newPassword" class="form-input" placeholder="Digite a nova senha">
                        <div class="password-strength" style="margin-top: 5px; font-size: 0.8rem;" id="newPasswordStrength">
                            <span>A senha deve ter pelo menos 6 caracteres</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirmar Nova Senha *</label>
                        <input type="password" id="confirmPassword" class="form-input" placeholder="Confirme a nova senha">
                        <div class="password-match" style="margin-top: 5px; font-size: 0.8rem; display: none;" id="passwordMatchError">
                            <span style="color: #f44336;">As senhas não coincidem</span>
                        </div>
                    </div>
                    <div class="password-requirements" style="background-color: #f5f5f5; border-radius: 8px; padding: 12px; margin-bottom: 15px; font-size: 0.85rem;">
                        <strong>Requisitos da senha:</strong>
                        <ul style="margin: 8px 0 0 20px; padding: 0;">
                            <li>Mínimo de 6 caracteres</li>
                            <li>Recomendado usar letras, números e caracteres especiais</li>
                        </ul>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary flex-1" id="cancelChangePasswordBtn">Cancelar</button>
                        <button type="submit" class="btn btn-primary flex-1" id="submitChangePasswordBtn">
                            <i class="fas fa-save"></i> Alterar Senha
                        </button>
                    </div>
                </form>
                <div class="text-center mt-3" style="border-top: 1px solid #e0e0e0; padding-top: 15px;">
                    <p class="text-gray mb-2">Se você fez login com Google e não tem senha, ou esqueceu sua senha:</p>
                    <button type="button" class="btn btn-success btn-block" id="sendResetLinkBtn">
                        <i class="fas fa-envelope"></i> Enviar Link de Recuperação por E-mail
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay de Carregamento -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Enviando comprovante...</div>
    </div>

    <!-- Container Principal -->
    <div class="app-container">
        <header class="app-header">
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-store"></i></div>
                <div class="logo-text">
                    <h1 id="adminStoreName">Venda+</h1>
                </div>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar"></div>
                <button class="logout-btn" id="logoutBtn" title="Sair">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <main class="main-content">
            <!-- Banner de Status de Renovação -->
            <div id="renewalStatusBanner" class="d-none"></div>
            
            <!-- Banner de Conta Expirada -->
            <div id="expiredBanner" class="d-none expired-banner">
                <div class="expired-title">⏰ SEU PLANO VENCEU!</div>
                <div class="expired-message">Seu acesso ao sistema está temporariamente suspenso. Renove seu plano para continuar usando todas as funcionalidades.</div>
                <button class="btn btn-primary btn-sm" id="renewExpiredBtn">
                    <i class="fas fa-sync-alt"></i> Renover Agora
                </button>
            </div>
            
            <!-- Tela Dashboard -->
            <div id="dashboardScreen" class="screen active">
                <h2 class="section-title">Dashboard</h2>
                
                <div class="expiry-warning d-none" id="expiryWarningBanner">
                    <div class="expiry-warning-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <h3 class="mb-2" id="expiryWarningText"></h3>
                    <p class="text-gray mb-2">Renove seu plano para continuar usando.</p>
                    <button class="btn btn-primary btn-sm" id="renewPlanBannerBtn">
                        <i class="fas fa-sync-alt"></i> Renovar Plano
                    </button>
                </div>
                
                <div class="user-card" id="profileCard">
                    <div class="user-card-options">
                        <button class="user-option-btn" id="profileOptionsBtn" title="Opções">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                    <div class="user-card-header">
                        <div class="user-card-avatar" id="storeAvatar"></div>
                        <div class="user-card-info">
                            <h3 id="storeNameDisplay">Carregando...</h3>
                            <p id="storeEmail">carregando...</p>
                            <p id="storeExpiry" style="color: var(--info-color); font-size: 0.85rem;"></p>
                        </div>
                    </div>
                    
                    <!-- Menu de opções do perfil -->
                    <div class="change-password-menu" id="changePasswordMenu">
                        <div class="change-password-item" id="changePasswordMenuItem">
                            <i class="fas fa-lock"></i>
                            <span>Segurança da Conta</span>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon preparing"><i class="fas fa-clock"></i></div>
                        <div class="stat-info">
                            <h3>Preparando</h3>
                            <div class="stat-number" id="preparingOrders">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon confirmed"><i class="fas fa-check"></i></div>
                        <div class="stat-info">
                            <h3>Confirmados</h3>
                            <div class="stat-number" id="confirmedOrders">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon delivering"><i class="fas fa-motorcycle"></i></div>
                        <div class="stat-info">
                            <h3>Entregando</h3>
                            <div class="stat-number" id="deliveringOrders">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon delivered"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-info">
                            <h3>Entregues</h3>
                            <div class="stat-number" id="deliveredOrders">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon total"><i class="fas fa-chart-line"></i></div>
                        <div class="stat-info">
                            <h3>Total Pedidos</h3>
                            <div class="stat-number" id="totalOrders">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon revenue"><i class="fas fa-money-bill-wave"></i></div>
                        <div class="stat-info">
                            <h3>Receita</h3>
                            <div class="stat-number" id="totalRevenue">R$ 0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon delivery"><i class="fas fa-shipping-fast"></i></div>
                        <div class="stat-info">
                            <h3>Taxa de Entrega</h3>
                            <div class="stat-number" id="deliveryFeeStat">R$ 0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon visits"><i class="fas fa-eye"></i></div>
                        <div class="stat-info">
                            <h3>Acessos</h3>
                            <div class="stat-number" id="totalVisits">0</div>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title"><i class="fas fa-chart-bar"></i>Acessos da Loja (Últimos 7 dias)</div>
                    <canvas id="visitsChart" height="150"></canvas>
                </div>
                <h3 class="mb-2">Pedidos Recentes</h3>
                <div class="orders-list" id="recentOrdersList"></div>
                <div class="empty-state" id="recentOrdersEmpty" style="display:none">
                    <div class="empty-icon"><i class="fas fa-shopping-cart"></i></div>
                    <h3>Nenhum pedido</h3>
                    <p>Novos pedidos aparecerão aqui.</p>
                </div>
            </div>

            <!-- Tela Pedidos -->
            <div id="ordersScreen" class="screen" style="display:none">
                <h2 class="section-title">Pedidos</h2>
                <div class="status-filter">
                    <button class="status-filter-btn active" data-status="all">Todos</button>
                    <button class="status-filter-btn" data-status="preparing">Preparando</button>
                    <button class="status-filter-btn" data-status="confirmed">Confirmados</button>
                    <button class="status-filter-btn" data-status="delivering">Entregando</button>
                    <button class="status-filter-btn" data-status="delivered">Entregues</button>
                </div>
                <div class="orders-list" id="allOrdersList"></div>
                <div class="empty-state" id="allOrdersEmpty" style="display:none">
                    <div class="empty-icon"><i class="fas fa-shopping-cart"></i></div>
                    <h3>Nenhum pedido</h3>
                    <p>Os pedidos aparecerão aqui.</p>
                </div>
            </div>

            <!-- Tela Produtos -->
            <div id="productsScreen" class="screen" style="display:none">
                <div class="d-flex justify-between align-center mb-3">
                    <h2 class="section-title">Produtos</h2>
                </div>
                <div class="products-list" id="productsList"></div>
                <div class="empty-state" id="productsEmpty" style="display:none">
                    <div class="empty-icon"><i class="fas fa-box"></i></div>
                    <h3>Nenhum produto</h3>
                    <p>Adicione produtos para vender.</p>
                </div>
            </div>
            
            <!-- Botão flutuante para adicionar produtos -->
            <button class="floating-action-btn d-none" id="floatingAddProductBtn" title="Novo Produto">
                <i class="fas fa-plus"></i>
            </button>

            <!-- Tela Financeiro -->
            <div id="financeScreen" class="screen" style="display:none">
                <h2 class="section-title"><i class="fas fa-chart-pie"></i> Financeiro</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon revenue"><i class="fas fa-money-bill-wave"></i></div>
                        <div class="stat-info">
                            <h3>Receita Total</h3>
                            <div class="stat-number" id="financeTotalRevenue">R$ 0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon total"><i class="fas fa-receipt"></i></div>
                        <div class="stat-info">
                            <h3>Total Pedidos</h3>
                            <div class="stat-number" id="financeTotalOrders">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon confirmed"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-info">
                            <h3>Média por Pedido</h3>
                            <div class="stat-number" id="averageOrderValue">R$ 0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon delivery"><i class="fas fa-calendar-alt"></i></div>
                        <div class="stat-info">
                            <h3>Mês Atual</h3>
                            <div class="stat-number" id="currentMonthRevenue">R$ 0</div>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title"><i class="fas fa-chart-line"></i>Receita Mensal</div>
                    <canvas id="revenueChart" height="150"></canvas>
                </div>
                <div class="finance-tabs">
                    <button class="finance-tab active" data-tab="all">Todos os Pagamentos</button>
                    <button class="finance-tab" data-tab="monthly">Mensal</button>
                    <button class="finance-tab" data-tab="summary">Resumo</button>
                </div>
                <div id="financeAllTab" class="finance-tab-content">
                    <div class="orders-list" id="allPaymentsList"></div>
                    <div class="empty-state" id="allPaymentsEmpty" style="display:none">
                        <div class="empty-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                        <h3>Nenhum pagamento</h3>
                        <p>Os pagamentos aparecerão aqui.</p>
                    </div>
                </div>
                <div id="financeMonthlyTab" class="finance-tab-content" style="display:none">
                    <div id="monthlySummaryList"></div>
                </div>
                <div id="financeSummaryTab" class="finance-tab-content" style="display:none">
                    <div class="chart-container">
                        <div class="chart-title"><i class="fas fa-chart-pie"></i>Métodos de Pagamento</div>
                        <canvas id="paymentMethodsChart" height="150"></canvas>
                    </div>
                    <div class="monthly-summary">
                        <h3 class="mb-2">Resumo Financeiro</h3>
                        <div class="daily-orders">
                            <div class="daily-order">
                                <span>Total em PIX:</span>
                                <span class="order-amount" id="totalPixAmount">R$ 0,00</span>
                            </div>
                            <div class="daily-order">
                                <span>Total em Dinheiro:</span>
                                <span class="order-amount" id="totalMoneyAmount">R$ 0,00</span>
                            </div>
                            <div class="daily-order">
                                <span>Total em Taxas de Entrega:</span>
                                <span class="order-amount" id="totalDeliveryFees">R$ 0,00</span>
                            </div>
                            <div class="daily-order">
                                <span>Pedidos com Comprovante:</span>
                                <span class="order-amount" id="ordersWithReceipt">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tela Configurações -->
            <div id="configScreen" class="screen" style="display:none">
                <h2 class="section-title">Configurações</h2>
                <form id="configForm">
                    <div class="form-group">
                        <label class="form-label">Nome do Negócio *</label>
                        <input type="text" id="configBusinessName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Logo da Loja</label>
                        <div class="logo-preview-container">
                            <div class="logo-upload-area upload-area" id="logoUploadArea">
                                <div class="upload-icon"><i class="fas fa-image"></i></div>
                                <div class="upload-text">Clique para fazer upload</div>
                                <div class="upload-info">Tamanho máximo: 8MB</div>
                                <input type="file" id="configLogoUpload" accept="image/*" style="display:none">
                            </div>
                            <div class="logo-preview-wrapper">
                                <img id="configLogoPreview" class="logo-center-preview" alt="Logo">
                                <button class="remove-logo-btn d-none" id="removeLogoBtn" type="button">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">WhatsApp *</label>
                        <input type="text" id="configWhatsApp" class="form-input" required placeholder="(11) 99999-9999">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Chave PIX *</label>
                        <input type="text" id="configPixKey" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Título dos Produtos *</label>
                        <input type="text" id="configProductsTitle" class="form-input" required placeholder="Nossos Produtos">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Taxa de Entrega (R$)</label>
                        <input type="number" id="configDeliveryFee" class="form-input" step="0.01" min="0" value="0" placeholder="0.00">
                    </div>
                    <div class="link-section">
                        <h3 class="link-title">Link para Clientes</h3>
                        <p class="link-description">Compartilhe este link com seus clientes:</p>
                        <div class="link-container" id="customerLinkContainer">
                            <strong>Carregando link...</strong>
                        </div>
                        <div class="link-actions-minimal">
                            <button class="link-btn-minimal copy" id="copyLinkBtn" title="Copiar Link">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="link-btn-minimal open" id="openLinkBtn" title="Abrir Link">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                            <button class="link-btn-minimal share" id="shareLinkBtn" title="Compartilhar">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        </div>
                        <div class="mt-2 text-center">
                            <small><strong>Acessos totais:</strong> <span id="totalVisitsConfig">0</span></small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tema da Loja</label>
                        <div class="theme-selector">
                            <div class="theme-option theme-red" data-theme="red">
                                <div class="theme-preview" style="background:linear-gradient(135deg,#8B0000 0%,#FF0000 100%);color:#fff">Vermelho</div>
                                <div class="theme-name">Vermelho</div>
                            </div>
                            <div class="theme-option theme-blue" data-theme="blue">
                                <div class="theme-preview" style="background:linear-gradient(135deg,#00008B 0%,#4169E1 100%);color:#fff">Azul</div>
                                <div class="theme-name">Azul</div>
                            </div>
                            <div class="theme-option theme-pink" data-theme="pink">
                                <div class="theme-preview" style="background:linear-gradient(135deg,#F4C2C2 0%,#FFB6C1 100%);color:#212121">Rosa</div>
                                <div class="theme-name">Rosa</div>
                            </div>
                            <div class="theme-option theme-yellow" data-theme="yellow">
                                <div class="theme-preview" style="background:linear-gradient(135deg,#FFD700 0%,#FFEC8B 100%);color:#212121">Amarelo</div>
                                <div class="theme-name">Amarelo</div>
                            </div>
                            <div class="theme-option theme-black active" data-theme="black">
                                <div class="theme-preview" style="background:linear-gradient(135deg,#212121 0%,#424242 100%);color:#fff">Preto</div>
                                <div class="theme-name">Preto</div>
                            </div>
                            <div class="theme-option theme-purple" data-theme="purple">
                                <div class="theme-preview" style="background:linear-gradient(135deg,#8A2BE2 0%,#9370DB 100%);color:#fff">Roxo</div>
                                <div class="theme-name">Roxo</div>
                            </div>
                            <div class="theme-option theme-green" data-theme="green">
                                <div class="theme-preview" style="background:linear-gradient(135deg,#006400 0%,#32CD32 100%);color:#fff">Verde</div>
                                <div class="theme-name">Verde</div>
                            </div>
                            <div class="theme-option theme-orange" data-theme="orange">
                                <div class="theme-preview" style="background:linear-gradient(135deg,#FF8C00 0%,#FFA500 100%);color:#fff">Laranja</div>
                                <div class="theme-name">Laranja</div>
                            </div>
                        </div>
                        <input type="hidden" id="configTheme" value="black">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-save"></i> Salvar Configurações
                    </button>
                </form>
            </div>
        </main>

        <!-- Navegação Inferior -->
        <nav class="bottom-nav">
            <button class="nav-btn active" data-screen="dashboard">
                <i class="fas fa-tachometer-alt"></i><span>Dashboard</span>
            </button>
            <button class="nav-btn" data-screen="orders">
                <i class="fas fa-shopping-cart"></i><span>Pedidos</span>
                <div class="notification-badge d-none" id="ordersBadge">0</div>
            </button>
            <button class="nav-btn" data-screen="products">
                <i class="fas fa-box"></i><span>Produtos</span>
            </button>
            <button class="nav-btn" data-screen="finance">
                <i class="fas fa-chart-pie"></i><span>Financeiro</span>
            </button>
            <button class="nav-btn" data-screen="config">
                <i class="fas fa-cog"></i><span>Configurações</span>
            </button>
        </nav>
    </div>

    <!-- Modal Detalhes do Pedido -->
    <div class="modal" id="orderDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Detalhes do Pedido</h2>
                <button class="close-modal" id="closeOrderModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="orderDetailsContent"></div>
            </div>
        </div>
    </div>

    <!-- Modal Formulário do Produto -->
    <div class="modal" id="productFormModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="productModalTitle">Novo Produto</h2>
                <button class="close-modal" id="closeProductModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="form-group">
                        <label class="form-label">Nome do Produto *</label>
                        <input type="text" id="productName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Descrição *</label>
                        <textarea id="productDescription" class="form-input" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Preço (R$) *</label>
                        <input type="number" id="productPrice" class="form-input" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categoria *</label>
                        <div class="d-flex gap-2 align-center">
                            <select id="productCategory" class="form-input flex-1" required>
                                <option value="">Selecione...</option>
                            </select>
                            <button type="button" class="btn btn-primary btn-sm" id="addCategoryCompactBtn" title="Adicionar Categoria">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="compact-categories mt-2" id="compactCategoriesList"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Imagens do Produto (Máximo 3)</label>
                        <div class="upload-area" id="productImageUploadArea">
                            <div class="upload-icon"><i class="fas fa-image"></i></div>
                            <div class="upload-text">Clique para adicionar imagens</div>
                            <div class="upload-info">Máximo 3 imagens - Tamanho máximo: 8MB cada</div>
                            <input type="file" id="productImageUpload" accept="image/*" multiple style="display:none">
                        </div>
                        <div class="image-counter" id="imageCounter">0/3 imagens selecionadas</div>
                        <div class="multiple-images-container">
                            <div class="images-preview-container" id="productImagesPreview">
                                <!-- As imagens serão adicionadas aqui dinamicamente -->
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <div class="d-flex align-center gap-2">
                            <label class="toggle-switch">
                                <input type="checkbox" id="productActive" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Ativo</span>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary flex-1" id="cancelProductBtn">Cancelar</button>
                        <button type="submit" class="btn btn-primary flex-1">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Zoom de Imagem -->
    <div class="image-zoom-modal" id="imageZoomModal">
        <div class="image-zoom-content">
            <button class="close-zoom" id="closeZoom">&times;</button>
            <img id="zoomedImage" src="" alt="Imagem ampliada">
        </div>
    </div>

    <!-- Modal Aviso de Vencimento -->
    <div class="modal" id="expiryWarningModal" style="display:none">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">⚠️ Aviso de Vencimento</h2>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="mb-3" style="font-size:3rem;color:#ff9800">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 class="mb-2">Seu plano está prestes a vencer!</h3>
                    <p class="mb-3" id="expiryWarningMessage"></p>
                    <p class="text-gray">Renove seu plano para continuar usando.</p>
                    <div class="d-flex gap-2 mt-3">
                        <button class="btn btn-primary flex-1" id="renewPlanBtn">
                            <i class="fas fa-sync-alt"></i> Renovar Plano
                        </button>
                        <button class="btn btn-secondary flex-1" id="closeExpiryWarningBtn">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Renovação de Pagamento -->
    <div class="modal" id="renewPaymentModal" style="display:none">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🔄 Renovar Plano</h2>
                <button class="close-modal" id="closeRenewModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="payment-icon" style="font-size:3rem;color:#212121">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <h3 class="mb-2">Renovação do Plano Mensal</h3>
                    <p class="text-gray">Realize o pagamento para renovar seu plano.</p>
                </div>
                <div class="pix-info" style="background-color:#f0f9ff;border-radius:12px;padding:20px;margin-bottom:20px;border:2px dashed #2196f3">
                    <div class="pix-title" style="font-size:1.1rem;font-weight:600;color:#2196f3;margin-bottom:10px">Pagamento via PIX</div>
                    <div class="pix-key" style="background-color:#fff;padding:15px;border-radius:8px;font-family:monospace;word-break:break-all;margin-bottom:15px;border:1px solid #e0e0e0" id="renewPixKeyDisplay">
                        Carregando chave PIX...
                    </div>
                    <p>Copie a chave PIX e faça o pagamento.</p>
                    <div class="plan-price" style="font-size:1.8rem;font-weight:700;color:#212121;text-align:center;margin-top:15px" id="renewPlanPrice">
                        R$ 99,00
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Envie o comprovante da renovação</label>
                    <div class="upload-area" id="renewReceiptUploadArea">
                        <div class="upload-icon"><i class="fas fa-file-upload"></i></div>
                        <div class="upload-text">Clique para fazer upload</div>
                        <div class="upload-info">Aceitamos imagens (JPG, PNG) ou PDF - Tamanho máximo: 8MB</div>
                        <div class="file-types">
                            <span class="file-type-badge">JPG</span>
                            <span class="file-type-badge">PNG</span>
                            <span class="file-type-badge">PDF</span>
                        </div>
                        <input type="file" id="renewReceiptUpload" accept="image/*,.pdf" style="display:none">
                    </div>
                    <img id="renewReceiptImagePreview" class="image-preview" alt="Comprovante">
                    <div class="pdf-preview" id="renewReceiptPdfPreview">
                        <i class="fas fa-file-pdf"></i>
                        <div class="upload-text" id="renewPdfFileName">comprovante.pdf</div>
                        <div class="upload-info">Clique para visualizar</div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Observações (opcional)</label>
                    <textarea id="renewPaymentNotes" class="form-input" rows="3" placeholder="Alguma observação..."></textarea>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-secondary flex-1" id="cancelRenewBtn">Cancelar</button>
                    <button type="button" class="btn btn-primary flex-1" id="submitRenewBtn">
                        <i class="fas fa-paper-plane"></i> Concluir Renovação
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB7U-JfKAlkPxSyL4AEf5u0BgcDzSXf41M",
            authDomain: "appvendas-1eebf.firebaseapp.com",
            projectId: "appvendas-1eebf",
            storageBucket: "appvendas-1eebf.firebasestorage.app",
            messagingSenderId: "229472373918",
            appId: "1:229472373918:web:39cd4940b052b2375f3f8f"
        };
        
        // Inicialização do Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Variáveis globais
        let currentUser = null;
        let currentStoreId = null;
        let currentScreen = 'dashboard';
        let orders = [];
        let products = [];
        let categories = [];
        let storeConfig = {};
        let selectedOrder = null;
        let selectedProduct = null;
        let statusFilter = 'all';
        let logoBase64 = '';
        let productImagesBase64 = [];
        let ordersListener = null;
        let customerLink = '';
        let preparingOrdersCount = 0;
        let phoneMask = null;
        let userConfigCompleted = false;
        let storeVisits = 0;
        let dailyVisitsData = [];
        let visitsChart = null;
        let revenueChart = null;
        let paymentMethodsChart = null;
        let financeTab = 'all';
        let pinchZoom = null;
        let lastTouchDistance = null;
        let renewReceiptBase64 = '';
        let renewReceiptType = '';
        let renewReceiptFileName = '';
        let userActivityListener = null;
        let whatsappNotificationType = null;
        let whatsappNotificationData = null;
        let currentPaymentRecord = null;
        let supportPhone = null;
        let paymentRecordId = null;
        let renewalStatus = 'none';
        let expiryDate = null;
        let expiryWarningModalShown = false;
        let isSystemBlocked = false;
        let temporaryModalTimeout = null;
        let userHasPassword = false;

        // Elementos do DOM
        const welcomeModal = document.getElementById('welcomeModal');
        const goToConfigBtn = document.getElementById('goToConfigBtn');
        const screens = document.querySelectorAll('.screen');
        const navBtns = document.querySelectorAll('.nav-btn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userAvatar = document.getElementById('userAvatar');
        const storeAvatar = document.getElementById('storeAvatar');
        const storeNameDisplay = document.getElementById('storeNameDisplay');
        const storeEmail = document.getElementById('storeEmail');
        const storeExpiry = document.getElementById('storeExpiry');
        const adminStoreName = document.getElementById('adminStoreName');
        const customerLinkContainer = document.getElementById('customerLinkContainer');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const openLinkBtn = document.getElementById('openLinkBtn');
        const shareLinkBtn = document.getElementById('shareLinkBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const whatsappAlertModal = document.getElementById('whatsappAlertModal');
        const alertStoreName = document.getElementById('alertStoreName');
        const alertUserEmail = document.getElementById('alertUserEmail');
        const alertUserPhone = document.getElementById('alertUserPhone');
        const alertPaymentAmount = document.getElementById('alertPaymentAmount');
        const alertRegistrationDate = document.getElementById('alertRegistrationDate');
        const sendWhatsappAlertBtn = document.getElementById('sendWhatsappAlertBtn');
        const waitingApprovalModal = document.getElementById('waitingApprovalModal');
        const backToHomeBtn = document.getElementById('backToHomeBtn');
        const whatsappNotificationModal = document.getElementById('whatsappNotificationModal');
        const whatsappMessageContent = document.getElementById('whatsappMessageContent');
        const cancelWhatsappBtn = document.getElementById('cancelWhatsappBtn');
        const openWhatsappBtn = document.getElementById('openWhatsappBtn');
        const confirmWhatsappBtn = document.getElementById('confirmWhatsappBtn');
        const expiryWarningModal = document.getElementById('expiryWarningModal');
        const expiryWarningMessage = document.getElementById('expiryWarningMessage');
        const renewPlanBtn = document.getElementById('renewPlanBtn');
        const closeExpiryWarningBtn = document.getElementById('closeExpiryWarningBtn');
        const expiryWarningBanner = document.getElementById('expiryWarningBanner');
        const expiryWarningText = document.getElementById('expiryWarningText');
        const renewPlanBannerBtn = document.getElementById('renewPlanBannerBtn');
        const renewalStatusBanner = document.getElementById('renewalStatusBanner');
        const expiredBanner = document.getElementById('expiredBanner');
        const renewExpiredBtn = document.getElementById('renewExpiredBtn');
        const preparingOrdersCountElement = document.getElementById('preparingOrders');
        const confirmedOrdersCountElement = document.getElementById('confirmedOrders');
        const deliveringOrdersCountElement = document.getElementById('deliveringOrders');
        const deliveredOrdersCountElement = document.getElementById('deliveredOrders');
        const totalOrdersCountElement = document.getElementById('totalOrders');
        const totalRevenueElement = document.getElementById('totalRevenue');
        const deliveryFeeStat = document.getElementById('deliveryFeeStat');
        const totalVisitsElement = document.getElementById('totalVisits');
        const totalVisitsConfig = document.getElementById('totalVisitsConfig');
        const recentOrdersList = document.getElementById('recentOrdersList');
        const recentOrdersEmpty = document.getElementById('recentOrdersEmpty');
        const financeTotalRevenue = document.getElementById('financeTotalRevenue');
        const financeTotalOrders = document.getElementById('financeTotalOrders');
        const averageOrderValue = document.getElementById('averageOrderValue');
        const currentMonthRevenue = document.getElementById('currentMonthRevenue');
        const financeTabs = document.querySelectorAll('.finance-tab');
        const allPaymentsList = document.getElementById('allPaymentsList');
        const allPaymentsEmpty = document.getElementById('allPaymentsEmpty');
        const monthlySummaryList = document.getElementById('monthlySummaryList');
        const totalPixAmount = document.getElementById('totalPixAmount');
        const totalMoneyAmount = document.getElementById('totalMoneyAmount');
        const totalDeliveryFees = document.getElementById('totalDeliveryFees');
        const ordersWithReceipt = document.getElementById('ordersWithReceipt');
        const statusFilterBtns = document.querySelectorAll('.status-filter-btn');
        const allOrdersList = document.getElementById('allOrdersList');
        const allOrdersEmpty = document.getElementById('allOrdersEmpty');
        const ordersBadge = document.getElementById('ordersBadge');
        const productsList = document.getElementById('productsList');
        const productsEmpty = document.getElementById('productsEmpty');
        const floatingAddProductBtn = document.getElementById('floatingAddProductBtn');
        const configForm = document.getElementById('configForm');
        const configBusinessName = document.getElementById('configBusinessName');
        const logoUploadArea = document.getElementById('logoUploadArea');
        const configLogoUpload = document.getElementById('configLogoUpload');
        const configLogoPreview = document.getElementById('configLogoPreview');
        const removeLogoBtn = document.getElementById('removeLogoBtn');
        const configWhatsApp = document.getElementById('configWhatsApp');
        const configPixKey = document.getElementById('configPixKey');
        const configProductsTitle = document.getElementById('configProductsTitle');
        const configDeliveryFee = document.getElementById('configDeliveryFee');
        const configTheme = document.getElementById('configTheme');
        const themeOptions = document.querySelectorAll('.theme-option');
        const categoriesList = document.getElementById('categoriesList');
        const newCategoryName = document.getElementById('newCategoryName');
        const addCategoryBtn = document.getElementById('addCategoryBtn');
        const productForm = document.getElementById('productForm');
        const productIdInput = document.getElementById('productId');
        const productModalTitle = document.getElementById('productModalTitle');
        const productName = document.getElementById('productName');
        const productDescription = document.getElementById('productDescription');
        const productPrice = document.getElementById('productPrice');
        const productCategory = document.getElementById('productCategory');
        const addCategoryCompactBtn = document.getElementById('addCategoryCompactBtn');
        const compactCategoriesList = document.getElementById('compactCategoriesList');
        const productImageUploadArea = document.getElementById('productImageUploadArea');
        const productImageUpload = document.getElementById('productImageUpload');
        const productImagesPreview = document.getElementById('productImagesPreview');
        const imageCounter = document.getElementById('imageCounter');
        const productActive = document.getElementById('productActive');
        const cancelProductBtn = document.getElementById('cancelProductBtn');
        const renewPaymentModal = document.getElementById('renewPaymentModal');
        const closeRenewModal = document.getElementById('closeRenewModal');
        const renewPixKeyDisplay = document.getElementById('renewPixKeyDisplay');
        const renewPlanPrice = document.getElementById('renewPlanPrice');
        const renewReceiptUploadArea = document.getElementById('renewReceiptUploadArea');
        const renewReceiptUpload = document.getElementById('renewReceiptUpload');
        const renewReceiptImagePreview = document.getElementById('renewReceiptImagePreview');
        const renewReceiptPdfPreview = document.getElementById('renewReceiptPdfPreview');
        const renewPdfFileName = document.getElementById('renewPdfFileName');
        const renewPaymentNotes = document.getElementById('renewPaymentNotes');
        const cancelRenewBtn = document.getElementById('cancelRenewBtn');
        const submitRenewBtn = document.getElementById('submitRenewBtn');
        const blockModal = document.getElementById('blockModal');
        const blockMessage = document.getElementById('blockMessage');
        const logoutBlockedBtn = document.getElementById('logoutBlockedBtn');
        const blockSystemModal = document.getElementById('blockSystemModal');
        const blockSystemMessage = document.getElementById('blockSystemMessage');
        const renewFromBlockBtn = document.getElementById('renewFromBlockBtn');
        const logoutFromBlockBtn = document.getElementById('logoutFromBlockBtn');
        const orderDetailsModal = document.getElementById('orderDetailsModal');
        const closeOrderModal = document.getElementById('closeOrderModal');
        const productFormModal = document.getElementById('productFormModal');
        const closeProductModal = document.getElementById('closeProductModal');
        const imageZoomModal = document.getElementById('imageZoomModal');
        const closeZoom = document.getElementById('closeZoom');
        const zoomedImage = document.getElementById('zoomedImage');
        const daysLeftModal = document.getElementById('daysLeftModal');
        const daysLeftMessage = document.getElementById('daysLeftMessage');
        const closeDaysLeftBtn = document.getElementById('closeDaysLeftBtn');
        const profileCard = document.getElementById('profileCard');
        const profileOptionsBtn = document.getElementById('profileOptionsBtn');
        const changePasswordMenu = document.getElementById('changePasswordMenu');
        const changePasswordMenuItem = document.getElementById('changePasswordMenuItem');
        const changePasswordModal = document.getElementById('changePasswordModal');
        const closeChangePasswordModal = document.getElementById('closeChangePasswordModal');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const currentPassword = document.getElementById('currentPassword');
        const newPassword = document.getElementById('newPassword');
        const confirmPassword = document.getElementById('confirmPassword');
        const currentPasswordError = document.getElementById('currentPasswordError');
        const newPasswordStrength = document.getElementById('newPasswordStrength');
        const passwordMatchError = document.getElementById('passwordMatchError');
        const cancelChangePasswordBtn = document.getElementById('cancelChangePasswordBtn');
        const submitChangePasswordBtn = document.getElementById('submitChangePasswordBtn');
        const sendResetLinkBtn = document.getElementById('sendResetLinkBtn');

        // Função de inicialização
        async function init() {
            await checkAuth();
            await checkUserStatus();
            await loadUserData();
            await loadStoreConfig();
            await loadCategories();
            await loadSystemConfig();
            setupPhoneMasks();
            setupEventListeners();
            setupOrdersListener();
            setupUserActivityListener();
            loadProducts();
            updateCustomerLink();
            showScreen('dashboard');
            await loadStoreVisits();
            await checkExpiryStatus();
            await checkRenewalStatus();
            await checkIfUserHasPassword();
        }

        async function checkIfUserHasPassword() {
            try {
                const user = auth.currentUser;
                if (user) {
                    const providers = user.providerData || [];
                    const hasGoogleOnly = providers.length === 1 && providers[0].providerId === 'google.com';
                    const hasPasswordProvider = providers.some(provider => 
                        provider.providerId === 'password' || provider.providerId === 'email'
                    );
                    
                    userHasPassword = hasPasswordProvider || !hasGoogleOnly;
                    
                    if (!userHasPassword) {
                        currentPassword.placeholder = "Você não tem senha cadastrada";
                        currentPassword.disabled = true;
                        currentPassword.style.opacity = "0.7";
                    }
                }
            } catch (error) {
                console.error('Error checking user password:', error);
                userHasPassword = true;
            }
        }

        async function loadSystemConfig() {
            try {
                const configDoc = await db.collection('systemConfig').doc('paymentSettings').get();
                if (configDoc.exists) {
                    const configData = configDoc.data();
                    supportPhone = configData.adminWhatsApp || "+5511999999999";
                } else {
                    supportPhone = "+5511999999999";
                }
            } catch (error) {
                console.error('Error loading system config:', error);
                supportPhone = "+5511999999999";
            }
        }

        function setupPhoneMasks() {
            const phoneMaskOptions = {
                mask: '(00) 00000-0000',
                lazy: false
            };
            
            if (configWhatsApp) {
                phoneMask = new IMask(configWhatsApp, phoneMaskOptions);
            }
        }

        async function checkUserStatus() {
            try {
                if (!currentStoreId) return;
                
                const userDoc = await db.collection('users').doc(currentStoreId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    if (userData.status === 'blocked' || userData.isActive === false) {
                        showBlockModal('Sua conta foi bloqueada pelo administrador.');
                        return false;
                    }
                }
                return true;
            } catch (error) {
                console.error('Error checking user status:', error);
            }
            return true;
        }

        function showBlockModal(message) {
            blockMessage.textContent = message;
            blockModal.style.display = 'flex';
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.pointerEvents = 'none';
            });
            
            logoutBtn.disabled = true;
            document.querySelectorAll('.screen').forEach(screen => {
                screen.style.display = 'none';
            });
        }

        async function checkRenewalStatus() {
            try {
                const userDoc = await db.collection('users').doc(currentStoreId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    renewalStatus = userData.renewalStatus || 'none';
                    expiryDate = userData.expiryDate || null;
                    updateRenewalStatusBanner();
                }
            } catch (error) {
                console.error('Error checking renewal status:', error);
            }
        }

        function updateRenewalStatusBanner() {
            renewalStatusBanner.innerHTML = '';
            
            if (renewalStatus === 'pending' || renewalStatus === 'pending_approval') {
                renewalStatusBanner.className = 'renewal-status-banner';
                renewalStatusBanner.innerHTML = `
                    <div class="renewal-status-info">
                        <div class="renewal-status-title">🔄 Renovação em andamento</div>
                        <div class="renewal-status-message">Sua solicitação de renovação está sendo processada. Aguarde a aprovação do administrador.</div>
                    </div>
                `;
                renewalStatusBanner.classList.remove('d-none');
            } else {
                renewalStatusBanner.classList.add('d-none');
            }
        }

        async function checkExpiryStatus() {
            try {
                const storedUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (!expiryDate) return;
                
                const expiry = new Date(expiryDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                expiry.setHours(0, 0, 0, 0);
                
                const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                
                if (daysUntilExpiry <= 0) {
                    isSystemBlocked = true;
                    expiredBanner.classList.remove('d-none');
                    expiryWarningBanner.classList.add('d-none');
                    storeExpiry.innerHTML = `<span style="color:var(--danger-color);"><i class="fas fa-exclamation-circle"></i> Expirado em ${formatDate(expiryDate)}</span>`;
                    
                    setTimeout(() => {
                        blockSystem();
                    }, 1000);
                    return;
                }
                
                const warningDays = 7;
                if (daysUntilExpiry <= warningDays && daysUntilExpiry > 0) {
                    const bannerMessage = daysUntilExpiry === 1 ? 
                        'Seu plano vence AMANHÃ!' : 
                        `Seu plano vence em ${daysUntilExpiry} dias.`;
                    
                    expiryWarningText.textContent = bannerMessage;
                    expiryWarningBanner.classList.remove('d-none');
                    
                    storeExpiry.innerHTML = `<span style="color:var(--warning-color);"><i class="fas fa-clock"></i> Vence em ${daysUntilExpiry} dia${daysUntilExpiry === 1 ? '' : 's'}</span>`;
                    
                    if (daysUntilExpiry <= 3 && !expiryWarningModalShown) {
                        const modalMessage = daysUntilExpiry === 1 ? 
                            'Seu plano vence AMANHÃ!' : 
                            `Seu plano vence em ${daysUntilExpiry} dias.`;
                        
                        expiryWarningMessage.textContent = modalMessage;
                        expiryWarningModal.style.display = 'flex';
                        expiryWarningModalShown = true;
                        
                        localStorage.setItem('expiryWarningShown', new Date().toDateString());
                    }
                    
                    if (daysUntilExpiry <= 5) {
                        showDaysLeftModal(daysUntilExpiry);
                    }
                } else {
                    expiryWarningBanner.classList.add('d-none');
                    expiryWarningModal.style.display = 'none';
                    storeExpiry.innerHTML = `<span style="color:var(--success-color);"><i class="fas fa-check-circle"></i> Válido até ${formatDate(expiryDate)}</span>`;
                }
            } catch (error) {
                console.error('Error checking expiry warning:', error);
            }
        }

        function showDaysLeftModal(daysLeft) {
            const message = daysLeft === 1 ? 
                'Seu plano vence amanhã! Renove para continuar usando todas as funcionalidades.' : 
                `Seu plano vence em ${daysLeft} dias. Recomendamos renovar antecipadamente para evitar interrupções.`;
            
            daysLeftMessage.textContent = message;
            daysLeftModal.style.display = 'flex';
        }

        function blockSystem() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.pointerEvents = 'none';
            });
            
            logoutBtn.disabled = true;
            
            document.querySelectorAll('.screen').forEach(screen => {
                screen.style.display = 'none';
            });
            
            blockSystemModal.style.display = 'flex';
        }

        function unblockSystem() {
            isSystemBlocked = false;
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
            });
            
            logoutBtn.disabled = false;
            
            showScreen(currentScreen);
            
            blockSystemModal.style.display = 'none';
            expiredBanner.classList.add('d-none');
        }

        function showTemporaryRenewalModal() {
            const existingModal = document.querySelector('.temporary-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const temporaryModal = document.createElement('div');
            temporaryModal.className = 'temporary-modal';
            temporaryModal.innerHTML = `
                <div class="temporary-modal-icon">
                    <i class="fas fa-sync-alt fa-spin"></i>
                </div>
                <div class="temporary-modal-message">
                    Renovação em processamento...
                </div>
            `;
            
            document.body.appendChild(temporaryModal);
            
            if (temporaryModalTimeout) {
                clearTimeout(temporaryModalTimeout);
            }
            
            temporaryModalTimeout = setTimeout(() => {
                if (temporaryModal.parentNode) {
                    temporaryModal.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => {
                        if (temporaryModal.parentNode) {
                            temporaryModal.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }

        async function checkAuth() {
            try {
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                    currentStoreId = currentUser.uid;
                    return true;
                }
                
                await new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged((user) => {
                        unsubscribe();
                        if (user) {
                            currentUser = {
                                uid: user.uid,
                                email: user.email,
                                isAdmin: true
                            };
                            currentStoreId = user.uid;
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            resolve(true);
                        } else {
                            window.location.href = 'login.html';
                            reject(new Error('Not authenticated'));
                        }
                    });
                });
                return true;
            } catch (error) {
                console.error('Auth error:', error);
                window.location.href = 'login.html';
                return false;
            }
        }

        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentStoreId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    currentUser.storeName = userData.storeName;
                    currentUser.expiryDate = userData.expiryDate || null;
                    currentUser.phone = userData.phone || '';
                    userConfigCompleted = userData.configCompleted || false;
                    renewalStatus = userData.renewalStatus || 'none';
                    expiryDate = userData.expiryDate || null;
                    
                    const lastWarningDate = localStorage.getItem('expiryWarningShown');
                    expiryWarningModalShown = lastWarningDate === new Date().toDateString();
                    
                    updateUserAvatar();
                    updateStoreAvatar();
                    storeNameDisplay.textContent = userData.storeName || 'Minha Loja';
                    storeEmail.textContent = currentUser.email;
                    adminStoreName.textContent = `Venda+`;
                    
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function updateUserAvatar() {
            if (storeConfig.logoBase64) {
                userAvatar.style.backgroundImage = `url(${storeConfig.logoBase64})`;
                userAvatar.textContent = '';
            } else {
                userAvatar.style.backgroundImage = '';
                userAvatar.textContent = '';
            }
        }

        function updateStoreAvatar() {
            if (storeConfig.logoBase64) {
                storeAvatar.style.backgroundImage = `url(${storeConfig.logoBase64})`;
                storeAvatar.textContent = '';
            } else {
                storeAvatar.style.backgroundImage = '';
                storeAvatar.textContent = '';
            }
        }

        function setupUserActivityListener() {
            if (userActivityListener) {
                userActivityListener();
            }
            
            recordUserActivity('login');
            
            document.addEventListener('click', () => {
                recordUserActivity('interaction');
            });
            
            navBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const screen = btn.getAttribute('data-screen');
                    recordUserActivity(`navigate_${screen}`);
                });
            });
        }

        async function recordUserActivity(action) {
            try {
                if (!currentStoreId) return;
                
                const activityData = {
                    userId: currentStoreId,
                    action: action,
                    timestamp: new Date().toISOString(),
                    userEmail: currentUser.email,
                    storeName: currentUser.storeName || 'Minha Loja'
                };
                
                await db.collection('userActivities').add(activityData);
                
                await db.collection('users').doc(currentStoreId).update({
                    lastActivity: new Date().toISOString()
                });
            } catch (error) {
                console.error('Error recording user activity:', error);
            }
        }

        async function loadStoreConfig() {
            try {
                const configDoc = await db.collection('stores').doc(currentStoreId).get();
                if (configDoc.exists) {
                    storeConfig = configDoc.data();
                    updateConfigForm();
                    updateUserAvatar();
                    updateStoreAvatar();
                } else {
                    storeConfig = {
                        businessName: currentUser.storeName || 'Minha Loja',
                        logoBase64: '',
                        whatsappNumber: '',
                        pixKey: '',
                        productsTitle: 'Nossos Produtos',
                        deliveryFee: 0,
                        theme: 'black',
                        ownerId: currentStoreId,
                        createdAt: new Date().toISOString()
                    };
                    await db.collection('stores').doc(currentStoreId).set(storeConfig);
                    updateConfigForm();
                }
            } catch (error) {
                console.error('Error loading store config:', error);
                showNotification('Erro ao carregar configurações.', 'error');
            }
        }

        async function loadCategories() {
            try {
                const categoriesDoc = await db.collection('stores').doc(currentStoreId).collection('categories').get();
                categories = [];
                categoriesDoc.forEach(doc => {
                    categories.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                updateCompactCategories();
                updateProductCategorySelect();
            } catch (error) {
                console.error('Error loading categories:', error);
                await createDefaultCategories();
            }
        }

        async function createDefaultCategories() {
            const defaultCategories = [
                { name: 'Alimentos', createdAt: new Date().toISOString() },
                { name: 'Bebidas', createdAt: new Date().toISOString() },
                { name: 'Artesanato', createdAt: new Date().toISOString() },
                { name: 'Outros', createdAt: new Date().toISOString() }
            ];
            
            try {
                for (const category of defaultCategories) {
                    await db.collection('stores').doc(currentStoreId).collection('categories').add({
                        ...category,
                        storeId: currentStoreId
                    });
                }
                await loadCategories();
            } catch (error) {
                console.error('Error creating default categories:', error);
            }
        }

        function updateCompactCategories() {
            compactCategoriesList.innerHTML = '';
            
            if (categories.length === 0) {
                compactCategoriesList.innerHTML = '<small class="text-gray">Nenhuma categoria criada ainda</small>';
                return;
            }
            
            categories.forEach(category => {
                const categoryElement = document.createElement('div');
                categoryElement.className = 'compact-category-tag';
                categoryElement.innerHTML = `
                    <span>${category.name}</span>
                    <button class="delete-category-btn" data-id="${category.id}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                compactCategoriesList.appendChild(categoryElement);
            });
            
            document.querySelectorAll('.compact-category-tag .delete-category-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const categoryId = e.currentTarget.getAttribute('data-id');
                    await deleteCategory(categoryId);
                });
            });
        }

        function updateProductCategorySelect() {
            const select = document.getElementById('productCategory');
            if (!select) return;
            
            select.innerHTML = '<option value="">Selecione...</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
        }

        async function addCategoryCompact() {
            const categoryName = prompt('Digite o nome da nova categoria:');
            if (!categoryName || !categoryName.trim()) {
                showNotification('Nome da categoria é obrigatório.', 'error');
                return;
            }
            
            try {
                await db.collection('stores').doc(currentStoreId).collection('categories').add({
                    name: categoryName.trim(),
                    storeId: currentStoreId,
                    createdAt: new Date().toISOString()
                });
                
                await loadCategories();
                showNotification('Categoria adicionada com sucesso!', 'success');
            } catch (error) {
                console.error('Error adding category:', error);
                showNotification('Erro ao adicionar categoria.', 'error');
            }
        }

        async function deleteCategory(categoryId) {
            if (!confirm('Tem certeza que deseja excluir esta categoria?')) return;
            
            try {
                const productsSnapshot = await db.collection('stores').doc(currentStoreId).collection('products')
                    .where('category', '==', categoryId).get();
                
                if (!productsSnapshot.empty) {
                    showNotification('Não é possível excluir esta categoria porque existem produtos vinculados a ela.', 'error');
                    return;
                }
                
                await db.collection('stores').doc(currentStoreId).collection('categories').doc(categoryId).delete();
                await loadCategories();
                showNotification('Categoria excluída com sucesso!', 'success');
            } catch (error) {
                console.error('Error deleting category:', error);
                showNotification('Erro ao excluir categoria.', 'error');
            }
        }

        async function loadStoreVisits() {
            try {
                const visitsDoc = await db.collection('storeVisits').doc(currentStoreId).get();
                if (visitsDoc.exists) {
                    const visitsData = visitsDoc.data();
                    storeVisits = visitsData.totalVisits || 0;
                    dailyVisitsData = visitsData.dailyVisits || [];
                    totalVisitsElement.textContent = storeVisits;
                    totalVisitsConfig.textContent = storeVisits;
                    updateVisitsChart();
                } else {
                    await db.collection('storeVisits').doc(currentStoreId).set({
                        totalVisits: 0,
                        dailyVisits: [],
                        storeId: currentStoreId,
                        lastUpdated: new Date().toISOString()
                    });
                }
            } catch (error) {
                console.error('Error loading store visits:', error);
            }
        }

        function updateVisitsChart() {
            const ctx = document.getElementById('visitsChart').getContext('2d');
            const last7Days = [];
            const visitsData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('pt-BR', { weekday: 'short' });
                last7Days.push(dateStr);
                
                const dateString = date.toISOString().split('T')[0];
                const visitsForDay = dailyVisitsData.find(v => v.date === dateString)?.count || 0;
                visitsData.push(visitsForDay);
            }
            
            if (visitsChart) {
                visitsChart.destroy();
            }
            
            visitsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'Acessos',
                        data: visitsData,
                        borderColor: '#212121',
                        backgroundColor: 'rgba(33,33,33,0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateFinanceCharts() {
            const monthlyRevenue = {};
            
            orders.forEach(order => {
                if (order.total) {
                    const date = new Date(order.timestamp || order.createdAt);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const monthName = date.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
                    
                    if (!monthlyRevenue[monthKey]) {
                        monthlyRevenue[monthKey] = { name: monthName, revenue: 0 };
                    }
                    monthlyRevenue[monthKey].revenue += order.total;
                }
            });
            
            const sortedMonths = Object.keys(monthlyRevenue).sort().reverse().slice(0, 6);
            const monthLabels = sortedMonths.map(key => monthlyRevenue[key].name);
            const monthData = sortedMonths.map(key => monthlyRevenue[key].revenue);
            
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            if (revenueChart) {
                revenueChart.destroy();
            }
            
            revenueChart = new Chart(revenueCtx, {
                type: 'bar',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'Receita (R$)',
                        data: monthData,
                        backgroundColor: 'rgba(76,175,80,0.6)',
                        borderColor: '#4caf50',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
            
            const paymentMethods = { pix: 0, money: 0 };
            orders.forEach(order => {
                if (order.paymentMethod && order.total) {
                    paymentMethods[order.paymentMethod] += order.total;
                }
            });
            
            const paymentCtx = document.getElementById('paymentMethodsChart').getContext('2d');
            if (paymentMethodsChart) {
                paymentMethodsChart.destroy();
            }
            
            paymentMethodsChart = new Chart(paymentCtx, {
                type: 'doughnut',
                data: {
                    labels: ['PIX', 'Dinheiro'],
                    datasets: [{
                        data: [paymentMethods.pix, paymentMethods.money],
                        backgroundColor: ['#4caf50', '#2196f3'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            let totalPix = 0;
            let totalMoney = 0;
            let totalDelivery = 0;
            let ordersWithReceiptCount = 0;
            
            orders.forEach(order => {
                if (order.paymentMethod === 'pix') {
                    totalPix += order.total || 0;
                } else if (order.paymentMethod === 'money') {
                    totalMoney += order.total || 0;
                }
                totalDelivery += order.deliveryFee || 0;
                if (order.receiptBase64) {
                    ordersWithReceiptCount++;
                }
            });
            
            totalPixAmount.textContent = `R$ ${totalPix.toFixed(2).replace('.', ',')}`;
            totalMoneyAmount.textContent = `R$ ${totalMoney.toFixed(2).replace('.', ',')}`;
            totalDeliveryFees.textContent = `R$ ${totalDelivery.toFixed(2).replace('.', ',')}`;
            ordersWithReceipt.textContent = ordersWithReceiptCount;
        }

        function updateConfigForm() {
            configBusinessName.value = storeConfig.businessName || '';
            configWhatsApp.value = storeConfig.whatsappNumber || '';
            configPixKey.value = storeConfig.pixKey || '';
            configProductsTitle.value = storeConfig.productsTitle || 'Nossos Produtos';
            configDeliveryFee.value = storeConfig.deliveryFee || 0;
            configTheme.value = storeConfig.theme || 'black';
            
            themeOptions.forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('data-theme') === configTheme.value) {
                    option.classList.add('active');
                }
            });
            
            if (storeConfig.logoBase64) {
                configLogoPreview.src = storeConfig.logoBase64;
                configLogoPreview.style.display = 'block';
                logoUploadArea.classList.add('hidden');
                removeLogoBtn.classList.remove('d-none');
                logoBase64 = storeConfig.logoBase64;
            } else {
                configLogoPreview.style.display = 'none';
                logoUploadArea.classList.remove('hidden');
                removeLogoBtn.classList.add('d-none');
                logoBase64 = '';
            }
            
            deliveryFeeStat.textContent = `R$ ${(storeConfig.deliveryFee || 0).toFixed(2)}`;
        }

        function updateCustomerLink() {
            if (!currentStoreId) return;
            
            const currentUrl = window.location.origin + window.location.pathname;
            const baseUrl = currentUrl.replace('painelvendas.html', '');
            customerLink = `${baseUrl}vitrine.html?store=${currentStoreId}`;
            customerLinkContainer.innerHTML = `<strong>${customerLink}</strong>`;
        }

        function setupOrdersListener() {
            if (ordersListener) {
                ordersListener();
            }
            
            ordersListener = db.collection('orders')
                .where('storeId', '==', currentStoreId)
                .onSnapshot((snapshot) => {
                    orders = [];
                    snapshot.forEach(doc => {
                        const orderData = doc.data();
                        orders.push({
                            id: doc.id,
                            ...orderData
                        });
                    });
                    
                    orders.sort((a, b) => {
                        return new Date(b.timestamp || b.createdAt) - new Date(a.timestamp || b.createdAt);
                    });
                    
                    updateDashboardStats();
                    updateRecentOrders();
                    updateAllOrders();
                    updateNotificationBadge();
                    updateFinanceData();
                    
                    if (currentScreen === 'finance') {
                        updateFinanceUI();
                    }
                }, (error) => {
                    console.error("Error in orders listener:", error);
                    loadOrdersWithoutListener();
                });
        }

        function updateFinanceData() {
            const totalRevenue = orders.reduce((sum, order) => sum + (order.total || 0), 0);
            const averageOrder = orders.length > 0 ? totalRevenue / orders.length : 0;
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const currentMonthRevenueTotal = orders.reduce((sum, order) => {
                const orderDate = new Date(order.timestamp || order.createdAt);
                if (orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear) {
                    return sum + (order.total || 0);
                }
                return sum;
            }, 0);
            
            financeTotalRevenue.textContent = `R$ ${totalRevenue.toFixed(0)}`;
            financeTotalOrders.textContent = orders.length;
            averageOrderValue.textContent = `R$ ${averageOrder.toFixed(2)}`;
            currentMonthRevenue.textContent = `R$ ${currentMonthRevenueTotal.toFixed(0)}`;
        }

        function updateFinanceUI() {
            if (financeTab === 'all') {
                showAllPayments();
            } else if (financeTab === 'monthly') {
                showMonthlySummary();
            } else if (financeTab === 'summary') {
                showFinanceSummary();
            }
        }

        function showAllPayments() {
            allPaymentsList.innerHTML = '';
            
            if (orders.length === 0) {
                allPaymentsEmpty.style.display = 'block';
                return;
            }
            
            allPaymentsEmpty.style.display = 'none';
            
            orders.forEach(order => {
                const status = order.deliveryStatus || 'preparing';
                const total = order.total || 0;
                
                const paymentCard = document.createElement('div');
                paymentCard.className = 'order-card';
                paymentCard.innerHTML = `
                    <div class="order-header">
                        <div class="order-id">#${order.id.substring(0, 8)}</div>
                        <div class="order-date">${formatDate(order.timestamp || order.createdAt)}</div>
                    </div>
                    <div class="order-customer">${order.customerName}</div>
                    <div class="order-info">
                        <div>
                            <span class="order-status ${getDeliveryStatusClass(status)}">${getDeliveryStatusText(status)}</span>
                        </div>
                        <div class="order-total">R$ ${total.toFixed(2).replace('.', ',')}</div>
                    </div>
                    <div class="mb-1">
                        <small><strong>Pagamento:</strong> ${order.paymentMethod === 'money' ? 'Dinheiro' : 'PIX'}</small>
                    </div>
                    <div class="mb-1">
                        <small><strong>Taxa de entrega:</strong> R$ ${(order.deliveryFee || 0).toFixed(2).replace('.', ',')}</small>
                    </div>
                    ${order.receiptBase64 ? `
                    <div class="mb-1">
                        <small><strong>Comprovante:</strong> Enviado</small>
                    </div>
                    ` : ''}
                `;
                allPaymentsList.appendChild(paymentCard);
            });
        }

        function showMonthlySummary() {
            monthlySummaryList.innerHTML = '';
            
            const monthlyOrders = {};
            orders.forEach(order => {
                const date = new Date(order.timestamp || order.createdAt);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthName = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                
                if (!monthlyOrders[monthKey]) {
                    monthlyOrders[monthKey] = { name: monthName, revenue: 0, orders: 0, deliveryFees: 0 };
                }
                monthlyOrders[monthKey].revenue += order.total || 0;
                monthlyOrders[monthKey].orders += 1;
                monthlyOrders[monthKey].deliveryFees += order.deliveryFee || 0;
            });
            
            const sortedMonths = Object.keys(monthlyOrders).sort().reverse();
            
            if (sortedMonths.length === 0) {
                monthlySummaryList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                        <h3>Nenhum pedido</h3>
                        <p>Os resumos mensais aparecerão aqui.</p>
                    </div>
                `;
                return;
            }
            
            sortedMonths.forEach(monthKey => {
                const month = monthlyOrders[monthKey];
                const averageOrder = month.orders > 0 ? month.revenue / month.orders : 0;
                
                const monthCard = document.createElement('div');
                monthCard.className = 'monthly-summary';
                monthCard.innerHTML = `
                    <div class="month-header">
                        <div class="month-name">${month.name}</div>
                        <div class="month-revenue">R$ ${month.revenue.toFixed(2).replace('.', ',')}</div>
                    </div>
                    <div class="daily-orders">
                        <div class="daily-order">
                            <span>Total Pedidos:</span>
                            <span class="order-count">${month.orders}</span>
                        </div>
                        <div class="daily-order">
                            <span>Média por Pedido:</span>
                            <span class="order-amount">R$ ${averageOrder.toFixed(2).replace('.', ',')}</span>
                        </div>
                        <div class="daily-order">
                            <span>Taxas de Entrega:</span>
                            <span class="order-amount">R$ ${month.deliveryFees.toFixed(2).replace('.', ',')}</span>
                        </div>
                    </div>
                `;
                monthlySummaryList.appendChild(monthCard);
            });
        }

        function showFinanceSummary() {
            updateFinanceCharts();
        }

        function updateNotificationBadge() {
            const newPreparingOrders = orders.filter(order => order.deliveryStatus === 'preparing').length;
            
            if (newPreparingOrders > 0 && newPreparingOrders !== preparingOrdersCount) {
                ordersBadge.textContent = newPreparingOrders;
                ordersBadge.classList.remove('d-none');
            } else if (newPreparingOrders === 0) {
                ordersBadge.classList.add('d-none');
            }
            
            preparingOrdersCount = newPreparingOrders;
        }

        async function loadOrdersWithoutListener() {
            try {
                const snapshot = await db.collection('orders').get();
                orders = [];
                snapshot.forEach(doc => {
                    const orderData = doc.data();
                    if (orderData.storeId === currentStoreId) {
                        orders.push({
                            id: doc.id,
                            ...orderData
                        });
                    }
                });
                
                orders.sort((a, b) => {
                    return new Date(b.timestamp || b.createdAt) - new Date(a.timestamp || a.createdAt);
                });
                
                updateDashboardStats();
                updateRecentOrders();
                updateAllOrders();
                updateNotificationBadge();
                updateFinanceData();
                
                if (currentScreen === 'finance') {
                    updateFinanceUI();
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                showNotification('Erro ao carregar pedidos.', 'error');
            }
        }

        async function loadProducts() {
            try {
                const snapshot = await db.collection('stores').doc(currentStoreId).collection('products').get();
                products = [];
                snapshot.forEach(doc => {
                    products.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                updateProductsList();
            } catch (error) {
                console.error('Error loading products:', error);
                showNotification('Erro ao carregar produtos.', 'error');
            }
        }

        function setupEventListeners() {
            // Perfil e mudança de senha
            profileCard.addEventListener('click', (e) => {
                if (!e.target.closest('.user-option-btn') && !e.target.closest('.change-password-menu')) {
                    closeChangePasswordMenu();
                }
            });

            profileOptionsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleChangePasswordMenu();
            });

            changePasswordMenuItem.addEventListener('click', (e) => {
                e.stopPropagation();
                openChangePasswordModal();
                closeChangePasswordMenu();
            });

            changePasswordForm.addEventListener('submit', changeUserPassword);
            
            newPassword.addEventListener('input', validateNewPassword);
            confirmPassword.addEventListener('input', validatePasswordMatch);
            
            cancelChangePasswordBtn.addEventListener('click', () => {
                changePasswordModal.style.display = 'none';
                resetChangePasswordForm();
            });
            
            closeChangePasswordModal.addEventListener('click', () => {
                changePasswordModal.style.display = 'none';
                resetChangePasswordForm();
            });

            // Botão para enviar link de recuperação
            sendResetLinkBtn.addEventListener('click', sendPasswordResetEmail);

            // WhatsApp alert modal
            sendWhatsappAlertBtn.addEventListener('click', () => {
                sendWhatsAppToSupport();
            });

            // Waiting approval modal
            backToHomeBtn.addEventListener('click', () => {
                waitingApprovalModal.style.display = 'none';
                showScreen('dashboard');
                navBtns.forEach(b => b.classList.remove('active'));
                document.querySelector('[data-screen="dashboard"]').classList.add('active');
            });

            // WhatsApp notification modal
            cancelWhatsappBtn.addEventListener('click', () => {
                whatsappNotificationModal.style.display = 'none';
                whatsappNotificationType = null;
                whatsappNotificationData = null;
            });

            openWhatsappBtn.addEventListener('click', () => {
                openWhatsAppNotification();
            });

            confirmWhatsappBtn.addEventListener('click', () => {
                confirmWhatsAppNotification();
            });

            // Days left modal
            closeDaysLeftBtn.addEventListener('click', () => {
                daysLeftModal.style.display = 'none';
            });

            // Categorias compactadas
            addCategoryCompactBtn.addEventListener('click', addCategoryCompact);

            // Botão flutuante
            floatingAddProductBtn.addEventListener('click', () => {
                openProductForm();
            });

            // Logout
            logoutBtn.addEventListener('click', async () => {
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                    await auth.signOut();
                    currentUser = null;
                    currentStoreId = null;
                    orders = [];
                    products = [];
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = 'login.html';
                }
            });

            logoutBlockedBtn.addEventListener('click', async () => {
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                    await auth.signOut();
                    currentUser = null;
                    currentStoreId = null;
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = 'login.html';
                }
            });

            logoutFromBlockBtn.addEventListener('click', async () => {
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                    await auth.signOut();
                    currentUser = null;
                    currentStoreId = null;
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = 'login.html';
                }
            });

            // Navegação
            navBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (isSystemBlocked) return;
                    
                    const screen = btn.getAttribute('data-screen');
                    showScreen(screen);
                    navBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    if (screen === 'orders') {
                        ordersBadge.classList.add('d-none');
                    }
                    
                    if (screen === 'products') {
                        floatingAddProductBtn.classList.remove('d-none');
                    } else {
                        floatingAddProductBtn.classList.add('d-none');
                    }
                    
                    if (screen === 'finance') {
                        updateFinanceUI();
                        updateFinanceCharts();
                    }
                    
                    if (screen === 'config') {
                        loadCategories();
                    }
                });
            });

            // Link para clientes (botões minimalistas)
            copyLinkBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(customerLink).then(() => {
                    showNotification('Link copiado!', 'success');
                }).catch(() => {
                    const textArea = document.createElement('textarea');
                    textArea.value = customerLink;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification('Link copiado!', 'success');
                });
            });

            openLinkBtn.addEventListener('click', () => {
                if (customerLink) {
                    window.open(customerLink, '_blank');
                    showNotification('Link aberto!', 'info');
                }
            });

            shareLinkBtn.addEventListener('click', () => {
                if (navigator.share) {
                    navigator.share({
                        title: storeConfig.businessName || 'Minha Loja',
                        text: 'Acesse minha loja virtual:',
                        url: customerLink
                    });
                } else {
                    copyLinkBtn.click();
                }
            });

            // Renovação de plano
            renewPlanBtn.addEventListener('click', () => {
                expiryWarningModal.style.display = 'none';
                showRenewPaymentModal();
            });

            closeExpiryWarningBtn.addEventListener('click', () => {
                expiryWarningModal.style.display = 'none';
            });

            renewPlanBannerBtn.addEventListener('click', () => {
                showRenewPaymentModal();
            });

            renewExpiredBtn.addEventListener('click', () => {
                showRenewPaymentModal();
            });

            renewFromBlockBtn.addEventListener('click', () => {
                blockSystemModal.style.display = 'none';
                showRenewPaymentModal();
            });

            // Abas do financeiro
            financeTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    financeTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    financeTab = tab.getAttribute('data-tab');
                    
                    document.querySelectorAll('.finance-tab-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    
                    if (financeTab === 'all') {
                        document.getElementById('financeAllTab').style.display = 'block';
                        showAllPayments();
                    } else if (financeTab === 'monthly') {
                        document.getElementById('financeMonthlyTab').style.display = 'block';
                        showMonthlySummary();
                    } else if (financeTab === 'summary') {
                        document.getElementById('financeSummaryTab').style.display = 'block';
                        showFinanceSummary();
                    }
                });
            });

            // Filtro de status
            statusFilterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    statusFilterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    statusFilter = btn.getAttribute('data-status');
                    updateAllOrders();
                });
            });

            // Configurações
            configForm.addEventListener('submit', saveStoreConfig);
            
            logoUploadArea.addEventListener('click', () => {
                configLogoUpload.click();
            });
            
            configLogoUpload.addEventListener('change', async (e) => {
                await handleLogoUpload(e);
            });
            
            configLogoPreview.addEventListener('click', () => {
                if (configLogoPreview.src) {
                    openImageZoom(configLogoPreview.src, 'Logo da Loja');
                }
            });
            
            removeLogoBtn.addEventListener('click', () => {
                removeLogo();
            });
            
            themeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    themeOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    configTheme.value = option.getAttribute('data-theme');
                });
            });

            // Upload de múltiplas imagens do produto
            productImageUploadArea.addEventListener('click', () => {
                productImageUpload.click();
            });
            
            productImageUpload.addEventListener('change', async (e) => {
                await handleMultipleImagesUpload(e);
            });

            // Produtos
            productForm.addEventListener('submit', saveProduct);
            cancelProductBtn.addEventListener('click', () => {
                closeProductForm();
            });

            // Renovação de pagamento
            submitRenewBtn.addEventListener('click', submitRenewalPayment);
            cancelRenewBtn.addEventListener('click', () => {
                renewPaymentModal.style.display = 'none';
                resetRenewReceipt();
            });
            
            closeRenewModal.addEventListener('click', () => {
                renewPaymentModal.style.display = 'none';
                resetRenewReceipt();
            });
            
            renewReceiptUploadArea.addEventListener('click', () => {
                renewReceiptUpload.click();
            });
            
            renewReceiptUpload.addEventListener('change', async (e) => {
                await handleRenewReceiptUpload(e);
            });

            // Evento para visualizar PDF
            renewReceiptPdfPreview.addEventListener('click', () => {
                if (renewReceiptBase64) {
                    window.open(renewReceiptBase64, '_blank');
                }
            });

            // Modais
            closeOrderModal.addEventListener('click', () => {
                orderDetailsModal.style.display = 'none';
            });
            
            closeProductModal.addEventListener('click', () => {
                closeProductForm();
            });
            
            closeZoom.addEventListener('click', () => {
                imageZoomModal.style.display = 'none';
                resetZoom();
            });

            // Fechar modais ao clicar fora
            window.addEventListener('click', (e) => {
                if (e.target === orderDetailsModal) {
                    orderDetailsModal.style.display = 'none';
                }
                if (e.target === productFormModal) {
                    closeProductForm();
                }
                if (e.target === imageZoomModal) {
                    imageZoomModal.style.display = 'none';
                    resetZoom();
                }
                if (e.target === expiryWarningModal) {
                    expiryWarningModal.style.display = 'none';
                }
                if (e.target === renewPaymentModal) {
                    renewPaymentModal.style.display = 'none';
                    resetRenewReceipt();
                }
                if (e.target === whatsappAlertModal) {
                    e.stopPropagation();
                }
                if (e.target === waitingApprovalModal) {
                    waitingApprovalModal.style.display = 'none';
                }
                if (e.target === whatsappNotificationModal) {
                    whatsappNotificationModal.style.display = 'none';
                    whatsappNotificationType = null;
                    whatsappNotificationData = null;
                }
                if (e.target === blockModal) {
                    e.stopPropagation();
                }
                if (e.target === blockSystemModal) {
                    e.stopPropagation();
                }
                if (e.target === daysLeftModal) {
                    daysLeftModal.style.display = 'none';
                }
                if (e.target === changePasswordModal) {
                    changePasswordModal.style.display = 'none';
                    resetChangePasswordForm();
                }
                // Fechar menu de mudar senha ao clicar fora
                if (!e.target.closest('.user-card') && !e.target.closest('.change-password-menu')) {
                    closeChangePasswordMenu();
                }
            });
        }

        async function handleLogoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 8 * 1024 * 1024) {
                showNotification('A imagem deve ter no máximo 8MB.', 'error');
                e.target.value = '';
                return;
            }
            
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
            if (!validTypes.includes(file.type)) {
                showNotification('Tipo de arquivo inválido. Use JPG ou PNG.', 'error');
                e.target.value = '';
                return;
            }
            
            const uploadArea = logoUploadArea;
            const originalHtml = uploadArea.innerHTML;
            
            uploadArea.classList.add('uploading');
            uploadArea.innerHTML = `
                <div class="upload-icon"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="upload-text">Carregando imagem...</div>
            `;
            
            try {
                const reader = new FileReader();
                reader.onload = async function(event) {
                    try {
                        const originalBase64 = event.target.result;
                        const croppedBase64 = await autoCropImageToSquare(originalBase64);
                        
                        logoBase64 = croppedBase64;
                        configLogoPreview.src = croppedBase64;
                        configLogoPreview.style.display = 'block';
                        logoUploadArea.classList.add('hidden');
                        removeLogoBtn.classList.remove('d-none');
                        
                        updateUserAvatar();
                        updateStoreAvatar();
                        
                        showNotification('Logo ajustada e salva automaticamente!', 'success');
                    } catch (error) {
                        console.error('Error processing logo:', error);
                        showNotification('Erro ao processar logo.', 'error');
                    }
                    
                    uploadArea.classList.remove('uploading');
                    uploadArea.innerHTML = originalHtml;
                    e.target.value = '';
                };
                
                reader.onerror = function() {
                    showNotification('Erro ao carregar imagem.', 'error');
                    uploadArea.classList.remove('uploading');
                    uploadArea.innerHTML = originalHtml;
                    e.target.value = '';
                };
                
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Error in handleLogoUpload:', error);
                showNotification('Erro ao processar imagem.', 'error');
                uploadArea.classList.remove('uploading');
                uploadArea.innerHTML = originalHtml;
                e.target.value = '';
            }
        }

        async function autoCropImageToSquare(imageSrc) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        const size = Math.min(img.width, img.height);
                        canvas.width = 500;
                        canvas.height = 500;
                        
                        const sourceX = (img.width - size) / 2;
                        const sourceY = (img.height - size) / 2;
                        
                        ctx.drawImage(
                            img, 
                            sourceX, sourceY, size, size,
                            0, 0, 500, 500
                        );
                        
                        const croppedBase64 = canvas.toDataURL('image/jpeg', 0.9);
                        resolve(croppedBase64);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                img.onerror = function(error) {
                    reject(error);
                };
                
                img.src = imageSrc;
            });
        }

        function removeLogo() {
            logoBase64 = '';
            configLogoPreview.style.display = 'none';
            logoUploadArea.classList.remove('hidden');
            removeLogoBtn.classList.add('d-none');
            configLogoUpload.value = '';
            
            updateUserAvatar();
            updateStoreAvatar();
            
            showNotification('Logo removida.', 'info');
        }

        async function handleMultipleImagesUpload(e) {
            const files = Array.from(e.target.files);
            
            // Limitar a 3 imagens
            if (files.length > 3) {
                showNotification('Máximo de 3 imagens permitidas.', 'error');
                productImageUpload.value = '';
                return;
            }
            
            // Verificar se já temos 3 imagens
            const currentImagesCount = productImagesBase64.length;
            const availableSlots = 3 - currentImagesCount;
            
            if (files.length > availableSlots) {
                showNotification(`Você já tem ${currentImagesCount} imagens. Pode adicionar apenas mais ${availableSlots}.`, 'error');
                productImageUpload.value = '';
                return;
            }
            
            const uploadArea = productImageUploadArea;
            const originalHtml = uploadArea.innerHTML;
            
            uploadArea.classList.add('uploading');
            uploadArea.innerHTML = `
                <div class="upload-icon"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="upload-text">Processando ${files.length} imagem(ns)...</div>
            `;
            
            try {
                for (const file of files) {
                    if (file.size > 8 * 1024 * 1024) {
                        showNotification(`A imagem ${file.name} excede 8MB.`, 'error');
                        continue;
                    }
                    
                    const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
                    if (!validTypes.includes(file.type)) {
                        showNotification(`Tipo inválido para ${file.name}. Use JPG ou PNG.`, 'error');
                        continue;
                    }
                    
                    // Processar automaticamente no formato quadrado 1:1
                    const base64 = await readFileAsBase64(file);
                    const croppedBase64 = await autoCropImageToSquare(base64);
                    productImagesBase64.push(croppedBase64);
                }
                
                // Atualizar interface após todas as imagens serem processadas
                updateProductImagesPreview();
                updateImageCounter();
                
                // Se atingiu 3 imagens, ocultar área de upload
                if (productImagesBase64.length >= 3) {
                    productImageUploadArea.classList.add('hidden');
                }
                
                showNotification(`${files.length} imagem(ns) adicionada(s) automaticamente no formato 1:1!`, 'success');
                
            } catch (error) {
                console.error('Error uploading multiple images:', error);
                showNotification('Erro ao processar imagens.', 'error');
            } finally {
                uploadArea.classList.remove('uploading');
                uploadArea.innerHTML = originalHtml;
                productImageUpload.value = '';
            }
        }

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsDataURL(file);
            });
        }

        function updateProductImagesPreview() {
            productImagesPreview.innerHTML = '';
            
            productImagesBase64.forEach((base64, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-preview-item';
                imageItem.innerHTML = `
                    <img src="${base64}" alt="Imagem ${index + 1}" style="cursor:pointer;">
                    <button class="remove-image-btn" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                productImagesPreview.appendChild(imageItem);
                
                imageItem.querySelector('.remove-image-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const indexToRemove = parseInt(e.currentTarget.getAttribute('data-index'));
                    removeProductImage(indexToRemove);
                });
                
                imageItem.querySelector('img').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openImageZoom(base64, `Imagem ${index + 1} do produto`);
                });
            });
        }

        function updateImageCounter() {
            const count = productImagesBase64.length;
            imageCounter.textContent = `${count}/3 imagens selecionadas`;
            
            if (count >= 3) {
                imageCounter.style.color = '#4caf50';
                imageCounter.innerHTML += ' <i class="fas fa-check"></i>';
            } else {
                imageCounter.style.color = '#757575';
            }
        }

        function removeProductImage(index) {
            productImagesBase64.splice(index, 1);
            updateProductImagesPreview();
            updateImageCounter();
            
            // Mostrar área de upload novamente se tiver menos de 3 imagens
            if (productImagesBase64.length < 3) {
                productImageUploadArea.classList.remove('hidden');
            }
            
            showNotification('Imagem removida.', 'info');
        }

        function toggleChangePasswordMenu() {
            const isActive = changePasswordMenu.classList.contains('active');
            closeChangePasswordMenu();
            
            if (!isActive) {
                changePasswordMenu.classList.add('active');
            }
        }

        function closeChangePasswordMenu() {
            changePasswordMenu.classList.remove('active');
        }

        function openChangePasswordModal() {
            changePasswordModal.style.display = 'flex';
            resetChangePasswordForm();
        }

        function resetChangePasswordForm() {
            changePasswordForm.reset();
            currentPasswordError.style.display = 'none';
            passwordMatchError.style.display = 'none';
            newPasswordStrength.textContent = 'A senha deve ter pelo menos 6 caracteres';
            newPasswordStrength.style.color = '#757575';
            
            if (!userHasPassword) {
                currentPassword.placeholder = "Você não tem senha cadastrada";
                currentPassword.disabled = true;
                currentPassword.style.opacity = "0.7";
            } else {
                currentPassword.placeholder = "Digite sua senha atual";
                currentPassword.disabled = false;
                currentPassword.style.opacity = "1";
            }
        }

        function validateNewPassword() {
            const password = newPassword.value;
            
            if (password.length < 6) {
                newPasswordStrength.textContent = 'A senha deve ter pelo menos 6 caracteres';
                newPasswordStrength.style.color = '#f44336';
                return false;
            } else {
                newPasswordStrength.textContent = 'Senha forte ✓';
                newPasswordStrength.style.color = '#4caf50';
                return true;
            }
        }

        function validatePasswordMatch() {
            const newPass = newPassword.value;
            const confirmPass = confirmPassword.value;
            
            if (newPass && confirmPass && newPass !== confirmPass) {
                passwordMatchError.style.display = 'block';
                return false;
            } else {
                passwordMatchError.style.display = 'none';
                return true;
            }
        }

        async function changeUserPassword(e) {
            e.preventDefault();
            
            if (!userHasPassword) {
                await createNewPassword();
                return;
            }
            
            const currentPass = currentPassword.value;
            const newPass = newPassword.value;
            
            if (!userHasPassword && currentPass) {
                showNotification('Você não tem senha cadastrada. Deixe o campo "Senha Atual" em branco.', 'error');
                return;
            }
            
            if (!validateNewPassword() || !validatePasswordMatch()) {
                showNotification('Por favor, corrija os erros no formulário.', 'error');
                return;
            }
            
            if (userHasPassword && !currentPass) {
                showNotification('Por favor, informe sua senha atual.', 'error');
                return;
            }
            
            if (!newPass) {
                showNotification('Por favor, preencha a nova senha.', 'error');
                return;
            }
            
            try {
                const originalBtnText = submitChangePasswordBtn.innerHTML;
                submitChangePasswordBtn.innerHTML = '<div class="loading-spinner" style="width:20px;height:20px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite"></div>';
                submitChangePasswordBtn.disabled = true;
                
                if (userHasPassword) {
                    const user = auth.currentUser;
                    const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPass);
                    await user.reauthenticateWithCredential(credential);
                }
                
                const user = auth.currentUser;
                await user.updatePassword(newPass);
                
                await db.collection('userActivities').add({
                    userId: currentStoreId,
                    action: userHasPassword ? 'password_changed' : 'password_created',
                    timestamp: new Date().toISOString(),
                    userEmail: currentUser.email,
                    storeName: currentUser.storeName || 'Minha Loja',
                    ipAddress: await getIPAddress()
                });
                
                userHasPassword = true;
                
                showNotification(userHasPassword ? 'Senha alterada com sucesso!' : 'Senha criada com sucesso!', 'success');
                
                changePasswordModal.style.display = 'none';
                resetChangePasswordForm();
                
            } catch (error) {
                console.error('Error changing password:', error);
                
                if (error.code === 'auth/wrong-password') {
                    currentPasswordError.style.display = 'block';
                    showNotification('Senha atual incorreta.', 'error');
                } else if (error.code === 'auth/weak-password') {
                    showNotification('A nova senha é muito fraca. Use pelo menos 6 caracteres.', 'error');
                } else if (error.code === 'auth/requires-recent-login') {
                    showNotification('Sua sessão expirou. Por favor, faça login novamente.', 'error');
                    setTimeout(() => {
                        logoutBtn.click();
                    }, 2000);
                } else {
                    showNotification('Erro ao alterar senha: ' + error.message, 'error');
                }
            } finally {
                submitChangePasswordBtn.innerHTML = '<i class="fas fa-save"></i> Alterar Senha';
                submitChangePasswordBtn.disabled = false;
            }
        }

        async function createNewPassword() {
            const newPass = newPassword.value;
            const confirmPass = confirmPassword.value;
            
            if (!validateNewPassword() || !validatePasswordMatch()) {
                showNotification('Por favor, corrija os erros no formulário.', 'error');
                return;
            }
            
            if (newPass !== confirmPass) {
                showNotification('As senhas não coincidem.', 'error');
                return;
            }
            
            try {
                const originalBtnText = submitChangePasswordBtn.innerHTML;
                submitChangePasswordBtn.innerHTML = '<div class="loading-spinner" style="width:20px;height:20px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite"></div>';
                submitChangePasswordBtn.disabled = true;
                
                const user = auth.currentUser;
                await user.updatePassword(newPass);
                
                await db.collection('userActivities').add({
                    userId: currentStoreId,
                    action: 'password_created',
                    timestamp: new Date().toISOString(),
                    userEmail: currentUser.email,
                    storeName: currentUser.storeName || 'Minha Loja',
                    ipAddress: await getIPAddress()
                });
                
                userHasPassword = true;
                
                showNotification('Senha criada com sucesso! Agora você pode fazer login com e-mail e senha.', 'success');
                
                changePasswordModal.style.display = 'none';
                resetChangePasswordForm();
                
            } catch (error) {
                console.error('Error creating password:', error);
                
                if (error.code === 'auth/weak-password') {
                    showNotification('A senha é muito fraca. Use pelo menos 6 caracteres.', 'error');
                } else if (error.code === 'auth/requires-recent-login') {
                    showNotification('Sua sessão expirou. Por favor, faça login novamente.', 'error');
                    setTimeout(() => {
                        logoutBtn.click();
                    }, 2000);
                } else {
                    showNotification('Erro ao criar senha: ' + error.message, 'error');
                }
            } finally {
                submitChangePasswordBtn.innerHTML = '<i class="fas fa-save"></i> Alterar Senha';
                submitChangePasswordBtn.disabled = false;
            }
        }

        async function sendPasswordResetEmail() {
            try {
                const user = auth.currentUser;
                if (!user || !user.email) {
                    showNotification('E-mail não encontrado.', 'error');
                    return;
                }
                
                const originalBtnText = sendResetLinkBtn.innerHTML;
                sendResetLinkBtn.innerHTML = '<div class="loading-spinner" style="width:20px;height:20px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite"></div>';
                sendResetLinkBtn.disabled = true;
                
                await auth.sendPasswordResetEmail(user.email);
                
                showNotification('Link de recuperação enviado para seu e-mail!', 'success');
                
                await db.collection('userActivities').add({
                    userId: currentStoreId,
                    action: 'password_reset_requested',
                    timestamp: new Date().toISOString(),
                    userEmail: currentUser.email,
                    storeName: currentUser.storeName || 'Minha Loja',
                    ipAddress: await getIPAddress()
                });
                
                setTimeout(() => {
                    changePasswordModal.style.display = 'none';
                    resetChangePasswordForm();
                }, 2000);
                
            } catch (error) {
                console.error('Error sending reset email:', error);
                
                if (error.code === 'auth/user-not-found') {
                    showNotification('Usuário não encontrado.', 'error');
                } else if (error.code === 'auth/too-many-requests') {
                    showNotification('Muitas tentativas. Tente novamente mais tarde.', 'error');
                } else {
                    showNotification('Erro ao enviar link de recuperação: ' + error.message, 'error');
                }
            } finally {
                sendResetLinkBtn.innerHTML = '<i class="fas fa-envelope"></i> Enviar Link de Recuperação por E-mail';
                sendResetLinkBtn.disabled = false;
            }
        }

        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip || 'unknown';
            } catch (error) {
                console.error('Error getting IP address:', error);
                return 'unknown';
            }
        }

        async function showRenewPaymentModal() {
            try {
                const configDoc = await db.collection('systemConfig').doc('paymentSettings').get();
                if (configDoc.exists) {
                    const configData = configDoc.data();
                    renewPixKeyDisplay.textContent = configData.pixKey || 'chave-pix@empresa.com';
                    renewPlanPrice.textContent = `R$ ${(configData.monthlyPlanPrice || 99.00).toFixed(2).replace('.', ',')}`;
                    supportPhone = configData.adminWhatsApp || "+5511999999999";
                }
                
                renewPaymentModal.style.display = 'flex';
                resetRenewReceipt();
            } catch (error) {
                console.error('Error loading renewal data:', error);
                showNotification('Erro ao carregar informações de pagamento.', 'error');
            }
        }

        function resetRenewReceipt() {
            renewReceiptBase64 = '';
            renewReceiptType = '';
            renewReceiptFileName = '';
            renewReceiptImagePreview.style.display = 'none';
            renewReceiptPdfPreview.style.display = 'none';
            renewReceiptUpload.value = '';
            renewPaymentNotes.value = '';
            
            const originalHtml = `
                <div class="upload-icon"><i class="fas fa-file-upload"></i></div>
                <div class="upload-text">Clique para fazer upload</div>
                <div class="upload-info">Aceitamos imagens (JPG, PNG) ou PDF - Tamanho máximo: 8MB</div>
                <div class="file-types">
                    <span class="file-type-badge">JPG</span>
                    <span class="file-type-badge">PNG</span>
                    <span class="file-type-badge">PDF</span>
                </div>
            `;
            renewReceiptUploadArea.innerHTML = originalHtml;
            renewReceiptUploadArea.classList.remove('uploading');
        }

        async function handleRenewReceiptUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 8 * 1024 * 1024) {
                showNotification('O arquivo deve ter no máximo 8MB.', 'error');
                renewReceiptUpload.value = '';
                return;
            }
            
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                showNotification('Tipo de arquivo inválido. Use JPG, PNG ou PDF.', 'error');
                renewReceiptUpload.value = '';
                return;
            }
            
            const originalHtml = renewReceiptUploadArea.innerHTML;
            
            renewReceiptUploadArea.classList.add('uploading');
            renewReceiptUploadArea.innerHTML = `
                <div class="upload-icon"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="upload-text">Processando arquivo...</div>
            `;
            
            try {
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    let base64 = event.target.result;
                    renewReceiptType = file.type.includes('pdf') ? 'pdf' : 'image';
                    renewReceiptFileName = file.name;
                    renewReceiptBase64 = base64;
                    
                    renewReceiptUploadArea.innerHTML = originalHtml;
                    renewReceiptUploadArea.classList.remove('uploading');
                    
                    if (renewReceiptType === 'pdf') {
                        renewReceiptPdfPreview.style.display = 'flex';
                        renewPdfFileName.textContent = file.name;
                        renewReceiptImagePreview.style.display = 'none';
                        showNotification('PDF carregado com sucesso!', 'success');
                    } else {
                        const img = new Image();
                        img.onload = async function() {
                            try {
                                const canvas = document.createElement('canvas');
                                let width = img.width;
                                let height = img.height;
                                
                                const maxDimension = 1200;
                                if (width > maxDimension || height > maxDimension) {
                                    if (width > height) {
                                        height = (maxDimension / width) * height;
                                        width = maxDimension;
                                    } else {
                                        width = (maxDimension / height) * width;
                                        height = maxDimension;
                                    }
                                }
                                
                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);
                                
                                renewReceiptBase64 = canvas.toDataURL('image/jpeg', 0.8);
                                renewReceiptImagePreview.src = renewReceiptBase64;
                                renewReceiptImagePreview.style.display = 'block';
                                renewReceiptPdfPreview.style.display = 'none';
                                
                                showNotification('Comprovante carregado com sucesso!', 'success');
                            } catch (error) {
                                console.error('Error optimizing image:', error);
                                renewReceiptImagePreview.src = renewReceiptBase64;
                                renewReceiptImagePreview.style.display = 'block';
                                renewReceiptPdfPreview.style.display = 'none';
                                showNotification('Comprovante carregado.', 'info');
                            }
                        };
                        
                        img.onerror = function() {
                            renewReceiptImagePreview.src = renewReceiptBase64;
                            renewReceiptImagePreview.style.display = 'block';
                            renewReceiptPdfPreview.style.display = 'none';
                            showNotification('Comprovante carregado.', 'info');
                        };
                        
                        img.src = base64;
                    }
                };
                
                reader.onerror = function(error) {
                    console.error('Error reading file:', error);
                    renewReceiptUploadArea.innerHTML = originalHtml;
                    renewReceiptUploadArea.classList.remove('uploading');
                    showNotification('Erro ao carregar arquivo.', 'error');
                };
                
                reader.readAsDataURL(file);
                
            } catch (error) {
                console.error('Error in handleRenewReceiptUpload:', error);
                renewReceiptUploadArea.innerHTML = originalHtml;
                renewReceiptUploadArea.classList.remove('uploading');
                showNotification('Erro ao processar arquivo.', 'error');
            }
        }

        function showWhatsAppAlertModal(paymentData) {
            currentPaymentRecord = paymentData;
            alertStoreName.textContent = paymentData.storeName || currentUser.storeName || 'Minha Loja';
            alertUserEmail.textContent = currentUser.email;
            alertUserPhone.textContent = storeConfig.whatsappNumber || currentUser.phone || 'Não informado';
            alertPaymentAmount.textContent = `R$ ${paymentData.amount.toFixed(2).replace('.', ',')}`;
            alertRegistrationDate.textContent = formatDate(paymentData.createdAt || new Date().toISOString());
            whatsappAlertModal.style.display = 'flex';
        }

        async function sendWhatsAppToSupport() {
            if (!currentPaymentRecord) return;
            
            try {
                paymentRecordId = currentPaymentRecord.id || `PAG-${Date.now()}`;
                
                const message = `🔄 *SOLICITAÇÃO DE RENOVAÇÃO* 🔄\n\n📋 *ID do Pagamento:* ${paymentRecordId}\n🏪 *Nome da Loja:* ${currentPaymentRecord.storeName || currentUser.storeName}\n📧 *E-mail Cadastrado:* ${currentUser.email}\n📱 *WhatsApp:* ${storeConfig.whatsappNumber || currentUser.phone || 'Não informado'}\n💰 *Valor do Pagamento:* R$ ${currentPaymentRecord.amount.toFixed(2)}\n📅 *Data do Cadastro:* ${formatDate(currentPaymentRecord.createdAt || new Date().toISOString())}\n⏰ *Hora:* ${formatTime(currentPaymentRecord.createdAt || new Date().toISOString())}\n📝 *Observações:* ${currentPaymentRecord.notes || 'Nenhuma'}\n\n📊 *Status:* Comprovante enviado - Aguardando liberação\n\n⚠️ *POR FAVOR, LIBERAR O ACESSO DESTA CONTA* ⚠️\n\n_Este é um pedido automático gerado pelo sistema Venda+._`;
                
                if (!supportPhone) {
                    showNotification('Número de suporte não configurado no sistema.', 'error');
                    return;
                }
                
                const whatsappUrl = `https://wa.me/${supportPhone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                await updatePaymentWhatsAppSent();
                whatsappAlertModal.style.display = 'none';
                
                showTemporaryRenewalModal();
                
                setTimeout(() => {
                    showWaitingApprovalModal();
                }, 1000);
                
            } catch (error) {
                console.error('Error sending WhatsApp to support:', error);
                showNotification('Erro ao enviar WhatsApp para o suporte.', 'error');
            }
        }

        async function updatePaymentWhatsAppSent() {
            try {
                if (!currentPaymentRecord || !paymentRecordId) return;
                
                await db.collection('payments').doc(currentPaymentRecord.id).update({
                    whatsappSent: true,
                    whatsappSentAt: new Date().toISOString(),
                    paymentRecordId: paymentRecordId,
                    status: 'pending_approval'
                });
                
                await db.collection('users').doc(currentStoreId).update({
                    renewalStatus: 'pending_approval',
                    lastRenewalRequest: new Date().toISOString(),
                    paymentRecordId: paymentRecordId
                });
                
                showNotification('WhatsApp enviado com sucesso!', 'success');
            } catch (error) {
                console.error('Error updating payment WhatsApp status:', error);
                throw error;
            }
        }

        function showWaitingApprovalModal() {
            waitingApprovalModal.style.display = 'flex';
        }

        function showWhatsAppNotification(type, data) {
            whatsappNotificationType = type;
            whatsappNotificationData = data;
            
            let message = '';
            if (type === 'renewal') {
                message = `✅ *RENOVAÇÃO CONFIRMADA!* ✅\n\nOlá, *${data.userName || 'Cliente'}*!\n\nSua renovação do plano Venda+ foi *confirmada com sucesso*! 🎉\n\n📅 *Nova data de vencimento:* ${formatDate(data.newExpiryDate)}\n💰 *Valor pago:* R$ ${data.amount.toFixed(2)}\n\nSeu acesso ao sistema está *garantido por mais 30 dias*.\n\nAgradecemos pela confiança! ✨\n\n*Equipe Venda+*`;
            }
            
            whatsappMessageContent.textContent = message;
            whatsappNotificationModal.style.display = 'flex';
        }

        function openWhatsAppNotification() {
            if (!whatsappNotificationData || !whatsappNotificationType) return;
            
            let phoneNumber = '';
            let message = '';
            
            if (whatsappNotificationType === 'renewal') {
                phoneNumber = storeConfig.whatsappNumber || currentUser.phone;
                message = `✅ *RENOVAÇÃO CONFIRMADA!* ✅\n\nOlá, *${whatsappNotificationData.userName || 'Cliente'}*!\n\nSua renovação do plano Venda+ foi *confirmada com sucesso*! 🎉\n\n📅 *Nova data de vencimento:* ${formatDate(whatsappNotificationData.newExpiryDate)}\n💰 *Valor pago:* R$ ${whatsappNotificationData.amount.toFixed(2)}\n\nSeu acesso ao sistema está *garantido por mais 30 dias*.\n\nAgradecemos pela confiança! ✨\n\n*Equipe Venda+*`;
            }
            
            if (phoneNumber) {
                const whatsappUrl = `https://wa.me/${phoneNumber.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            } else {
                showNotification('Número do WhatsApp não configurado.', 'error');
            }
        }

        async function confirmWhatsAppNotification() {
            try {
                if (whatsappNotificationType === 'renewal') {
                    const newExpiryDate = new Date();
                    newExpiryDate.setDate(newExpiryDate.getDate() + 30);
                    
                    await db.collection('users').doc(currentStoreId).update({
                        renewalStatus: 'completed',
                        expiryDate: newExpiryDate.toISOString(),
                        lastRenewalDate: new Date().toISOString()
                    });
                    
                    currentUser.expiryDate = newExpiryDate.toISOString();
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    showNotification('Renovação confirmada com sucesso!', 'success');
                    expiryWarningBanner.classList.add('d-none');
                    expiredBanner.classList.add('d-none');
                    expiryWarningModalShown = false;
                    
                    if (isSystemBlocked) {
                        unblockSystem();
                    }
                    
                    await checkRenewalStatus();
                    await checkExpiryStatus();
                }
                
                whatsappNotificationModal.style.display = 'none';
                whatsappNotificationType = null;
                whatsappNotificationData = null;
            } catch (error) {
                console.error('Error confirming WhatsApp notification:', error);
                showNotification('Erro ao confirmar notificação.', 'error');
            }
        }

        async function submitRenewalPayment() {
            if (!renewReceiptBase64) {
                showNotification('Por favor, envie o comprovante do pagamento.', 'error');
                return;
            }
            
            try {
                const originalBtnText = submitRenewBtn.innerHTML;
                submitRenewBtn.innerHTML = '<div class="loading-spinner" style="width:20px;height:20px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite"></div>';
                submitRenewBtn.disabled = true;
                
                const configDoc = await db.collection('systemConfig').doc('paymentSettings').get();
                const configData = configDoc.exists ? configDoc.data() : {};
                const amount = configData.monthlyPlanPrice || 99.00;
                
                const newExpiryDate = new Date();
                newExpiryDate.setDate(newExpiryDate.getDate() + 30);
                
                const paymentData = {
                    userId: currentStoreId,
                    userName: currentUser.storeName,
                    storeName: currentUser.storeName,
                    userEmail: currentUser.email,
                    userPhone: storeConfig.whatsappNumber || currentUser.phone || '',
                    status: 'pending',
                    plan: 'monthly',
                    planDays: 30,
                    amount: amount,
                    receiptBase64: renewReceiptBase64,
                    receiptType: renewReceiptType,
                    receiptFileName: renewReceiptFileName,
                    createdAt: new Date().toISOString(),
                    type: 'renewal',
                    notes: renewPaymentNotes.value || '',
                    paymentFor: 'plan_renewal',
                    originalExpiryDate: expiryDate || new Date().toISOString(),
                    newExpiryDate: newExpiryDate.toISOString(),
                    whatsappSent: false,
                    whatsappSentAt: null
                };
                
                const paymentRef = await db.collection('payments').add(paymentData);
                paymentData.id = paymentRef.id;
                
                await db.collection('users').doc(currentStoreId).update({
                    renewalStatus: 'pending',
                    lastRenewalRequest: new Date().toISOString()
                });
                
                renewPaymentModal.style.display = 'none';
                resetRenewReceipt();
                
                expiryWarningModal.style.display = 'none';
                
                showWhatsAppAlertModal(paymentData);
                await checkRenewalStatus();
                
            } catch (error) {
                console.error('Error submitting renewal payment:', error);
                showNotification('Erro ao enviar comprovante: ' + error.message, 'error');
            } finally {
                submitRenewBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Concluir Renovação';
                submitRenewBtn.disabled = false;
            }
        }

        function setupPinchZoom() {
            zoomedImage.addEventListener('touchstart', handleTouchStart);
            zoomedImage.addEventListener('touchmove', handleTouchMove);
            zoomedImage.addEventListener('touchend', handleTouchEnd);
        }

        function handleTouchStart(e) {
            if (e.touches.length === 2) {
                lastTouchDistance = getTouchDistance(e.touches[0], e.touches[1]);
            }
        }

        function handleTouchMove(e) {
            if (e.touches.length === 2) {
                e.preventDefault();
                const currentDistance = getTouchDistance(e.touches[0], e.touches[1]);
                
                if (lastTouchDistance) {
                    const scaleChange = currentDistance / lastTouchDistance;
                    const currentTransform = zoomedImage.style.transform || 'scale(1)';
                    const currentScale = parseFloat(currentTransform.match(/scale\(([^)]+)\)/)?.[1] || 1);
                    const newScale = Math.max(0.5, Math.min(5, currentScale * scaleChange));
                    zoomedImage.style.transform = `scale(${newScale})`;
                }
                lastTouchDistance = currentDistance;
            }
        }

        function handleTouchEnd(e) {
            lastTouchDistance = null;
        }

        function getTouchDistance(touch1, touch2) {
            const dx = touch1.clientX - touch2.clientX;
            const dy = touch1.clientY - touch2.clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function resetZoom() {
            zoomedImage.style.transform = 'scale(1)';
            lastTouchDistance = null;
        }

        function openImageZoom(imageSrc, altText) {
            zoomedImage.src = imageSrc;
            zoomedImage.alt = altText;
            resetZoom();
            imageZoomModal.style.display = 'flex';
        }

        function showScreen(screen) {
            if (isSystemBlocked && screen !== 'dashboard') return;
            
            currentScreen = screen;
            screens.forEach(s => {
                s.style.display = 'none';
            });
            document.getElementById(`${screen}Screen`).style.display = 'block';
            recordUserActivity(`view_${screen}`);
        }

        function updateDashboardStats() {
            const preparingOrders = orders.filter(order => order.deliveryStatus === 'preparing').length;
            const confirmedOrders = orders.filter(order => order.deliveryStatus === 'confirmed').length;
            const deliveringOrders = orders.filter(order => order.deliveryStatus === 'delivering').length;
            const deliveredOrders = orders.filter(order => order.deliveryStatus === 'delivered').length;
            const totalOrders = orders.length;
            const totalRevenue = orders.reduce((sum, order) => {
                return sum + (order.total || 0);
            }, 0);
            
            preparingOrdersCountElement.textContent = preparingOrders;
            confirmedOrdersCountElement.textContent = confirmedOrders;
            deliveringOrdersCountElement.textContent = deliveringOrders;
            deliveredOrdersCountElement.textContent = deliveredOrders;
            totalOrdersCountElement.textContent = totalOrders;
            totalRevenueElement.textContent = `R$ ${totalRevenue.toFixed(0)}`;
            deliveryFeeStat.textContent = `R$ ${(storeConfig.deliveryFee || 0).toFixed(2)}`;
            totalVisitsElement.textContent = storeVisits;
            totalVisitsConfig.textContent = storeVisits;
        }

        function updateRecentOrders() {
            recentOrdersList.innerHTML = '';
            const recentOrders = orders.slice(0, 5);
            
            if (recentOrders.length === 0) {
                recentOrdersEmpty.style.display = 'block';
                return;
            }
            
            recentOrdersEmpty.style.display = 'none';
            recentOrders.forEach(order => {
                const orderCard = createOrderCard(order);
                recentOrdersList.appendChild(orderCard);
            });
        }

        function updateAllOrders() {
            allOrdersList.innerHTML = '';
            let filteredOrders = orders;
            
            if (statusFilter !== 'all') {
                filteredOrders = orders.filter(order => {
                    return order.deliveryStatus === statusFilter;
                });
            }
            
            if (filteredOrders.length === 0) {
                allOrdersEmpty.style.display = 'block';
                return;
            }
            
            allOrdersEmpty.style.display = 'none';
            filteredOrders.forEach(order => {
                const orderCard = createOrderCard(order);
                allOrdersList.appendChild(orderCard);
            });
        }

        function createOrderCard(order) {
            const orderCard = document.createElement('div');
            orderCard.className = 'order-card';
            
            const status = order.deliveryStatus || 'preparing';
            const statusText = getDeliveryStatusText(status);
            const statusClass = getDeliveryStatusClass(status);
            const subtotal = order.subtotal || 0;
            const deliveryFee = order.deliveryFee || 0;
            const total = order.total || subtotal + deliveryFee;
            
            orderCard.innerHTML = `
                <div class="order-header">
                    <div class="order-id">#${order.id.substring(0, 8)}</div>
                    <div class="order-date">${formatDate(order.timestamp || order.createdAt)}</div>
                </div>
                <div class="order-customer">${order.customerName}</div>
                <div class="order-phone">${formatPhone(order.customerPhone)}</div>
                <div class="order-info">
                    <span class="order-status ${statusClass}">${statusText}</span>
                    <div class="order-total">R$ ${total.toFixed(2).replace('.', ',')}</div>
                </div>
                <div class="mb-1">
                    <small><strong>Taxa de entrega:</strong> R$ ${deliveryFee.toFixed(2).replace('.', ',')}</small>
                </div>
                <div class="order-actions">
                    <button class="action-btn view-btn" data-id="${order.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${status === 'preparing' ? `
                    <button class="action-btn confirm-btn" data-id="${order.id}" data-action="confirmed">
                        <i class="fas fa-check"></i>
                    </button>
                    ` : ''}
                    ${status === 'confirmed' ? `
                    <button class="action-btn confirm-btn" data-id="${order.id}" data-action="delivering">
                        <i class="fas fa-motorcycle"></i>
                    </button>
                    ` : ''}
                    ${status === 'delivering' ? `
                    <button class="action-btn confirm-btn" data-id="${order.id}" data-action="delivered">
                        <i class="fas fa-check-circle"></i>
                    </button>
                    ` : ''}
                    <button class="action-btn btn-whatsapp" data-id="${order.id}">
                        <i class="fab fa-whatsapp"></i>
                    </button>
                </div>
            `;
            
            orderCard.querySelector('.view-btn').addEventListener('click', (e) => {
                const orderId = e.currentTarget.getAttribute('data-id');
                viewOrderDetails(orderId);
            });
            
            const confirmBtn = orderCard.querySelector('.confirm-btn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', (e) => {
                    const orderId = e.currentTarget.getAttribute('data-id');
                    const action = e.currentTarget.getAttribute('data-action') || 'confirmed';
                    updateOrderStatus(orderId, action);
                });
            }
            
            orderCard.querySelector('.btn-whatsapp').addEventListener('click', (e) => {
                const orderId = e.currentTarget.getAttribute('data-id');
                openOrderWhatsApp(orderId);
            });
            
            return orderCard;
        }

        function updateProductsList() {
            productsList.innerHTML = '';
            
            if (products.length === 0) {
                productsEmpty.style.display = 'block';
                return;
            }
            
            productsEmpty.style.display = 'none';
            
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                
                const images = product.imagesBase64 || [];
                const hasMultipleImages = images.length > 0;
                const firstImage = hasMultipleImages ? images[0] : product.imageBase64;
                
                productCard.innerHTML = `
                    <div class="product-image">
                        ${firstImage ? 
                            `<img src="${firstImage}" alt="${product.name}" style="cursor:pointer;">` : 
                            `<i class="fas ${product.icon || 'fa-box'}"></i>`
                        }
                        ${hasMultipleImages && images.length > 1 ? 
                            `<span class="notification-badge" style="position:absolute;bottom:-5px;right:-5px;background-color:#2196f3;font-size:0.6rem;">+${images.length-1}</span>` : 
                            ''
                        }
                    </div>
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">R$ ${product.price.toFixed(2).replace('.', ',')}</div>
                    </div>
                    <div class="product-actions">
                        <button class="action-btn view-btn" data-id="${product.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn reject-btn" data-id="${product.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                productsList.appendChild(productCard);
            });
            
            productsList.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const productId = e.currentTarget.getAttribute('data-id');
                    editProduct(productId);
                });
            });
            
            productsList.querySelectorAll('.reject-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const productId = e.currentTarget.getAttribute('data-id');
                    deleteProduct(productId);
                });
            });
            
            productsList.querySelectorAll('.product-image img').forEach(img => {
                img.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const productId = e.target.closest('.product-card').querySelector('.view-btn').getAttribute('data-id');
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        const images = product.imagesBase64 || [];
                        if (images.length > 0) {
                            openImageZoom(images[0], product.name);
                        } else if (product.imageBase64) {
                            openImageZoom(product.imageBase64, product.name);
                        }
                    }
                });
            });
        }

        function viewOrderDetails(orderId) {
            selectedOrder = orders.find(order => order.id === orderId);
            if (!selectedOrder) return;
            
            const status = selectedOrder.deliveryStatus || 'preparing';
            const statusText = getDeliveryStatusText(status);
            const subtotal = selectedOrder.subtotal || 0;
            const deliveryFee = selectedOrder.deliveryFee || 0;
            const total = selectedOrder.total || subtotal + deliveryFee;
            
            let itemsHTML = '';
            if (selectedOrder.items && selectedOrder.items.length > 0) {
                selectedOrder.items.forEach(item => {
                    const itemTotal = (item.price || 0) * (item.quantity || 1);
                    itemsHTML += `<div class="d-flex justify-between mb-1">
                        <span>${item.quantity}x ${item.name}</span>
                        <span>R$ ${itemTotal.toFixed(2).replace('.', ',')}</span>
                    </div>`;
                });
            }
            
            let receiptHTML = '';
            if (selectedOrder.receiptBase64) {
                if (selectedOrder.receiptType === 'pdf') {
                    receiptHTML = `<div class="pdf-preview d-flex" onclick="downloadReceipt('${orderId}')">
                        <i class="fas fa-file-pdf upload-icon" style="font-size:3rem;color:#f44336;"></i>
                        <div class="upload-text">${selectedOrder.receiptFileName || 'comprovante.pdf'}</div>
                        <div class="upload-info">Clique para baixar o PDF</div>
                    </div>`;
                } else {
                    receiptHTML = `<img src="${selectedOrder.receiptBase64}" class="image-preview d-block" style="height:150px;cursor:pointer;" onclick="openImageZoom('${selectedOrder.receiptBase64}','Comprovante PIX')">`;
                }
            }
            
            const content = `
                <div class="mb-3">
                    <h3 class="mb-2">Informações do Cliente</h3>
                    <div class="d-flex justify-between mb-1">
                        <strong>Nome:</strong>
                        <span>${selectedOrder.customerName || 'Não informado'}</span>
                    </div>
                    <div class="d-flex justify-between mb-1">
                        <strong>Telefone:</strong>
                        <span>${formatPhone(selectedOrder.customerPhone) || 'Não informado'}</span>
                    </div>
                    <div class="mb-1">
                        <strong>Endereço:</strong>
                        <div>${selectedOrder.customerAddress || 'Não informado'}</div>
                    </div>
                    ${selectedOrder.notes ? `
                    <div class="mb-1">
                        <strong>Observações:</strong>
                        <div>${selectedOrder.notes}</div>
                    </div>
                    ` : ''}
                </div>
                <div class="mb-3">
                    <h3 class="mb-2">Detalhes do Pedido</h3>
                    <div class="d-flex justify-between mb-1">
                        <strong>ID:</strong>
                        <span>#${selectedOrder.id.substring(0, 8)}</span>
                    </div>
                    <div class="d-flex justify-between mb-1">
                        <strong>Data:</strong>
                        <span>${formatDateTime(selectedOrder.timestamp || selectedOrder.createdAt)}</span>
                    </div>
                    <div class="d-flex justify-between mb-1">
                        <strong>Pagamento:</strong>
                        <span>${selectedOrder.paymentMethod === 'money' ? 'Dinheiro' : 'PIX'}</span>
                    </div>
                    <div class="d-flex justify-between mb-1">
                        <strong>Subtotal:</strong>
                        <span>R$ ${subtotal.toFixed(2).replace('.', ',')}</span>
                    </div>
                    <div class="d-flex justify-between mb-1">
                        <strong>Taxa de Entrega:</strong>
                        <span>R$ ${deliveryFee.toFixed(2).replace('.', ',')}</span>
                    </div>
                    <div class="d-flex justify-between mb-1">
                        <strong>Total:</strong>
                        <span class="order-total">R$ ${total.toFixed(2).replace('.', ',')}</span>
                    </div>
                    <div class="d-flex justify-between mb-1">
                        <strong>Status:</strong>
                        <span class="order-status ${getDeliveryStatusClass(status)}">${statusText}</span>
                    </div>
                </div>
                <div class="mb-3">
                    <h3 class="mb-2">Itens do Pedido</h3>
                    ${itemsHTML || '<p>Nenhum item</p>'}
                </div>
                ${selectedOrder.receiptBase64 ? `
                <div class="mb-3">
                    <h3 class="mb-2">Comprovante PIX</h3>
                    ${receiptHTML}
                </div>
                ` : ''}
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-primary flex-1" id="updateStatusBtn" data-id="${selectedOrder.id}">Atualizar Status</button>
                    <button class="btn btn-secondary flex-1" id="closeDetailsBtn">Fechar</button>
                </div>
            `;
            
            document.getElementById('orderDetailsContent').innerHTML = content;
            
            document.getElementById('updateStatusBtn').addEventListener('click', () => {
                showStatusUpdateOptions(selectedOrder.id, status);
            });
            
            document.getElementById('closeDetailsBtn').addEventListener('click', () => {
                orderDetailsModal.style.display = 'none';
            });
            
            window.downloadReceipt = function(orderId) {
                const order = orders.find(o => o.id === orderId);
                if (order && order.receiptBase64) {
                    const link = document.createElement('a');
                    link.href = order.receiptBase64;
                    link.download = order.receiptFileName || 'comprovante.pdf';
                    link.click();
                }
            };
            
            orderDetailsModal.style.display = 'block';
        }

        function showStatusUpdateOptions(orderId, currentStatus) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            let optionsHTML = '<h3 class="mb-2">Atualizar Status:</h3>';
            const statusOptions = ['preparing', 'confirmed', 'delivering', 'delivered'];
            
            statusOptions.forEach(status => {
                if (status !== currentStatus) {
                    const statusText = getDeliveryStatusText(status);
                    optionsHTML += `<button class="btn btn-primary btn-block mb-1" data-action="${status}">${statusText}</button>`;
                }
            });
            
            optionsHTML += `<button class="btn btn-secondary btn-block mt-2" id="backToDetailsBtn">Voltar</button>`;
            
            document.getElementById('orderDetailsContent').innerHTML = optionsHTML;
            
            document.querySelectorAll('[data-action]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = e.currentTarget.getAttribute('data-action');
                    updateOrderStatus(orderId, action);
                    orderDetailsModal.style.display = 'none';
                });
            });
            
            document.getElementById('backToDetailsBtn').addEventListener('click', () => {
                viewOrderDetails(orderId);
            });
        }

        async function updateOrderStatus(orderId, status) {
            try {
                await db.collection('orders').doc(orderId).update({
                    deliveryStatus: status,
                    status: status === 'delivered' ? 'completed' : status === 'confirmed' ? 'confirmed' : 'pending_confirmation',
                    updatedAt: new Date().toISOString()
                });
                
                showNotification(`Status atualizado para: ${getDeliveryStatusText(status)}`, 'success');
                
                const order = orders.find(o => o.id === orderId);
                if (order) {
                    sendStatusUpdateWhatsApp(orderId, order, status);
                }
            } catch (error) {
                console.error('Error updating order:', error);
                showNotification('Erro ao atualizar status.', 'error');
            }
        }

        function openOrderWhatsApp(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const phoneNumber = storeConfig.whatsappNumber || "(11) 99999-9999";
            const message = generateOrderMessage(order);
            const whatsappUrl = `https://wa.me/${order.customerPhone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function sendStatusUpdateWhatsApp(orderId, order, newStatus) {
            const phoneNumber = storeConfig.whatsappNumber || "(11) 99999-9999";
            let message = `📱 *ATUALIZAÇÃO DE STATUS* 📱\n\n*Pedido:* #${orderId.substring(0, 8)}\n*Cliente:* ${order.customerName}\n*Novo Status:* ${getDeliveryStatusText(newStatus)}\n\n`;
            
            if (newStatus === 'delivering') {
                message += `Seu pedido saiu para entrega! 🛵\nEm breve estará aí.\n\n`;
            } else if (newStatus === 'delivered') {
                message += `Seu pedido foi entregue! ✅\nAgradecemos pela preferência!\n\n`;
            } else if (newStatus === 'confirmed') {
                message += `Seu pedido foi confirmado! ✅\nEstamos preparando sua entrega.\n\n`;
            } else if (newStatus === 'preparing') {
                message += `Seu pedido está sendo preparado! 👨‍🍳\nEm breve atualizaremos o status.\n\n`;
            }
            
            message += `_Qualquer dúvida, entre em contato._`;
            
            const whatsappUrl = `https://wa.me/${order.customerPhone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function generateOrderMessage(order) {
            const status = order.deliveryStatus || 'preparing';
            const subtotal = order.subtotal || 0;
            const deliveryFee = order.deliveryFee || 0;
            const total = order.total || subtotal + deliveryFee;
            
            let message = `📱 *DETALHES DO PEDIDO* 📱\n\n*Pedido:* #${order.id.substring(0, 8)}\n*Status:* ${getDeliveryStatusText(status)}\n*Cliente:* ${order.customerName}\n*Endereço:* ${order.customerAddress}\n*Telefone:* ${order.customerPhone}\n\n`;
            
            message += `*ITENS DO PEDIDO:*\n`;
            if (order.items && order.items.length > 0) {
                order.items.forEach(item => {
                    const itemTotal = (item.price || 0) * (item.quantity || 1);
                    message += `• ${item.quantity}x ${item.name} - R$ ${itemTotal.toFixed(2).replace('.', ',')}\n`;
                });
            }
            
            message += `\n*Subtotal:* R$ ${subtotal.toFixed(2).replace('.', ',')}\n*Taxa de Entrega:* R$ ${deliveryFee.toFixed(2).replace('.', ',')}\n*TOTAL: R$ ${total.toFixed(2).replace('.', ',')}*\n*Pagamento:* ${order.paymentMethod === 'money' ? 'Dinheiro' : 'PIX'}\n\n`;
            
            if (order.notes) {
                message += `*Observações:* ${order.notes}\n\n`;
            }
            
            message += `Obrigado pela preferência! 🛒✨`;
            return message;
        }

        function openProductForm() {
            productModalTitle.textContent = 'Novo Produto';
            productForm.reset();
            productIdInput.value = '';
            productImagesPreview.innerHTML = '';
            productImagesBase64 = [];
            updateImageCounter();
            productActive.checked = true;
            updateProductCategorySelect();
            loadCategories();
            
            // Mostrar área de upload
            productImageUploadArea.classList.remove('hidden');
            
            productFormModal.style.display = 'block';
        }

        function editProduct(productId) {
            selectedProduct = products.find(p => p.id === productId);
            if (!selectedProduct) return;
            
            productModalTitle.textContent = 'Editar Produto';
            productIdInput.value = selectedProduct.id;
            productName.value = selectedProduct.name;
            productDescription.value = selectedProduct.description;
            productPrice.value = selectedProduct.price;
            productCategory.value = selectedProduct.category || '';
            productActive.checked = selectedProduct.active !== false;
            
            if (selectedProduct.imagesBase64 && selectedProduct.imagesBase64.length > 0) {
                productImagesBase64 = [...selectedProduct.imagesBase64];
            } else if (selectedProduct.imageBase64) {
                productImagesBase64 = [selectedProduct.imageBase64];
            } else {
                productImagesBase64 = [];
            }
            
            updateProductImagesPreview();
            updateImageCounter();
            updateProductCategorySelect();
            loadCategories();
            
            // Mostrar/ocultar área de upload conforme número de imagens
            if (productImagesBase64.length >= 3) {
                productImageUploadArea.classList.add('hidden');
            } else {
                productImageUploadArea.classList.remove('hidden');
            }
            
            productFormModal.style.display = 'block';
        }

        function closeProductForm() {
            productFormModal.style.display = 'none';
            selectedProduct = null;
            productImagesBase64 = [];
        }

        async function saveProduct(e) {
            e.preventDefault();
            
            const productData = {
                name: productName.value,
                description: productDescription.value,
                price: parseFloat(productPrice.value),
                category: productCategory.value,
                active: productActive.checked,
                updatedAt: new Date().toISOString(),
                storeId: currentStoreId
            };
            
            // Salvar imagens múltiplas
            if (productImagesBase64.length > 0) {
                productData.imagesBase64 = productImagesBase64;
                productData.imageBase64 = productImagesBase64[0];
            }
            
            try {
                if (productIdInput.value) {
                    await db.collection('stores').doc(currentStoreId).collection('products').doc(productIdInput.value).update(productData);
                    showNotification('Produto atualizado!', 'success');
                } else {
                    productData.createdAt = new Date().toISOString();
                    await db.collection('stores').doc(currentStoreId).collection('products').add(productData);
                    showNotification('Produto adicionado!', 'success');
                }
                
                closeProductForm();
                loadProducts();
            } catch (error) {
                console.error('Error saving product:', error);
                showNotification('Erro ao salvar produto.', 'error');
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('Excluir este produto?')) return;
            
            try {
                await db.collection('stores').doc(currentStoreId).collection('products').doc(productId).delete();
                showNotification('Produto excluído!', 'success');
                loadProducts();
            } catch (error) {
                console.error('Error deleting product:', error);
                showNotification('Erro ao excluir produto.', 'error');
            }
        }

        async function saveStoreConfig(e) {
            e.preventDefault();
            
            const whatsappNumber = configWhatsApp.value;
            const deliveryFee = parseFloat(configDeliveryFee.value) || 0;
            
            const configData = {
                businessName: configBusinessName.value,
                whatsappNumber: whatsappNumber,
                pixKey: configPixKey.value,
                productsTitle: configProductsTitle.value,
                deliveryFee: deliveryFee,
                theme: configTheme.value,
                updatedAt: new Date().toISOString()
            };
            
            if (logoBase64) {
                configData.logoBase64 = logoBase64;
            }
            
            try {
                await db.collection('stores').doc(currentStoreId).set(configData, { merge: true });
                storeConfig = configData;
                
                await db.collection('users').doc(currentStoreId).update({
                    storeName: configBusinessName.value,
                    configCompleted: true
                });
                
                currentUser.storeName = configBusinessName.value;
                userConfigCompleted = true;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                updateUserAvatar();
                updateStoreAvatar();
                storeNameDisplay.textContent = configBusinessName.value;
                adminStoreName.textContent = `Venda+`;
                deliveryFeeStat.textContent = `R$ ${deliveryFee.toFixed(2)}`;
                
                showNotification('Configurações salvas!', 'success');
            } catch (error) {
                console.error('Error saving store config:', error);
                showNotification('Erro ao salvar configurações.', 'error');
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'Data não informada';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        function formatTime(dateString) {
            if (!dateString) return 'Hora não informada';
            const date = new Date(dateString);
            return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'Data/hora não informada';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        function formatPhone(phone) {
            if (!phone) return '';
            const cleaned = phone.replace(/\D/g, '');
            if (cleaned.length === 11) {
                return `(${cleaned.substring(0, 2)}) ${cleaned.substring(2, 7)}-${cleaned.substring(7)}`;
            }
            return phone;
        }

        function getDeliveryStatusText(status) {
            switch (status) {
                case 'preparing': return 'Preparando';
                case 'confirmed': return 'Confirmado';
                case 'delivering': return 'Saiu para entrega';
                case 'delivered': return 'Entregue';
                case 'rejected': return 'Rejeitado';
                default: return 'Preparando';
            }
        }

        function getDeliveryStatusClass(status) {
            switch (status) {
                case 'preparing': return 'status-preparing';
                case 'confirmed': return 'status-confirmed';
                case 'delivering': return 'status-delivering';
                case 'delivered': return 'status-delivered';
                case 'rejected': return 'status-rejected';
                default: return 'status-preparing';
            }
        }

        function showNotification(message, type = 'info') {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => {
                notification.remove();
            });
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', init);
        
        // Tornar a função openImageZoom disponível globalmente
        window.openImageZoom = openImageZoom;
    </script>
</body>
</html>