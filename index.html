<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecionando...</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        /* Tela de carregamento mínima e discreta */
        body {
            margin: 0;
            padding: 0;
            background: #212121;
            color: white;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
        }
        
        .loader {
            text-align: center;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loader">
        <div class="spinner"></div>
        <p>Verificando acesso...</p>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB7U-JfKAlkPxSyL4AEf5u0BgcDzSXf41M",
            authDomain: "appvendas-1eebf.firebaseapp.com",
            projectId: "appvendas-1eebf",
            storageBucket: "appvendas-1eebf.firebasestorage.app",
            messagingSenderId: "229472373918",
            appId: "1:229472373918:web:39cd4940b052b2375f3f8f"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Função principal de redirecionamento
        async function checkAndRedirect() {
            try {
                // Verifica autenticação
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        // Usuário logado - verificar status
                        try {
                            const userDoc = await db.collection('users').doc(user.uid).get();
                            
                            if (!userDoc.exists) {
                                // Usuário não encontrado - redireciona para login
                                window.location.href = 'login.html';
                                return;
                            }
                            
                            const userData = userDoc.data();
                            
                            // Verificar status da conta
                            if (userData.status === 'blocked' || 
                                userData.status === 'expired' || 
                                userData.status === 'pending' ||
                                userData.isActive === false) {
                                // Conta não ativa - redireciona para login
                                window.location.href = 'login.html';
                                return;
                            }
                            
                            // Conta ativa - verificar data de expiração
                            if (userData.expiryDate) {
                                const expiryDate = new Date(userData.expiryDate);
                                const today = new Date();
                                today.setHours(0, 0, 0, 0);
                                
                                if (expiryDate < today) {
                                    // Conta expirada - atualizar status e redirecionar
                                    await db.collection('users').doc(user.uid).update({
                                        status: 'expired',
                                        isActive: false
                                    });
                                    window.location.href = 'login.html';
                                    return;
                                }
                            }
                            
                            // Salvar dados no localStorage e redirecionar para admin
                            localStorage.setItem('currentUser', JSON.stringify({
                                uid: user.uid,
                                email: user.email,
                                storeName: userData.storeName,
                                phone: userData.phone,
                                isAdmin: true,
                                expiryDate: userData.expiryDate
                            }));
                            
                            // Atualizar último login
                            await db.collection('users').doc(user.uid).update({
                                lastLogin: new Date().toISOString()
                            });
                            
                            // Redirecionar para painel admin
                            window.location.href = 'admin.html';
                            
                        } catch (error) {
                            console.error('Erro ao verificar dados:', error);
                            window.location.href = 'login.html';
                        }
                    } else {
                        // Usuário não logado - redireciona para login
                        window.location.href = 'login.html';
                    }
                });
                
            } catch (error) {
                console.error('Erro geral:', error);
                // Em caso de erro, redireciona para login
                window.location.href = 'login.html';
            }
        }

        // Verificar parâmetros de loja na URL (para vitrine)
        function checkStoreParameter() {
            const urlParams = new URLSearchParams(window.location.search);
            const storeId = urlParams.get('store');
            
            if (storeId) {
                // Se tem parâmetro de loja, redireciona direto para vitrine
                window.location.href = `vitrine.html?store=${storeId}`;
                return true;
            }
            return false;
        }

        // Iniciar verificação
        document.addEventListener('DOMContentLoaded', () => {
            // Primeiro verifica se é acesso à vitrine
            const isStoreAccess = checkStoreParameter();
            
            // Se não for acesso à vitrine, verifica autenticação
            if (!isStoreAccess) {
                checkAndRedirect();
            }
        });

        // Timeout de segurança (10 segundos)
        setTimeout(() => {
            // Se ainda estiver nesta página após 10 segundos, redireciona para login
            if (window.location.pathname.includes('index.html') || 
                window.location.pathname === '/' || 
                window.location.pathname === '') {
                window.location.href = 'login.html';
            }
        }, 10000);
    </script>
</body>
</html>